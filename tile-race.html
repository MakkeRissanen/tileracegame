<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rawbellion Tile Race</title>

    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 (CDN) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel (JSX in browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      
      /* Dark scrollbar for event log in dark theme */
      .dark-scrollbar::-webkit-scrollbar {
        width: 12px;
      }
      .dark-scrollbar::-webkit-scrollbar-track {
        background: #0f172a;
      }
      .dark-scrollbar::-webkit-scrollbar-thumb {
        background: #1e293b;
        border-radius: 6px;
      }
      .dark-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #334155;
      }
    </style>
  </head>

  <body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useState, useRef } = React;

      // ========= Firebase Configuration =========
      const firebaseConfig = {
        apiKey: "AIzaSyCLPkdknlNENz0KdDvfDT4QmjvZ9JrVzDo",
        authDomain: "rawbellion-tile-race.firebaseapp.com",
        databaseURL: "https://rawbellion-tile-race-default-rtdb.firebaseio.com",
        projectId: "rawbellion-tile-race",
        storageBucket: "rawbellion-tile-race.firebasestorage.app",
        messagingSenderId: "689950509056",
        appId: "1:689950509056:web:6d2e0730f9a475867df0e5",
        measurementId: "G-M7ZQYTQFM8"
      };

      // Initialize Firebase
      let firebaseApp = null;
      let database = null;
      let isFirebaseEnabled = false;

      try {
        // Check if config has been updated
        if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
          firebaseApp = firebase.initializeApp(firebaseConfig);
          database = firebase.database();
          isFirebaseEnabled = true;
          console.log("✅ Firebase initialized successfully");
        } else {
          console.warn("⚠️ Firebase not configured. Using localStorage. Update firebaseConfig to enable real-time sync.");
        }
      } catch (error) {
        console.error("❌ Firebase initialization failed:", error);
        console.warn("Falling back to localStorage mode");
      }

      const MAX_TILE = 56;

      const POWERUP_DEFS = [
        { id: "skip1", name: "Skip 1 tile", kind: "self" },
        { id: "skip2", name: "Skip 2 tiles", kind: "self" },
        { id: "skip3", name: "Skip 3 tiles", kind: "self" },
        { id: "back1", name: "Make other team go backward 1 tile", kind: "target" },
        { id: "back2", name: "Make other team go backward 2 tiles", kind: "target" },
        { id: "back3", name: "Make other team go backward 3 tiles", kind: "target" },
        { id: "copypaste", name: "Ctrl + C, Ctrl + V", kind: "future" },
        { id: "changeTile", name: "Change tile (same difficulty pool)", kind: "change" },
        { id: "clearCooldown", name: "Clear powerup cooldown", kind: "self" },
        { id: "disablePowerup", name: "Disable a stored powerup from target team", kind: "targetPowerup" },
        { id: "doublePowerup", name: "Double a stored powerup", kind: "selfPowerup" },
        { id: "doubleEasy", name: "Double requirement on an easy tile", kind: "doubleTile" },
        { id: "doubleMedium", name: "Double requirement on a medium tile", kind: "doubleTile" },
        { id: "doubleHard", name: "Double requirement on a hard tile", kind: "doubleTile" },
      ];

      // ========= Utilities =========
      function uid() {
        return Math.random().toString(16).slice(2) + Date.now().toString(16);
      }
      function clamp(n, min, max) {
        return Math.max(min, Math.min(max, n));
      }
      function colorForIndex(i) {
        const palette = [
          "bg-red-500",
          "bg-blue-500",
          "bg-emerald-500",
          "bg-amber-500",
          "bg-purple-500",
          "bg-pink-500",
          "bg-cyan-500",
          "bg-lime-500",
          "bg-orange-500",
          "bg-indigo-500",
        ];
        return palette[i % palette.length];
      }
      function powerupLabel(id) {
        return POWERUP_DEFS.find((p) => p.id === id)?.name ?? id;
      }

      // More obvious difficulty colors
      function diffTint(d, isDark) {
        const diff = Number(d) || 1;
        if (isDark) {
          if (diff === 1) return "bg-emerald-900/40 border-emerald-600 text-slate-100";
          if (diff === 2) return "bg-amber-900/40 border-amber-600 text-slate-100";
          return "bg-purple-900/40 border-purple-600 text-slate-100";
        } else {
          if (diff === 1) return "bg-emerald-200/80 border-emerald-500 text-slate-900";
          if (diff === 2) return "bg-amber-200/90 border-amber-500 text-slate-900";
          return "bg-purple-200/80 border-purple-500 text-slate-900";
        }
      }
      function diffBadge(d) {
        const diff = Number(d) || 1;
        if (diff === 1) return { txt: "E", cls: "bg-emerald-700 text-white" };
        if (diff === 2) return { txt: "M", cls: "bg-amber-700 text-white" };
        return { txt: "H", cls: "bg-purple-700 text-white" };
      }

      function defaultRaceTiles() {
        return Array.from({ length: MAX_TILE }, (_, i) => {
          const n = i + 1;
          const label = n === MAX_TILE ? "Final tile" : `Task ${n}`;
          const difficulty = n === MAX_TILE ? 3 : 1;
          return { n, label, difficulty, rewardPowerupId: null, instructions: "", image: "", maxCompletions: 1, minCompletions: 1 };
        });
      }

      function imagePlaceholder(label = "No image", w = 64, h = 64) {
        const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}'><rect fill='%23e2e8f0' width='100%' height='100%'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%23838fa3' font-size='10'>${label}</text></svg>`;
        return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
      }

      function imageOnError(e) {
        if (e.currentTarget.dataset.errored) return;
        e.currentTarget.dataset.errored = "1";
        e.currentTarget.src = imagePlaceholder();
      }

      function initialGame() {
        return {
          version: 3,
          raceTiles: defaultRaceTiles(),
          powerupTiles: [], // {id,label,rewardPowerupId,instructions}
          taskPools: { 1: [], 2: [], 3: [] }, // {id,label} per difficulty
          usedPoolTaskIds: [],
          changedTiles: [],
          doubledTiles: [],
          doubledTilesInfo: {}, // {tileNum: {useDifficultyPoints: boolean}}
          revealedTiles: [1, 2, 3, 4, 5, 6, 7, 8], // Array of tile numbers that have been revealed - start with first 8 tiles
          playerPoints: {}, // {playerName: points}
          teams: [], // teams also store members[], captain, password (optional)
          admins: [{ id: "master", name: "Master Admin", password: "admin123", isMaster: true }],
          log: [],
        };
      }

      // ========= Pure helpers (game-only) =========
      function addLog(game, message, adminName = null) {
        const finalMessage = adminName ? `[${adminName}] ${message}` : message;
        const entry = { id: uid(), ts: Date.now(), message: finalMessage };
        const log = [entry, ...(game.log || [])].slice(0, 200);
        return { ...game, log };
      }

      function getRaceTile(game, n) {
        return (
          game.raceTiles.find((t) => t.n === n) || {
            n,
            label: `Task ${n}`,
            difficulty: 1,
            rewardPowerupId: null,
            instructions: "",
            image: "",
            maxCompletions: 1,
          }
        );
      }
      function tileLabel(game, n) {
        return getRaceTile(game, n).label || `Task ${n}`;
      }
      function tileDiff(game, n) {
        return clamp(Number(getRaceTile(game, n).difficulty || 1), 1, 3);
      }
      function tileReward(game, n) {
        return getRaceTile(game, n).rewardPowerupId || null;
      }
      function tileInstructions(game, n) {
        return getRaceTile(game, n).instructions || "";
      }
      function tileDesc(game, n) {
        return `Tile ${n}: "${tileLabel(game, n)}"`;
      }

      // ========= Style Helper Functions (DRY) =========
      function btnClass(variant, isDark, extraClasses = '') {
        const base = 'rounded-xl border px-3 py-2 text-sm font-semibold';
        const variants = {
          primary: isDark ? 'bg-slate-900 text-white hover:bg-slate-800' : 'bg-slate-800 text-white hover:bg-slate-700',
          secondary: isDark ? 'border-slate-700 bg-slate-800 text-slate-100 hover:bg-slate-700' : 'border-slate-300 bg-white text-slate-900 hover:bg-slate-100',
          danger: isDark ? 'border-red-900 bg-red-900/20 text-red-400 hover:bg-red-900/30' : 'border-red-300 bg-red-50 text-red-700 hover:bg-red-100',
          ghost: isDark ? 'border-slate-600 bg-slate-700 hover:bg-slate-600 text-white' : 'bg-slate-200 hover:bg-slate-300 text-slate-900'
        };
        return `${base} ${variants[variant] || variants.secondary} ${extraClasses}`;
      }

      function inputClass(isDark, extraClasses = '') {
        const base = 'w-full rounded-xl border px-3 py-2 text-sm';
        const style = isDark 
          ? 'border-slate-600 bg-slate-700 text-slate-100 placeholder-slate-400' 
          : 'border-slate-300 bg-white text-slate-900 placeholder-slate-400';
        return `${base} ${style} ${extraClasses}`;
      }

      function selectClass(isDark, extraClasses = '') {
        const base = 'w-full rounded-xl border px-3 py-2 text-sm';
        const style = isDark 
          ? 'border-slate-700 bg-slate-700 text-slate-100' 
          : 'border-slate-300 bg-white text-slate-900';
        return `${base} ${style} ${extraClasses}`;
      }

      function textareaClass(isDark, extraClasses = '') {
        const base = 'w-full rounded-xl border px-3 py-2 text-sm';
        const style = isDark 
          ? 'border-slate-600 bg-slate-700 text-slate-100 placeholder-slate-400' 
          : 'border-slate-300 bg-white text-slate-900 placeholder-slate-400';
        return `${base} ${style} ${extraClasses}`;
      }

      function cardClass(isDark, extraClasses = '') {
        const base = 'rounded-2xl border p-4 shadow-sm';
        const style = isDark ? 'border-slate-700 bg-slate-800' : 'border-slate-200 bg-white';
        return `${base} ${style} ${extraClasses}`;
      }

      function textMuted(isDark) {
        return isDark ? 'text-slate-400' : 'text-slate-600';
      }

      function textNormal(isDark) {
        return isDark ? 'text-slate-300' : 'text-slate-600';
      }

      // Modal wrapper component to reduce repetition
      function Modal({ isOpen, onClose, title, children, isDark, maxWidth = 'max-w-3xl', zIndex = 'z-50' }) {
        if (!isOpen) return null;
        return (
          <div className={`fixed inset-0 ${zIndex} flex items-center justify-center bg-black/30 p-4`}>
            <div className={`w-full ${maxWidth} max-h-[90vh] overflow-y-auto rounded-2xl p-4 shadow-xl ${isDark ? 'bg-slate-800 dark-scrollbar' : 'bg-white'}`}>
              <div className="flex items-start justify-between gap-3">
                <div className="flex-1">
                  {title && <div className="text-lg font-semibold">{title}</div>}
                </div>
                <button onClick={onClose} className={btnClass("secondary", isDark, "hover:opacity-80")}>
                  Close
                </button>
              </div>
              <div className="mt-4">
                {children}
              </div>
            </div>
          </div>
        );
      }

      function simulateAdvance(team, steps) {
        let pos = team.pos;
        for (let i = 0; i < steps; i++) {
          if (pos >= MAX_TILE) break;
          pos += 1;
          while (pos < MAX_TILE && (team.preCleared || []).includes(pos + 1)) pos += 1;
        }
        return pos;
      }

      function maybeGrantMainTileReward(game, teamId, completedTileN) {
        const reward = tileReward(game, completedTileN);
        if (!reward) return { game, granted: null };

        const team = game.teams.find((t) => t.id === teamId);
        if (!team) return { game, granted: null };

        if ((team.claimedRaceTileRewards || []).includes(completedTileN)) return { game, granted: null };

        const teams = game.teams.map((t) => {
          if (t.id !== teamId) return t;
          return {
            ...t,
            inventory: [...(t.inventory || []), reward],
            claimedRaceTileRewards: [...(t.claimedRaceTileRewards || []), completedTileN],
          };
        });

        return { game: { ...game, teams }, granted: reward };
      }

      // ========= Core: applyEvent(game, event) =========
      function applyEvent(game, event) {
        try {
          switch (event.type) {
            case "RESET_ALL": {
              return addLog(initialGame(), "Game reset.");
            }

            case "ADD_TEAM": {
              // Only admins can create teams
              if (!event.adminName) return game;
              const name = (event.name || "").trim();
              if (!name) return game;

              const idx = game.teams.length;
              const team = {
                id: uid(),
                name,
                color: colorForIndex(idx),
                pos: 1,
                createdAt: Date.now(),
                inventory: [],
                preCleared: [],
                copyChoice: [],
                claimedRaceTileRewards: [],
                claimedPowerupTiles: [],
                members: [],
                captain: "",
                playerPoints: {},
                powerupCooldown: false,
                password: null, // Admin must set password before team can login
              };

              let next = { ...game, teams: [...game.teams, team] };
              next = addLog(next, `Admin created team "${name}". Password must be set by admin before team can be used.`);
              return next;
            }

            case "REMOVE_TEAM": {
              const team = game.teams.find((t) => t.id === event.teamId);
              const teams = game.teams.filter((t) => t.id !== event.teamId);
              let next = { ...game, teams };
              next = addLog(next, `Team removed: ${team?.name ?? "(unknown)"}`);
              return next;
            }

            // Normal UI action
            case "COMPLETE_TILE": {
              const team = game.teams.find((t) => t.id === event.teamId);
              if (!team) return game;

              const completedTile = team.pos;
              const playerNames = event.playerNames || [event.playerName || "(unknown)"];
              const completedLabel = tileLabel(game, completedTile);
              
              // Validate minimum completions requirement
              // Note: minCompletions is already doubled in the tile if it was doubled, so no need to multiply again
              const rt = getRaceTile(game, completedTile);
              const minRequired = rt.minCompletions || 1;
              
              if (playerNames.length < minRequired) {
                alert(`This tile requires at least ${minRequired} player selection${minRequired > 1 ? 's' : ''} to complete.`);
                return game;
              }

              const nextPos = simulateAdvance(team, 1);
              const teams = game.teams.map((t) => (t.id === event.teamId ? { ...t, pos: nextPos, powerupCooldown: false } : t));
              let next = { ...game, teams };

              // Update revealed tiles: reveal next chunk of 8 tiles when completing milestones (8, 16, 24, etc.)
              const revealedTiles = new Set(game.revealedTiles || []);
              const CHUNK_SIZE = 8;
              
              // Special case: reveal final tile only when completing second to last tile
              if (completedTile === MAX_TILE - 1) {
                revealedTiles.add(MAX_TILE);
              }
              
              // Check if we crossed any 8-tile milestones (handles skipping)
              const oldChunk = Math.floor((completedTile - 1) / CHUNK_SIZE);
              const newChunk = Math.floor((nextPos - 1) / CHUNK_SIZE);
              
              // Reveal all chunks between old and new position
              for (let chunk = oldChunk + 1; chunk <= newChunk; chunk++) {
                const chunkStart = chunk * CHUNK_SIZE + 1;
                const chunkEnd = Math.min((chunk + 1) * CHUNK_SIZE, MAX_TILE - 1); // Stop before final tile
                for (let i = chunkStart; i <= chunkEnd; i++) {
                  revealedTiles.add(i);
                }
              }
              
              next = { ...next, revealedTiles: Array.from(revealedTiles) };

              const rewardRes = maybeGrantMainTileReward(next, event.teamId, completedTile);
              next = rewardRes.game;

              // scoring: if tile allows multiple completions, points per completion = 1; otherwise use difficulty-based points
              // Exception: if tile was doubled from maxCompletions=1, use difficulty-based points
              const diff = tileDiff(game, completedTile);
              const rtScoring = getRaceTile(next, completedTile);
              const doubledTilesInfoScoring = next.doubledTilesInfo || {};
              const isDoubledWithDiffPoints = doubledTilesInfoScoring[completedTile]?.useDifficultyPoints || false;
              const isMultiCompletion = Math.max(1, Number(rtScoring.maxCompletions || 1)) > 1;
              const pointsForDiff = (isMultiCompletion && !isDoubledWithDiffPoints) ? 1 : (diff === 1 ? 1 : diff === 2 ? 2 : 3);
              
              // Award points to players (globally)
              const playerPoints = { ...(next.playerPoints || {}) };
              playerNames.forEach((playerName) => {
                playerPoints[playerName] = (playerPoints[playerName] || 0) + pointsForDiff;
              });
              next = { ...next, playerPoints };

              const playersText = playerNames.join(", ");
              const totalPoints = pointsForDiff * playerNames.length;
              const isDoubledTile = doubledTilesInfoScoring[completedTile] ? true : false;
              const doubledText = isDoubledTile ? "doubled " : "";

              // Check if this is the final tile (winning condition)
              if (completedTile === MAX_TILE) {
                next = addLog(next, `🏆🎉 ${team.name} completed the ${doubledText}Final Tile! ${playersText} are the WINNERS! 🏆🎉 (+${pointsForDiff} pts each, ${totalPoints} total)${
                  rewardRes.granted ? ` 🎁 Reward gained: ${powerupLabel(rewardRes.granted)}` : ""
                }`);
                // Show winner popup
                setTimeout(() => {
                  alert(`🏆🎉 GAME OVER! 🏆🎉\n\n${team.name} completed the Final Tile!\n\n${playersText} are the WINNERS!`);
                }, 100);
              } else if (nextPos === completedTile) {
                next = addLog(next, `${team.name}, ${playersText} completed ${tileDesc(next, completedTile)} (already at finish) +${totalPoints}pts total → Current: ${tileDesc(next, nextPos)}`);
              } else {
                next = addLog(
                  next,
                  `${team.name}, ${playersText} completed ${doubledText}Tile ${completedTile}: "${completedLabel}" (+${pointsForDiff} pts each, ${totalPoints} total) → Current: ${tileDesc(next, nextPos)}${
                    rewardRes.granted ? ` 🎁 Reward gained: ${powerupLabel(rewardRes.granted)}` : ""
                  }`
                );
              }
              return next;
            }

            // Copy-choice button counts as completion of current tile
            case "USE_COPY_CHOICE": {
              const team = game.teams.find((t) => t.id === event.teamId);
              if (!team) return game;

              const here = team.pos;
              const stamp = (team.copyChoice || []).find((x) => x.tile === here);
              if (!stamp) return game;

              const dest = clamp(here + 1, 1, MAX_TILE);

              let teams = game.teams.map((t) => {
                if (t.id !== event.teamId) return t;
                return { ...t, pos: dest, copyChoice: (t.copyChoice || []).filter((x) => x.tile !== here), powerupCooldown: false };
              });

              let next = { ...game, teams };
              const rewardRes = maybeGrantMainTileReward(next, event.teamId, here);
              next = rewardRes.game;

              const fromPart = stamp.fromTile ? ` (stamp created from ${tileDesc(next, stamp.fromTile)})` : "";
              next = addLog(
                next,
                `${team.name} used copy-choice at ${tileDesc(next, here)}${fromPart} → Current: ${tileDesc(next, dest)}${
                  rewardRes.granted ? ` 🎁 Reward gained: ${powerupLabel(rewardRes.granted)}` : ""
                }`
              );
              return next;
            }

            case "CLAIM_POWERUP_TILE": {
              const team = game.teams.find((t) => t.id === event.teamId);
              const tile = game.powerupTiles.find((pt) => pt.id === Number(event.powerTileId));
              if (!team || !tile || !tile.rewardPowerupId) return game;

              const playerNames = event.playerNames || [];
              const minRequired = tile.minCompletions || 1;
              
              if (playerNames.length < minRequired) {
                alert(`This powerup requires at least ${minRequired} player selection${minRequired > 1 ? 's' : ''} to complete.`);
                return game;
              }

              const claimType = tile.claimType || "eachTeam";

              // Check claim restrictions based on claimType
              if (claimType === "eachTeam") {
                // Each team can claim once
                const alreadyClaimed = (team.claimedPowerupTiles || []).includes(tile.id);
                if (alreadyClaimed) {
                  alert("Your team has already claimed this powerup.");
                  return game;
                }
              } else if (claimType === "firstTeam") {
                // Only one team can claim (first come first serve)
                // Ensure consistent type comparison (both tile.id and stored IDs should be numbers)
                const tileId = Number(tile.id);
                const anyTeamClaimed = game.teams.some(t => (t.claimedPowerupTiles || []).includes(tileId));
                if (anyTeamClaimed) {
                  alert("This powerup has already been claimed by another team.");
                  return game;
                }
              }
              // claimType === "unlimited" has no restrictions

              // Award points to players
              const pointsPerCompletion = tile.pointsPerCompletion || 1;
              const playerPoints = { ...(game.playerPoints || {}) };
              playerNames.forEach((playerName) => {
                playerPoints[playerName] = (playerPoints[playerName] || 0) + pointsPerCompletion;
              });

              const teams = game.teams.map((t) => {
                if (t.id !== team.id) return t;
                // Ensure tile.id is stored as a number for consistent comparison
                const tileId = Number(tile.id);
                return {
                  ...t,
                  inventory: [...(t.inventory || []), tile.rewardPowerupId],
                  claimedPowerupTiles: [...(t.claimedPowerupTiles || []), tileId],
                };
              });

              let next = { ...game, teams, playerPoints };
              const playerList = playerNames.join(", ");
              next = addLog(next, `${team.name} completed "${tile.label}" (${playerList}: +${pointsPerCompletion}pts each) ? gained ${powerupLabel(tile.rewardPowerupId)}.`);
              return next;
            }

            case "USE_POWERUP": {
              const { teamId, powerupId, targetId, futureTile, changeTaskId } = event;
              const team = game.teams.find((t) => t.id === teamId);
              if (!team) return game;
              if (!(team.inventory || []).includes(powerupId)) {
                return addLog(game, `${team.name} does not have that powerup stored.`);
              }

              // Check if team is on powerup cooldown (exception: clearCooldown can be used while on cooldown)
              if (team.powerupCooldown && powerupId !== "clearCooldown") {
                alert(`${team.name} cannot use a powerup right now. You must complete at least one tile after using or being affected by a powerup.`);
                return addLog(game, `${team.name} tried to use ${powerupLabel(powerupId)} but is on powerup cooldown.`);
              }

              // Helper function to consume one powerup from team inventory and set cooldown
              const consumePowerup = (gameState) => {
                const teamsConsumed = gameState.teams.map((t) => {
                  if (t.id !== teamId) return t;
                  const nextInv = [...(t.inventory || [])];
                  const i = nextInv.indexOf(powerupId);
                  if (i >= 0) nextInv.splice(i, 1);
                  return { ...t, inventory: nextInv, powerupCooldown: true };
                });
                return { ...gameState, teams: teamsConsumed };
              };

              // powerup movement does NOT grant main-board rewards
              if (powerupId === "skip1" || powerupId === "skip2" || powerupId === "skip3") {
                const steps = powerupId === "skip1" ? 1 : powerupId === "skip2" ? 2 : 3;
                const before = team.pos;
                const dest = simulateAdvance(team, steps);
                
                // Cannot skip to or past the final tile
                if (dest >= MAX_TILE) {
                  alert(`Cannot use ${powerupLabel(powerupId)} - it would skip to or past the final tile. You must complete the final tile normally.`);
                  return addLog(game, `${team.name} tried to use ${powerupLabel(powerupId)} but it would skip the final tile.`);
                }
                
                let next = consumePowerup(game);
                const teams = next.teams.map((t) => (t.id === teamId ? { ...t, pos: dest } : t));
                next = { ...next, teams };
                next = addLog(next, `${team.name} used ${powerupLabel(powerupId)} (from ${tileDesc(next, before)} ? Current: ${tileDesc(next, dest)})`);
                return next;
              }

              if (powerupId === "back1" || powerupId === "back2" || powerupId === "back3") {
                const amount = powerupId === "back1" ? 1 : powerupId === "back2" ? 2 : 3;
                const target = game.teams.find((t) => t.id === targetId);
                if (!target || target.id === teamId) {
                  alert(`${team.name} tried to use ${powerupLabel(powerupId)} but no valid target was chosen.`);
                  return addLog(game, `${team.name} tried to use ${powerupLabel(powerupId)} but no valid target was chosen.`);
                }
                const before = target.pos;
                const dest = clamp(target.pos - amount, 1, MAX_TILE);
                let next = consumePowerup(game);
                const teams = next.teams.map((t) => (t.id === target.id ? { ...t, pos: dest, powerupCooldown: true } : t));
                next = { ...next, teams };
                next = addLog(next, `${team.name} used ${powerupLabel(powerupId)} on ${target.name} (from ${tileDesc(next, before)} ? Current: ${tileDesc(next, dest)})`);
                return next;
              }

              if (powerupId === "markFuture") {
                const tileN = Number(futureTile);
                if (!Number.isFinite(tileN) || tileN < 2 || tileN > MAX_TILE || tileN <= team.pos) {
                  alert(`Invalid future tile. Must be a tile ahead of your current position (${team.pos}).`);
                  return addLog(game, `Invalid future tile.`);
                }
                let next = consumePowerup(game);
                const teams = next.teams.map((t) => {
                  if (t.id !== teamId) return t;
                  return { ...t, preCleared: Array.from(new Set([...(t.preCleared || []), tileN])) };
                });
                next = { ...next, teams };
                next = addLog(next, `${team.name} used ${powerupLabel(powerupId)} (pre-cleared Tile ${tileN}).`);
                return next;
              }

              if (powerupId === "copypaste") {
                const tileN = Number(futureTile);
                if (!Number.isFinite(tileN) || tileN < 2 || tileN > MAX_TILE || tileN === team.pos) {
                  alert(`Invalid tile. Cannot copy to your current tile.`);
                  return addLog(game, `Invalid tile.`);
                }
                
                // Check if the destination tile has a reward powerup
                const destTile = getRaceTile(game, tileN);
                if (destTile.rewardPowerupId) {
                  alert(`Cannot copy to Tile ${tileN} because it has a reward powerup. Tiles with rewards cannot be changed.`);
                  return addLog(game, `${team.name} cannot copy to Tile ${tileN} because it has a reward powerup.`);
                }
                
                // Check if any team is currently standing on the target tile
                const teamOnTile = (game.teams || []).some((t) => t.pos === tileN);
                if (teamOnTile) {
                  alert(`Cannot copy to Tile ${tileN} because a team is currently standing on it.`);
                  return addLog(game, `${team.name} cannot copy to Tile ${tileN} because a team is currently standing on it.`);
                }
                
                // Get the current tile's task details
                const sourceTile = getRaceTile(game, team.pos);
                const sourceDiff = tileDiff(game, team.pos);
                const destDiff = tileDiff(game, tileN);
                
                // Can only copy to tiles with equal or lower difficulty
                if (destDiff > sourceDiff) {
                  alert(`Cannot copy to Tile ${tileN}. You can only overwrite tiles with equal or lower difficulty. Current tile difficulty: ${sourceDiff}, Target tile difficulty: ${destDiff}`);
                  return addLog(game, `${team.name} tried to copy to Tile ${tileN} but it's a higher difficulty than the current tile.`);
                }
                const beforeLabel = tileLabel(game, tileN);
                
                let next = consumePowerup(game);
                
                // Copy the task from current tile to the future tile (including difficulty, but keeping target's reward)
                const raceTiles = next.raceTiles.map((rt) =>
                  rt.n === tileN 
                    ? { 
                        ...rt, 
                        label: sourceTile.label, 
                        instructions: sourceTile.instructions || "", 
                        image: sourceTile.image || "",
                        maxCompletions: sourceTile.maxCompletions || 1,
                        difficulty: sourceTile.difficulty || 1
                      } 
                    : rt
                );
                next = { ...next, raceTiles };
                
                // Mark it as copy-choice so the team can complete it when they arrive
                const teams = next.teams.map((t) => {
                  if (t.id !== teamId) return t;
                  const entry = { tile: tileN, fromTile: team.pos };
                  const key = `${entry.tile}|${entry.fromTile}`;
                  const existing = new Set((t.copyChoice || []).map((x) => `${x.tile}|${x.fromTile ?? ""}`));
                  if (existing.has(key)) return t;
                  return { ...t, copyChoice: [...(t.copyChoice || []), entry] };
                });
                next = { ...next, teams };
                next = addLog(next, `${team.name} used ${powerupLabel(powerupId)} (Tile ${tileN}: "${beforeLabel}" ? "${sourceTile.label}" from ${tileDesc(next, team.pos)}).`);
                return next;
              }

              if (powerupId === "changeTile") {
                const tileN = Number(futureTile);
                if (!Number.isFinite(tileN) || tileN < 2 || tileN > MAX_TILE) {
                  alert(`Invalid tile number.`);
                  return addLog(game, `Invalid tile.`);
                }

                // Cannot change the final tile
                if (tileN === MAX_TILE) {
                  alert(`Cannot change the final tile. The final tile must be completed as-is.`);
                  return addLog(game, `${team.name} tried to change the final tile, but it cannot be changed.`);
                }

                // Check if any team is currently standing on the target tile
                const teamOnTile = (game.teams || []).some((t) => t.pos === tileN);
                if (teamOnTile) {
                  alert(`Cannot change Tile ${tileN} because a team is currently standing on it.`);
                  return addLog(game, `${team.name} cannot change Tile ${tileN} because a team is currently standing on it.`);
                }

                const changedTiles = new Set(game.changedTiles || []);
                if (changedTiles.has(tileN)) {
                  alert(`Tile ${tileN} has already been changed once. Each tile can only be changed once.`);
                  return addLog(game, `${team.name} tried to change Tile ${tileN}, but that tile has already been changed once.`);
                }

                const diff = tileDiff(game, tileN);
                const poolAll = game.taskPools?.[String(diff)] || [];
                const used = new Set(game.usedPoolTaskIds || []);
                const poolUnused = poolAll.filter((x) => !used.has(x.id));
                const chosen = poolUnused.find((x) => x.id === changeTaskId);
                if (!chosen) {
                  alert(`Must pick an UNUSED replacement task from difficulty ${diff} pool.`);
                  return addLog(game, `${team.name} must pick an UNUSED replacement task from difficulty ${diff} pool.`);
                }

                const beforeLabel = tileLabel(game, tileN);
                
                // Find the old task ID from the pool so we can keep it marked as used
                // Use normalized comparison for robustness
                const normalize = (str) => (str || "").trim().toLowerCase().replace(/\s+/g, ' ');
                const beforeLabelNormalized = normalize(beforeLabel);
                const oldTaskId = poolAll.find((x) => normalize(x.label) === beforeLabelNormalized)?.id;

                // Consume powerup only after all validation passes
                let next = consumePowerup(game);

                // copy relevant fields from chosen pool task into the main tile, but KEEP the tile's existing reward (tile-specific)
                const raceTiles = next.raceTiles.map((rt) =>
                  rt.n === tileN ? { ...rt, label: chosen.label, instructions: chosen.instructions || "", image: chosen.image || "" } : rt
                );
                // Keep both the old task and the new task marked as used
                const usedPoolTaskIds = Array.from(new Set([...(next.usedPoolTaskIds || []), chosen.id, ...(oldTaskId ? [oldTaskId] : [])]));
                const changedTilesArr = Array.from(new Set([...(next.changedTiles || []), tileN]));

                next = { ...next, raceTiles, usedPoolTaskIds, changedTiles: changedTilesArr };
                next = addLog(next, `${team.name} used ${powerupLabel(powerupId)} on Tile ${tileN} (D${diff}) ? "${beforeLabel}" ? "${chosen.label}".`);
                return next;
              }

              if (powerupId === "clearCooldown") {
                let next = consumePowerup(game);
                const teams = next.teams.map((t) => (t.id === teamId ? { ...t, powerupCooldown: false } : t));
                next = { ...next, teams };
                next = addLog(next, `${team.name} used ${powerupLabel(powerupId)} ? cooldown cleared.`);
                return next;
              }

              if (powerupId === "disablePowerup") {
                const target = game.teams.find((t) => t.id === targetId);
                const targetPowerupId = event.targetPowerupId;
                if (!target || target.id === teamId) {
                  alert(`${team.name} tried to use ${powerupLabel(powerupId)} but no valid target was chosen.`);
                  return addLog(game, `${team.name} tried to use ${powerupLabel(powerupId)} but no valid target was chosen.`);
                }
                if (!targetPowerupId || !(target.inventory || []).includes(targetPowerupId)) {
                  alert(`Target team doesn't have that powerup in inventory.`);
                  return addLog(game, `${team.name} tried to disable a powerup from ${target.name} but target doesn't have it.`);
                }
                let next = consumePowerup(game);
                const teams = next.teams.map((t) => {
                  if (t.id !== target.id) return t;
                  const nextInv = [...(t.inventory || [])];
                  const i = nextInv.indexOf(targetPowerupId);
                  if (i >= 0) nextInv.splice(i, 1);
                  return { ...t, inventory: nextInv };
                });
                next = { ...next, teams };
                next = addLog(next, `${team.name} used ${powerupLabel(powerupId)} on ${target.name} ? removed ${powerupLabel(targetPowerupId)}.`);
                return next;
              }

              if (powerupId === "doublePowerup") {
                const targetPowerupId = event.targetPowerupId;
                if (!targetPowerupId || !(team.inventory || []).includes(targetPowerupId)) {
                  alert(`You don't have that powerup in inventory.`);
                  return addLog(game, `${team.name} tried to double a powerup they don't have.`);
                }
                let next = consumePowerup(game);
                const teams = next.teams.map((t) => {
                  if (t.id !== teamId) return t;
                  return { ...t, inventory: [...(t.inventory || []), targetPowerupId] };
                });
                next = { ...next, teams };
                next = addLog(next, `${team.name} used ${powerupLabel(powerupId)} ? doubled ${powerupLabel(targetPowerupId)}.`);
                return next;
              }

              if (powerupId === "doubleEasy" || powerupId === "doubleMedium" || powerupId === "doubleHard") {
                const tileN = Number(futureTile);
                if (!Number.isFinite(tileN) || tileN < 1 || tileN > MAX_TILE) {
                  alert(`Invalid tile number.`);
                  return addLog(game, `${team.name} tried to double a tile but provided invalid tile number.`);
                }

                // Cannot double the final tile
                if (tileN === MAX_TILE) {
                  alert(`Cannot double the final tile. The final tile must be completed as-is.`);
                  return addLog(game, `${team.name} tried to double the final tile, but it cannot be doubled.`);
                }

                const targetDiff = powerupId === "doubleEasy" ? 1 : powerupId === "doubleMedium" ? 2 : 3;
                const tileDifficulty = tileDiff(game, tileN);
                
                if (tileDifficulty !== targetDiff) {
                  const diffName = targetDiff === 1 ? "easy" : targetDiff === 2 ? "medium" : "hard";
                  alert(`${powerupLabel(powerupId)} can only be used on ${diffName} tiles.`);
                  return addLog(game, `${team.name} tried to use ${powerupLabel(powerupId)} on Tile ${tileN} but it's not the correct difficulty.`);
                }

                // Check if any team is currently standing on the target tile
                const teamOnTile = (game.teams || []).some((t) => t.pos === tileN);
                if (teamOnTile) {
                  alert(`Cannot double Tile ${tileN} because a team is currently standing on it.`);
                  return addLog(game, `${team.name} cannot double Tile ${tileN} because a team is currently standing on it.`);
                }

                const doubledTilesInfo = game.doubledTilesInfo || {};
                if (doubledTilesInfo[tileN]) {
                  alert(`Tile ${tileN} has already been doubled.`);
                  return addLog(game, `${team.name} tried to double Tile ${tileN}, but it has already been doubled.`);
                }

                let next = consumePowerup(game);
                const originalTile = next.raceTiles.find(t => t.n === tileN);
                const originalMaxCompletions = originalTile ? originalTile.maxCompletions : 1;
                const useDifficultyPoints = originalMaxCompletions === 1;
                
                const raceTiles = next.raceTiles.map((t) => {
                  if (t.n !== tileN) return t;
                  return { ...t, maxCompletions: t.maxCompletions * 2, minCompletions: (t.minCompletions || 1) * 2 };
                });
                const newDoubledTilesInfo = { ...doubledTilesInfo, [tileN]: { useDifficultyPoints } };
                // Keep legacy doubledTiles array for backward compatibility
                const newDoubledTiles = [...(next.doubledTiles || []), tileN];
                next = { ...next, raceTiles, doubledTiles: newDoubledTiles, doubledTilesInfo: newDoubledTilesInfo };
                const updatedTile = raceTiles.find(t => t.n === tileN);
                next = addLog(next, `${team.name} used ${powerupLabel(powerupId)} on ${tileDesc(next, tileN)} ? requirement doubled to ${updatedTile.maxCompletions} (min: ${updatedTile.minCompletions}).`);
                return next;
              }

              return game;
            }

            // ===== Admin / setup events =====
            case "ADMIN_EDIT_RACE_TILE": {
              const n = Number(event.n);
              if (!Number.isFinite(n) || n < 1 || n > MAX_TILE) return game;

              const label = (event.label || "").trim() || `Task ${n}`;
              // Force final tile to always be hard
              const difficulty = n === MAX_TILE ? 3 : clamp(Number(event.difficulty || 1), 1, 3);
              const rewardPowerupId = event.rewardPowerupId ? event.rewardPowerupId : null;
              const instructions = (event.instructions || "").toString();
              const image = (event.image || "").toString();
              const maxCompletions = Math.max(1, Math.floor(Number(event.maxCompletions) || 1));
              const minCompletions = Math.max(1, Math.min(maxCompletions, Math.floor(Number(event.minCompletions) || 1)));

              // Capture old values
              const oldTile = game.raceTiles.find((t) => t.n === n);
              const oldLabel = oldTile ? oldTile.label : "";
              const oldDiff = oldTile ? oldTile.difficulty : 1;
              const oldMaxComp = oldTile ? oldTile.maxCompletions : 1;
              const oldMinComp = oldTile ? (oldTile.minCompletions || 1) : 1;
              const oldReward = oldTile?.rewardPowerupId || null;

              const raceTiles = game.raceTiles.map((t) =>
                t.n === n ? { ...t, label, difficulty, rewardPowerupId, instructions, image, maxCompletions, minCompletions } : t
              );
              let next = { ...game, raceTiles };
              
              const changes = [];
              if (oldLabel !== label) changes.push(`label: "${oldLabel}" ? "${label}"`);
              if (oldDiff !== difficulty) changes.push(`diff: ${oldDiff} ? ${difficulty}`);
              if (oldMaxComp !== maxCompletions) changes.push(`max: ${oldMaxComp} ? ${maxCompletions}`);
              if (oldMinComp !== minCompletions) changes.push(`min: ${oldMinComp} ? ${minCompletions}`);
              if (oldReward !== rewardPowerupId) changes.push(`reward: ${oldReward ? powerupLabel(oldReward) : "None"} ? ${rewardPowerupId ? powerupLabel(rewardPowerupId) : "None"}`);
              
              const changeText = changes.length > 0 ? ` (${changes.join(", ")})` : "";
              next = addLog(next, `Tile ${n} admin-updated${changeText}`);
              return next;
            }

            case "ADMIN_CREATE_POWERUP_TILE": {
              const label = (event.label || "").trim();
              const rewardPowerupId = event.rewardPowerupId || "";
              const instructions = (event.instructions || "").toString();
              const image = (event.image || "").toString();
              const pointsPerCompletion = Math.max(1, Math.floor(Number(event.pointsPerCompletion) || 1));
              const maxCompletions = Math.max(1, Math.floor(Number(event.maxCompletions) || 1));
              const minCompletions = Math.max(1, Math.min(maxCompletions, Math.floor(Number(event.minCompletions) || 1)));
              const claimType = ["eachTeam", "firstTeam", "unlimited"].includes(event.claimType) ? event.claimType : "eachTeam";
              if (!label || !rewardPowerupId) return game;

              const maxId = (game.powerupTiles || []).reduce((m, t) => Math.max(m, t.id), 0);
              const id = maxId + 1;

              const powerupTiles = [...(game.powerupTiles || []), { id, label, rewardPowerupId, instructions, image, link: image, pointsPerCompletion, maxCompletions, minCompletions, claimType }];
              let next = { ...game, powerupTiles };
              next = addLog(next, `Powerup created: P${id} "${label}" ? reward ${powerupLabel(rewardPowerupId)} (${pointsPerCompletion}pts ? ${maxCompletions}, min: ${minCompletions}, ${claimType})`);
              return next;
            }

            case "ADMIN_EDIT_POWERUP_TILE": {
              const id = Number(event.id);
              if (!Number.isFinite(id)) return game;

              const label = (event.label || "").trim() || `Powerup Task ${id}`;
              const rewardPowerupId = event.rewardPowerupId ? event.rewardPowerupId : null;
              const instructions = (event.instructions || "").toString();
              const image = (event.image || "").toString();
              const pointsPerCompletion = Math.max(1, Math.floor(Number(event.pointsPerCompletion) || 1));
              const maxCompletions = Math.max(1, Math.floor(Number(event.maxCompletions) || 1));
              const minCompletions = Math.max(1, Math.min(maxCompletions, Math.floor(Number(event.minCompletions) || 1)));
              const claimType = ["eachTeam", "firstTeam", "unlimited"].includes(event.claimType) ? event.claimType : "eachTeam";

              const powerupTiles = (game.powerupTiles || []).map((t) =>
                t.id === id ? { ...t, label, rewardPowerupId, instructions, image, link: image, pointsPerCompletion, maxCompletions, minCompletions, claimType } : t
              );
              let next = { ...game, powerupTiles };
              next = addLog(next, `Powerup tile P${id} updated: "${label}" (reward=${rewardPowerupId ? powerupLabel(rewardPowerupId) : "None"})`);
              return next;
            }

            case "ADMIN_ADD_POOL_TASK": {
              const diff = String(clamp(Number(event.diff || 1), 1, 3));
              const text = (event.label || "").trim();
              if (!text) return game;
              const item = { id: uid(), label: text, instructions: "", image: "" };
              const taskPools = { ...game.taskPools, [diff]: [...(game.taskPools?.[diff] || []), item] };
              let next = { ...game, taskPools };
              next = addLog(next, `Added possible task (diff ${diff}): "${text}"`);
              return next;
            }

            case "ADMIN_EDIT_POOL_TASK": {
              const diff = String(clamp(Number(event.diff || 1), 1, 3));
              const id = event.id;
              if (!id) return game;
              const label = (event.label || "").trim() || "";
              const instructions = (event.instructions || "").toString();
              const image = (event.image || "").toString();

              const pool = (game.taskPools?.[diff] || []).map((t) => (t.id === id ? { ...t, label, instructions, image } : t));
              const taskPools = { ...game.taskPools, [diff]: pool };
              let next = { ...game, taskPools };
              next = addLog(next, `Edited possible task (diff ${diff}): "${label}"`);
              return next;
            }

            case "ADMIN_REMOVE_POOL_TASK": {
              const diff = String(clamp(Number(event.diff || 1), 1, 3));
              const taskId = event.taskId;
              const taskPools = { ...game.taskPools, [diff]: (game.taskPools?.[diff] || []).filter((x) => x.id !== taskId) };
              const usedPoolTaskIds = (game.usedPoolTaskIds || []).filter((id) => id !== taskId);
              return { ...game, taskPools, usedPoolTaskIds };
            }

            case "ADMIN_CLEAR_TASK_POOLS": {
              const taskPools = { 1: [], 2: [], 3: [] };
              const usedPoolTaskIds = [];
              let next = { ...game, taskPools, usedPoolTaskIds };
              next = addLog(next, "Admin cleared all task pools.");
              return next;
            }

            case "ADMIN_CLEAR_POWERUP_TILES": {
              const powerupTiles = [];
              // Clear claimed powerups from all teams
              const teams = (game.teams || []).map(t => ({
                ...t,
                claimedPowerupTiles: []
              }));
              let next = { ...game, powerupTiles, teams };
              next = addLog(next, "Admin cleared all powerup tiles.");
              return next;
            }

            case "ADMIN_IMPORT_TASKS": {
              // Parse CSV/TSV data: label, difficulty, maxCompletions, minCompletions, instructions, imageUrl
              try {
                const rawData = String(event.data || "");
                const lines = rawData.split("\n").map(l => l.trim()).filter(Boolean);
                if (lines.length === 0) return game;

                const taskPools = { 1: [], 2: [], 3: [] };
                let imported = 0;
                let skipped = 0;

                lines.forEach((line) => {
                  try {
                    // Support both CSV and TSV (tab-separated)
                    let parts;
                    if (line.includes("\t")) {
                      parts = line.split("\t").map(p => p.trim());
                    } else {
                      // Simple CSV split that handles basic quoted fields
                      parts = line.split(",").map(p => p.trim().replace(/^["']|["']$/g, ''));
                    }
                    
                    if (parts.length < 2) { skipped++; return; }

                    const label = (parts[0] ?? "").trim();
                    if (!label) { skipped++; return; }

                    // Skip header lines if they look like text headers
                    const lowered = label.toLowerCase();
                    const p1 = (parts[1] || "").toLowerCase();
                    if (lowered.includes("label") && p1.includes("diff")) { skipped++; return; }

                    const difficulty = clamp(parseInt((parts[1] ?? "1").trim()) || 1, 1, 3);
                    const maxCompletionsRaw = (parts[2] ?? "").trim();
                    const maxCompletions = maxCompletionsRaw ? Math.max(1, parseInt(maxCompletionsRaw) || 1) : 1;
                    const minCompletionsRaw = (parts[3] ?? "").trim();
                    const minCompletions = minCompletionsRaw ? Math.max(1, Math.min(maxCompletions, parseInt(minCompletionsRaw) || 1)) : 1;
                    const instructionsRaw = (parts[4] ?? "").trim();
                    const instructions = instructionsRaw || "no detailed instructions given";
                    const image = (parts[5] ?? "").trim();

                    const task = {
                      id: uid(),
                      label,
                      difficulty,
                      maxCompletions,
                      minCompletions,
                      instructions,
                      image,
                    };

                    if (!taskPools[difficulty]) taskPools[difficulty] = [];
                    taskPools[difficulty].push(task);
                    imported++;
                  } catch {
                    skipped++;
                  }
                });

                // Reset usedPoolTaskIds when importing new tasks
                const usedPoolTaskIds = [];
                let next = { ...game, taskPools, usedPoolTaskIds };
                next = addLog(next, `Imported ${imported} tasks into pool. Skipped ${skipped}.`);
                return next;
              } catch (err) {
                console.error("Import error", err);
                return addLog(game, `Import failed: ${err?.message || err}`);
              }
            }

            case "ADMIN_IMPORT_POWERUPS": {
              // Parse CSV/TSV data: rewardPowerupId, label, pointsPerCompletion, maxCompletions, minCompletions, instructions, link, claimType
              try {
                const rawData = String(event.data || "");
                const lines = rawData.split("\n").map(l => l.trim()).filter(Boolean);
                if (lines.length === 0) return game;

                let imported = 0;
                let skipped = 0;
                const newPowerupTiles = [...(game.powerupTiles || [])];
                const maxId = newPowerupTiles.reduce((m, t) => Math.max(m, t.id), 0);
                let currentId = maxId;

                lines.forEach((line) => {
                  try {
                    // Support both CSV and TSV (tab-separated)
                    let parts;
                    if (line.includes("\t")) {
                      parts = line.split("\t").map(p => p.trim());
                    } else {
                      // Simple CSV split that handles basic quoted fields
                      parts = line.split(",").map(p => p.trim().replace(/^["']|["']$/g, ''));
                    }
                    if (parts.length < 2) { skipped++; return; }

                    const rewardPowerupId = (parts[0] ?? "").trim();
                    const label = (parts[1] ?? "").trim();
                    if (!label || !rewardPowerupId) { skipped++; return; }

                    // Skip header lines if they look like text headers
                    const lowered = rewardPowerupId.toLowerCase();
                    const p1 = label.toLowerCase();
                    if (lowered.includes("reward") || p1.includes("label") || p1.includes("task")) { skipped++; return; }

                    const pointsPerCompletion = Number(parts[2]) > 0 ? Number(parts[2]) : 1;
                    const maxCompletions = Math.max(1, Math.floor(Number(parts[3]) || 1));
                    const minCompletions = Math.max(1, Math.min(maxCompletions, Math.floor(Number(parts[4]) || 1)));
                    const claimTypeRaw = (parts[5] ?? "eachTeam").trim().toLowerCase();
                    const claimType = ["eachteam", "firstteam", "unlimited"].includes(claimTypeRaw) 
                      ? (claimTypeRaw === "eachteam" ? "eachTeam" : claimTypeRaw === "firstteam" ? "firstTeam" : "unlimited")
                      : "eachTeam";
                    const instructionsRaw = (parts[6] ?? "").trim();
                    const instructions = instructionsRaw || "no detailed instructions given";
                    const image = (parts[7] ?? "").trim();

                    currentId++;
                    const powerupTile = {
                      id: currentId,
                      label,
                      rewardPowerupId,
                      pointsPerCompletion,
                      maxCompletions,
                      minCompletions,
                      instructions,
                      image,
                      link: image,
                      claimType,
                    };

                    newPowerupTiles.push(powerupTile);
                    imported++;
                  } catch {
                    skipped++;
                  }
                });

                let next = { ...game, powerupTiles: newPowerupTiles };
                next = addLog(next, `Imported ${imported} powerup tiles. Skipped ${skipped}.`);
                return next;
              } catch (err) {
                console.error("Import error", err);
                return addLog(game, `Import failed: ${err?.message || err}`);
              }
            }

            case "ADMIN_REBUILD_USED_MARKERS": {
              // Rebuild usedPoolTaskIds by scanning all tiles currently on the board
              const usedIds = [];
              const normalize = (str) => (str || "").trim().toLowerCase().replace(/\s+/g, ' ');
              
              game.raceTiles.forEach(tile => {
                // Skip default/placeholder tiles
                if (!tile.label || tile.label.startsWith('Task ')) return;
                
                // Only check the pool that matches this tile's difficulty
                const tileDiff = tile.difficulty || 1;
                const tileLabel = normalize(tile.label);
                const pool = game.taskPools?.[String(tileDiff)] || [];
                const matchingTask = pool.find(t => normalize(t.label) === tileLabel);
                if (matchingTask && !usedIds.includes(matchingTask.id)) {
                  usedIds.push(matchingTask.id);
                }
              });

              let next = { ...game, usedPoolTaskIds: usedIds };
              next = addLog(next, `Rebuilt used markers: ${usedIds.length} tasks marked as used.`);
              return next;
            }


            case "ADMIN_RANDOMIZE_DIFFICULTIES": {
              // Randomly assign difficulties to tiles using weighted distribution.
              // Supports gradient: different early vs late weights interpolated across the board.
              const gradient = !!event.gradient;

              // Check task pool sizes and calculate max tiles per difficulty (leave at least 3 in pool)
              const MIN_HARDS = 17; // Minimum hard tiles enforced later
              const poolSizes = {
                1: (game.taskPools?.["1"] || []).length,
                2: (game.taskPools?.["2"] || []).length,
                3: (game.taskPools?.["3"] || []).length,
              };
              const maxTilesPerDiff = {
                1: Math.max(0, poolSizes[1] - 3),
                2: Math.max(0, poolSizes[2] - 3),
                3: Math.max(0, poolSizes[3] - 3),
              };
              
              // Adjust MIN_HARDS if pool is too small
              const effectiveMinHards = Math.min(MIN_HARDS, maxTilesPerDiff[3]);
              
              const diffCounts = { 1: 0, 2: 0, 3: 0 };

              function normalizeWeights(w) {
                const e = Math.max(0, Number(w.easy) || 0);
                const m = Math.max(0, Number(w.medium) || 0);
                const h = Math.max(0, Number(w.hard) || 0);
                const sum = e + m + h || 1;
                return { pe: e / sum, pm: m / sum, ph: h / sum, raw: { e, m, h } };
              }

              const baseWeights = normalizeWeights(event.weights || { easy: 50, medium: 35, hard: 15 });
              const earlyWeights = normalizeWeights(event.early || { easy: 60, medium: 30, hard: 10 });
              const lateWeights = normalizeWeights(event.late || { easy: 20, medium: 35, hard: 45 });

              // Assign with constraint: no more than 2 same difficulties in a row
              const total = game.raceTiles.length;
              let lastDiff = null;
              let streak = 0;
              let raceTiles = game.raceTiles.map((t, i) => {
                // Force first five tiles: Easy, Easy, Medium, Medium, Hard
                if (i === 0) {
                  lastDiff = 1;
                  streak = 1;
                  diffCounts[1]++;
                  return { ...t, difficulty: 1 };
                }
                if (i === 1) {
                  lastDiff = 1;
                  streak = 2;
                  diffCounts[1]++;
                  return { ...t, difficulty: 1 };
                }
                if (i === 2) {
                  lastDiff = 2;
                  streak = 1;
                  diffCounts[2]++;
                  return { ...t, difficulty: 2 };
                }
                if (i === 3) {
                  lastDiff = 2;
                  streak = 2;
                  diffCounts[2]++;
                  return { ...t, difficulty: 2 };
                }
                if (i === 4) {
                  lastDiff = 3;
                  streak = 1;
                  diffCounts[3]++;
                  return { ...t, difficulty: 3 };
                }

                // compute weights for position i
                let pe, pm, ph;
                if (!gradient) {
                  pe = baseWeights.pe; pm = baseWeights.pm; ph = baseWeights.ph;
                } else {
                  const pos = i / Math.max(1, total - 1);
                  pe = earlyWeights.pe * (1 - pos) + lateWeights.pe * pos;
                  pm = earlyWeights.pm * (1 - pos) + lateWeights.pm * pos;
                  const remaining = Math.max(0, 1 - (pe + pm));
                  ph = remaining;
                }

                // enforce constraint: if streak >= 2, zero out probability of lastDiff
                const probs = { 1: pe, 2: pm, 3: ph };
                if (streak >= 2 && lastDiff != null) {
                  probs[lastDiff] = 0;
                }
                
                // additional constraint: in first 10 tiles, don't allow 2 hards in a row
                if (i < 10 && lastDiff === 3 && streak >= 1) {
                  probs[3] = 0;
                }
                
                // prevent hard difficulty in first 4 tiles (tiles 1-4, indices 0-3)
                if (i < 4) {
                  probs[3] = 0;
                }

                // Pool size constraint: zero out probability if we've reached max for that difficulty
                if (diffCounts[1] >= maxTilesPerDiff[1]) probs[1] = 0;
                if (diffCounts[2] >= maxTilesPerDiff[2]) probs[2] = 0;
                if (diffCounts[3] >= maxTilesPerDiff[3]) probs[3] = 0;

                // normalize
                let sumP = probs[1] + probs[2] + probs[3];
                if (sumP <= 0) {
                  // fallback: pick any diff that hasn't hit max yet
                  const choices = [1, 2, 3].filter((d) => diffCounts[d] < maxTilesPerDiff[d]);
                  if (choices.length === 0) {
                    // All maxed out, just use any
                    const choice = (lastDiff === 1 ? 2 : 1);
                    diffCounts[choice]++;
                    if (choice === lastDiff) streak += 1; else { lastDiff = choice; streak = 1; }
                    return { ...t, difficulty: choice };
                  }
                  const choice = choices[Math.floor(Math.random() * choices.length)];
                  diffCounts[choice]++;
                  if (choice === lastDiff) streak += 1; else { lastDiff = choice; streak = 1; }
                  return { ...t, difficulty: choice };
                }
                const nProbs = { 1: probs[1] / sumP, 2: probs[2] / sumP, 3: probs[3] / sumP };
                const r = Math.random();
                let chosen;
                if (r < nProbs[1]) chosen = 1;
                else if (r < nProbs[1] + nProbs[2]) chosen = 2;
                else chosen = 3;

                diffCounts[chosen]++;
                if (chosen === lastDiff) streak += 1; else { lastDiff = chosen; streak = 1; }
                return { ...t, difficulty: chosen };
              });

              // Force final tile to always be hard
              raceTiles = raceTiles.map((rt, i) => {
                if (rt.n === MAX_TILE) {
                  return { ...rt, difficulty: 3 };
                }
                return rt;
              });

              // Enforce minimum number of hard tiles (only if we have enough in pool)
              const diffs = raceTiles.map(rt => rt.difficulty || 1);
              let hardCount = diffs.filter(d => d === 3).length;
              let easyCount = diffs.filter(d => d === 1).length;
              let mediumCount = diffs.filter(d => d === 2).length;
              
              if (hardCount < effectiveMinHards && hardCount < maxTilesPerDiff[3]) {
                const canSetHardAt = (arr, idx) => {
                  if (arr[idx] === 3) return false;
                  let l = 0;
                  for (let j = idx - 1; j >= 0 && arr[j] === 3; j--) l++;
                  let r = 0;
                  for (let j = idx + 1; j < arr.length && arr[j] === 3; j++) r++;
                  return (l + 1 + r) <= 2;
                };
                // Prefer upgrading Mediums first, then Easies, bias toward later tiles to keep early easier
                const indicesMedium = diffs.map((d, i) => ({ d, i })).filter(x => x.d === 2).map(x => x.i);
                const indicesEasy = diffs.map((d, i) => ({ d, i })).filter(x => x.d === 1).map(x => x.i);
                const candidates = [...indicesMedium.reverse(), ...indicesEasy.reverse()];
                for (const idx of candidates) {
                  if (hardCount >= effectiveMinHards || hardCount >= maxTilesPerDiff[3]) break;
                  
                  const currentDiff = diffs[idx];
                  
                  // Skip this tile if converting it would violate pool constraints
                  if (currentDiff === 1 && easyCount <= maxTilesPerDiff[1]) continue;
                  if (currentDiff === 2 && mediumCount <= maxTilesPerDiff[2]) continue;
                  
                  if (canSetHardAt(diffs, idx)) {
                    const oldDiff = diffs[idx];
                    diffs[idx] = 3;
                    hardCount++;
                    if (oldDiff === 1) easyCount--;
                    if (oldDiff === 2) mediumCount--;
                  }
                }
                // apply back to raceTiles
                raceTiles = raceTiles.map((rt, i) => ({ ...rt, difficulty: diffs[i] }));
              }
              
              // Check for potential assignment issues
              const finalDiffCounts = {
                1: raceTiles.filter(rt => rt.difficulty === 1).length,
                2: raceTiles.filter(rt => rt.difficulty === 2).length,
                3: raceTiles.filter(rt => rt.difficulty === 3).length,
              };
              
              const warnings = [];
              if (finalDiffCounts[1] > maxTilesPerDiff[1]) {
                warnings.push(`${finalDiffCounts[1]} Easy tiles but only ${maxTilesPerDiff[1]} available from pool`);
              }
              if (finalDiffCounts[2] > maxTilesPerDiff[2]) {
                warnings.push(`${finalDiffCounts[2]} Medium tiles but only ${maxTilesPerDiff[2]} available from pool`);
              }
              if (finalDiffCounts[3] > maxTilesPerDiff[3]) {
                warnings.push(`${finalDiffCounts[3]} Hard tiles but only ${maxTilesPerDiff[3]} available from pool`);
              }
              
              // Clear usedPoolTaskIds since tile difficulties changed - tasks will be reassigned
              let next = { ...game, raceTiles, usedPoolTaskIds: [] };
              
              if (warnings.length > 0) {
                const warningMsg = `?? Distribution may cause issues when assigning tiles:\n\n${warnings.join('\n')}\n\nSome tiles may not be assignable from the pool!`;
                next = addLog(next, `Randomized difficulties - WARNING: ${warnings.join('; ')}`);
                setTimeout(() => {
                  alert(warningMsg);
                }, 100);
              } else if (gradient) {
                next = addLog(next, `Randomized difficulties with gradient: Early(E:${earlyWeights.raw.e}, M:${earlyWeights.raw.m}, H:${earlyWeights.raw.h}) ? Late(E:${lateWeights.raw.e}, M:${lateWeights.raw.m}, H:${lateWeights.raw.h}).`);
              } else {
                next = addLog(next, `Randomized difficulties with weights E:${baseWeights.raw.e} M:${baseWeights.raw.m} H:${baseWeights.raw.h}.`);
              }
              return next;
            }

            case "ADMIN_SET_TEAM": {
              const teamId = event.teamId;
              const pos = clamp(Number(event.pos || 1), 1, MAX_TILE);
              const inventory = Array.isArray(event.inventory) ? event.inventory : [];
              const members = Array.isArray(event.members) ? event.members : null;
              const captain = typeof event.captain === "string" ? event.captain : null;
              const playerPoints = typeof event.playerPoints === "object" && event.playerPoints !== null ? event.playerPoints : null;

              const allowed = new Set(POWERUP_DEFS.map((p) => p.id));
              const inv = inventory.filter((x) => allowed.has(x));

              // Capture old values before update
              const oldTeam = game.teams.find((t) => t.id === teamId);
              const oldPos = oldTeam ? oldTeam.pos : 1;
              const oldInvCount = oldTeam ? (oldTeam.inventory || []).length : 0;

              const teams = game.teams.map((t) => {
                if (t.id !== teamId) return t;
                const nextT = { ...t, pos, inventory: inv };
                if (members !== null) nextT.members = members;
                if (captain !== null) nextT.captain = captain;
                if (playerPoints !== null) {
                  // normalize to numbers
                  const normalized = {};
                  Object.keys(playerPoints).forEach((k) => {
                    const v = Number(playerPoints[k]);
                    if (!Number.isFinite(v) || v < 0) normalized[k] = 0;
                    else normalized[k] = Math.round(v * 100) / 100;
                  });
                  nextT.playerPoints = normalized;
                }
                return nextT;
              });

              let next = { ...game, teams };
              const t = next.teams.find((x) => x.id === teamId);
              const posChange = oldPos !== pos ? ` (${tileDesc(next, oldPos)} ? ${tileDesc(next, pos)})` : ` (${tileDesc(next, pos)})`;
              const pwrChange = oldInvCount !== inv.length ? ` powerups: ${oldInvCount} ? ${inv.length}` : ` powerups: ${inv.length}`;
              next = addLog(next, `${t?.name ?? "Team"} admin-updated${posChange},${pwrChange}.`);
              return next;
            }

            // Used by the draft modal "Apply to game"
            case "ADMIN_APPLY_DRAFT_TEAMS": {
              const payloadTeams = Array.isArray(event.teams) ? event.teams : [];
              if (payloadTeams.length === 0) return game;

              // keep existing teams if name matches, otherwise create new
              let nextTeams = [...(game.teams || [])];

              function ensureTeam(teamName, indexHint) {
                const existing = nextTeams.find((t) => t.name.toLowerCase() === teamName.toLowerCase());
                if (existing) return existing;
                const team = {
                  id: uid(),
                  name: teamName,
                  color: colorForIndex(nextTeams.length + (indexHint || 0)),
                  pos: 1,
                  createdAt: Date.now(),
                  inventory: [],
                  preCleared: [],
                  copyChoice: [],
                  claimedRaceTileRewards: [],
                  claimedPowerupTiles: [],
                  members: [],
                  captain: "",
                };
                nextTeams = [...nextTeams, team];
                return team;
              }

              for (let i = 0; i < payloadTeams.length; i++) {
                const pt = payloadTeams[i];
                const name = (pt.name || "").trim();
                if (!name) continue;

                const team = ensureTeam(name, i);
                // update members/captain
                nextTeams = nextTeams.map((t) =>
                  t.id === team.id ? { ...t, members: pt.members || [], captain: pt.captain || "" } : t
                );
              }

              let next = { ...game, teams: nextTeams };
              next = addLog(next, `Draft applied: ${payloadTeams.length} team(s) updated.`);
              return next;
            }

            case "ADMIN_CREATE_ADMIN": {
              const { name, password } = event;
              if (!name || !password) return game;
              const newAdmin = { id: uid(), name: String(name), password: String(password), isMaster: false };
              const admins = [...(game.admins || []), newAdmin];
              let next = { ...game, admins };
              next = addLog(next, `Admin account created: ${name}`, event.adminName);
              return next;
            }

            case "ADMIN_DELETE_ADMIN": {
              const { adminId } = event;
              const admin = (game.admins || []).find(a => a.id === adminId);
              if (!admin || admin.isMaster) return game; // Cannot delete master
              const admins = (game.admins || []).filter(a => a.id !== adminId);
              let next = { ...game, admins };
              next = addLog(next, `Admin account deleted: ${admin.name}`, event.adminName);
              return next;
            }

            case "ADMIN_CHANGE_ADMIN_PASSWORD": {
              const { adminId, password } = event;
              const admins = (game.admins || []).map(a => 
                a.id === adminId ? { ...a, password: String(password) } : a
              );
              const admin = admins.find(a => a.id === adminId);
              let next = { ...game, admins };
              next = addLog(next, `Password changed for admin: ${admin?.name || "unknown"}`, event.adminName);
              return next;
            }

            case "ADMIN_SET_TEAM_PASSWORD": {
              const teamId = event.teamId;
              const password = String(event.password || "");
              const teams = (game.teams || []).map((t) => (t.id === teamId ? { ...t, password } : t));
              let next = { ...game, teams };
              const team = teams.find((t) => t.id === teamId);
              next = addLog(next, `Password ${password ? "set" : "cleared"} for team: ${team?.name ?? "unknown"}`);
              return next;
            }

            default:
              return game;
          }
        } catch (e) {
          return addLog(game, `ERROR applying event ${event?.type ?? "(unknown)"}: ${String(e?.message || e)}`);
        }
      }

      function App() {
        const STORAGE_KEY_GAME = "tile_race_game_state_v2_instructions_draft";

        // UI-only state (not shared / not persisted)
        const [ui, setUi] = useState(() => {
          const savedTheme = localStorage.getItem('tileRaceTheme');
          return {
          darkMode: savedTheme === 'dark',
          adminMode: true,
          fogOfWarOverride: false, // Master admin can toggle to see all tiles
          lastBackupTime: 0, // Track last backup timestamp for rate limiting
          backupCount: 0, // Track number of backups today
          backupDay: new Date().toDateString(), // Track which day backups were made

          newTeamName: "",
          poolInputs: { 1: "", 2: "", 3: "" },

          // modals
          usePowerupTeamId: null,
          claimTeamId: null,
          claimSelectedPowerTileId: null,
          claimConfirmOpen: false,
          useTargetPowerupId: null,

          editTeamId: null,

          // tile info modals
          mainTileModalOpen: false,
          mainTileModalN: 1,

          powerTileModalOpen: false,
          powerTileModalId: 1,

          // create powerup tile
          createPowerOpen: false,
          createPowerLabel: "",
          createPowerReward: "",
          createPowerInstructions: "",
          createPowerImage: "",
          createPowerPoints: 1,
          createPowerMaxComp: 1,
          createPowerMinComp: 1,
          createPowerClaimType: "eachTeam",

          // draft modal (testing/dev)
          draftOpen: false,

          // player points sidebar visibility
          showPlayerPoints: true,

          // complete picker
          completePickerTeamId: null,
          completePickerPlayers: [],

          // powerup claim picker
          powerupClaimPickerOpen: false,
          powerupClaimPickerTeamId: null,
          powerupClaimPickerTileId: null,
          powerupClaimPickerPlayers: [],

          // import tasks
          importTasksOpen: false,
          importTasksData: "",

          // import powerups
          importPowerupsOpen: false,
          importPowerupsData: "",

          // authentication
          loginModalOpen: false,
          passwordSetupOpen: false,
          loginAsTeam: null,
          loginPassword: '',

          // difficulty randomization weights (in percentages, sum doesn't have to be 100, we'll normalize)
          // global weights (unused when gradient override is enabled)
          weightEasy: 50,
          weightMedium: 35,
          weightHard: 15,

          // gradient difficulty weights across board (early -> late)
          gradientEnabled: true,
          earlyEasy: 60,
          earlyMedium: 30,
          earlyHard: 10,
          lateEasy: 20,
          lateMedium: 35,
          lateHard: 45,
        };
        });

        // Authentication state (persisted in localStorage)
        const [auth, setAuth] = useState(() => {
          const saved = localStorage.getItem('tileRaceAuth');
          if (saved) {
            try {
              return JSON.parse(saved);
            } catch {}
          }
          return { loggedInAs: null, isAdmin: false, adminId: null, adminName: null }; // null = not logged in, or team ID
        });

        React.useEffect(() => {
          localStorage.setItem('tileRaceAuth', JSON.stringify(auth));
        }, [auth]);

        // Save theme preference to localStorage whenever it changes
        React.useEffect(() => {
          localStorage.setItem('tileRaceTheme', ui.darkMode ? 'dark' : 'light');
        }, [ui.darkMode]);

        // Close options menu when clicking outside
        React.useEffect(() => {
          if (!ui.optionsMenuOpen) return;
          
          function handleClickOutside(event) {
            const target = event.target;
            const optionsButton = target.closest('button');
            if (!optionsButton || !optionsButton.textContent.includes('Options')) {
              setUi((u) => ({ ...u, optionsMenuOpen: false }));
            }
          }
          
          document.addEventListener('click', handleClickOutside);
          return () => document.removeEventListener('click', handleClickOutside);
        }, [ui.optionsMenuOpen]);

        // Draft modal internal UI-only state
        const [draft, setDraft] = useState({
          step: "setup", // setup | picking | stealing | summary
          playersText: "Alice\nBob\nCharlie\nDaisy\nElliot\nFiona",
          teamsText: "Team 1\nTeam 2",
          captains: {}, // teamName -> captainName
          available: [], // player names
          order: [], // team names
          pickIndex: 0,
          picks: {}, // teamName -> [players]
          stealsUsed: {}, // teamName -> boolean (has team used their steal)
          stealIndex: 0,
          originalTeams: {}, // playerName -> teamName at start of stealing phase
          stolenFrom: {}, // teamName -> boolean (has team had player stolen from them)
          lastStolenBy: {}, // victimTeam -> thiefTeam (who stole from this team last)
        });

        // Game state
        const [game, setGame] = useState(initialGame);
        const [isLoading, setIsLoading] = useState(true);
        const gameRef = useRef(null);
        const lastEventIdRef = useRef(null);

        // Initialize game state from Firebase or localStorage
        useEffect(() => {
          if (isFirebaseEnabled) {
            // Firebase mode - Event sourcing approach
            const eventsRef = database.ref('events');
            const gameStateRef = database.ref('gameState');
            
            // Load initial game state and all events
            Promise.all([
              gameStateRef.once('value'),
              eventsRef.once('value')
            ]).then(([stateSnapshot, eventsSnapshot]) => {
              let currentGame;
              const events = [];
              let snapshotTimestamp = 0;
              
              // Get initial state or create new one
              if (stateSnapshot.exists()) {
                currentGame = stateSnapshot.val();
                snapshotTimestamp = currentGame._snapshotTimestamp || 0;
                // Remove internal metadata
                delete currentGame._snapshotTimestamp;
                
                // Find the last event ID from snapshot timestamp to continue listening
                if (eventsSnapshot.exists()) {
                  let lastProcessedId = null;
                  eventsSnapshot.forEach((childSnapshot) => {
                    const eventData = childSnapshot.val();
                    if (eventData.timestamp <= snapshotTimestamp) {
                      lastProcessedId = childSnapshot.key;
                    }
                  });
                  if (lastProcessedId) {
                    lastEventIdRef.current = lastProcessedId;
                  }
                }
              } else {
                currentGame = initialGame();
                gameStateRef.set(currentGame);
              }
              
              // Migrate if needed
              if (currentGame.version === 2 && currentGame.adminPassword !== undefined) {
                currentGame.version = 3;
                currentGame.admins = [{ id: "master", name: "Master Admin", password: currentGame.adminPassword || "admin123", isMaster: true }];
                delete currentGame.adminPassword;
              }
              if (currentGame.version === 3 && !currentGame.admins) {
                currentGame.admins = [{ id: "master", name: "Master Admin", password: "admin123", isMaster: true }];
              }
              if (currentGame.raceTiles) {
                currentGame.raceTiles = currentGame.raceTiles.filter(t => t.n <= MAX_TILE);
              }
              // Ensure revealedTiles is always set (migration for older games)
              if (!currentGame.revealedTiles || currentGame.revealedTiles.length === 0) {
                currentGame.revealedTiles = [1, 2, 3, 4, 5, 6, 7, 8];
              }
              
              setGame(currentGame);
              setIsLoading(false);
              
              // Listen for new events only (after initial load)
              const startKey = lastEventIdRef.current;
              const query = startKey 
                ? eventsRef.orderByKey().startAfter(startKey)
                : eventsRef.orderByKey();
              
              const onChildAdded = (snapshot) => {
                const eventData = snapshot.val();
                const eventId = snapshot.key;
                
                // Skip if this is from initial load
                if (startKey && eventId <= startKey) {
                  return;
                }
                
                lastEventIdRef.current = eventId;
                
                // Apply event to current game state
                setGame((currentGame) => {
                  const newGame = applyEvent(currentGame, eventData.event);
                  
                  // Force immediate snapshot for critical events
                  if (eventData.event.type === 'ADMIN_SET_TEAM_PASSWORD' || 
                      eventData.event.type === 'ADMIN_CHANGE_ADMIN_PASSWORD' ||
                      eventData.event.type === 'ADMIN_CREATE_ADMIN' ||
                      eventData.event.type === 'ADMIN_DELETE_ADMIN') {
                    setTimeout(() => {
                      const gameStateRef = database.ref('gameState');
                      const snapshotData = { ...newGame, _snapshotTimestamp: Date.now() };
                      gameStateRef.set(snapshotData);
                    }, 500);
                  }
                  
                  return newGame;
                });
              };
              
              query.on('child_added', onChildAdded);
              
              // Store cleanup function
              return () => {
                query.off('child_added', onChildAdded);
              };
            }).catch((error) => {
              console.error("Failed to initialize Firebase:", error);
              setGame(initialGame());
              setIsLoading(false);
            });
          } else {
            // localStorage mode (fallback)
            const raw = localStorage.getItem(STORAGE_KEY_GAME);
            if (raw) {
              try {
                const loaded = JSON.parse(raw);
                if (loaded.raceTiles) {
                  loaded.raceTiles = loaded.raceTiles.filter(t => t.n <= MAX_TILE);
                }
                if (loaded.version === 2 && loaded.adminPassword !== undefined) {
                  loaded.version = 3;
                  loaded.admins = [{ id: "master", name: "Master Admin", password: loaded.adminPassword || "admin123", isMaster: true }];
                  delete loaded.adminPassword;
                }
                if (loaded.version === 3 && !loaded.admins) {
                  loaded.admins = [{ id: "master", name: "Master Admin", password: "admin123", isMaster: true }];
                }
                setGame(loaded);
              } catch {}
            }
            setIsLoading(false);
          }
        }, []);

        // History for undo (keep last 50 states)
        const [history, setHistory] = useState([]);

        // Save to storage when game changes
        useEffect(() => {
          if (!isFirebaseEnabled && !isLoading) {
            // localStorage mode
            localStorage.setItem(STORAGE_KEY_GAME, JSON.stringify(game));
          } else if (isFirebaseEnabled && !isLoading) {
            // Firebase mode - periodically snapshot current state
            // This prevents having to replay all events on every refresh
            const gameStateRef = database.ref('gameState');
            const snapshotData = {
              ...game,
              _snapshotTimestamp: Date.now()
            };
            gameStateRef.set(snapshotData).catch((error) => {
              console.error("Failed to update gameState snapshot:", error);
            });
          }
        }, [game, isLoading]);

        function dispatch(event) {
          if (isFirebaseEnabled) {
            // Firebase mode - Add event to queue (atomic operation)
            const eventsRef = database.ref('events');
            
            // Save to history before change
            setHistory((h) => [game, ...h].slice(0, 50));
            
            // Push event to Firebase queue with timestamp
            eventsRef.push({
              event: event,
              timestamp: Date.now()
            }).catch((error) => {
              console.error("Failed to queue event:", error);
              alert("Failed to save changes. Check your internet connection.");
              
              // Rollback on failure
              setHistory((h) => {
                if (h.length > 0) {
                  const [previousState, ...rest] = h;
                  setGame(previousState);
                  return rest;
                }
                return h;
              });
            });
            
            // Optimistically apply event locally (will be overridden by Firebase listener if needed)
            const newGame = applyEvent(game, event);
            setGame(newGame);
          } else {
            // localStorage mode
            setGame((g) => {
              setHistory((h) => {
                const newHistory = [g, ...h].slice(0, 50);
                return newHistory;
              });
              return applyEvent(g, event);
            });
          }
        }

        function undoLastAction() {
          if (history.length === 0) {
            alert("No actions to undo.");
            return;
          }
          
          const [previousState, ...rest] = history;
          
          if (isFirebaseEnabled) {
            // Firebase mode - Can't truly undo with event sourcing, but we can restore local state
            // Note: This only affects local view, not the event queue
            // For true undo, you'd need to add a "revert" event
            alert("Note: Undo in real-time mode only affects your local view. Other users will keep their state.");
          }
          
          setHistory(rest);
          setGame(previousState);
        }

        const teams = game.teams || [];
        const sortedTeams = useMemo(() => [...teams].sort((a, b) => a.createdAt - b.createdAt), [teams]);
        const usedPoolTaskIds = useMemo(() => {
          const usedSet = new Set(game.usedPoolTaskIds || []);
          return usedSet;
        }, [game.usedPoolTaskIds, game.taskPools]);
        const changedTiles = useMemo(() => new Set(game.changedTiles || []), [game.changedTiles]);
        const doubledTiles = useMemo(() => new Set(game.doubledTiles || []), [game.doubledTiles]);
        const revealedTiles = useMemo(() => new Set(game.revealedTiles || []), [game.revealedTiles]);

        function progressPct(pos) {
          const pct = ((pos - 1) / (MAX_TILE - 1)) * 100;
          return clamp(pct, 0, 100);
        }

        // Responsive column count for S-pattern layout
        const [cols, setCols] = useState(() => {
          if (typeof window === "undefined") return 4;
          const w = window.innerWidth;
          return w >= 768 ? 4 : w >= 640 ? 3 : 2;
        });
        useEffect(() => {
          function updateCols() {
            const w = typeof window !== "undefined" ? window.innerWidth : 1024;
            setCols(w >= 768 ? 4 : w >= 640 ? 3 : 2);
          }
          updateCols();
          window.addEventListener("resize", updateCols);
          return () => window.removeEventListener("resize", updateCols);
        }, []);

        // Row-based serpentine (horizontal S) layout helpers
        const rows = useMemo(() => {
          const tiles = game.raceTiles || [];
          const c = Math.max(1, cols || 1);
          const out = [];
          for (let i = 0; i < tiles.length; i += c) out.push(tiles.slice(i, i + c));
          return out;
        }, [game.raceTiles, cols]);

        const serpentRows = useMemo(() => {
          const tiles = (game.raceTiles || []).slice().sort((a, b) => a.n - b.n);
          const result = [];
          const COLS = 4;
          let dir = 1; // 1 = left-to-right, -1 = right-to-left
          let i = 0;
          
          // Handle all tiles except the last one with serpentine logic
          const regularTiles = tiles.slice(0, -1);
          const finalTile = tiles[tiles.length - 1];
          
          while (i < regularTiles.length) {
            // full row
            const row = new Array(COLS).fill(null);
            if (dir === 1) {
              for (let c = 0; c < COLS && i < regularTiles.length; c++, i++) row[c] = regularTiles[i];
            } else {
              for (let c = COLS - 1; c >= 0 && i < regularTiles.length; c--, i++) row[c] = regularTiles[i];
            }
            result.push(row);
            if (i >= regularTiles.length) break;
            // turn row: one tile at the edge we just ended on
            const turn = new Array(COLS).fill(null);
            if (dir === 1) {
              // previous ended at right edge -> place next at rightmost
              turn[COLS - 1] = regularTiles[i];
            } else {
              // previous ended at left edge -> place next at leftmost
              turn[0] = regularTiles[i];
            }
            i++;
            result.push(turn);
            dir *= -1; // flip direction for next full row
          }
          
          // Add final tile on its own row
          if (finalTile) {
            result.push([finalTile]);
          }
          
          return result;
        }, [game.raceTiles]);

        // ===== Authentication helpers
        function checkTeamAuth(teamId) {
          if (auth.isAdmin) return true; // Admin can do anything
          return auth.loggedInAs === teamId;
        }

        function checkAdminAuth() {
          return auth.isAdmin;
        }

        function checkMasterAdmin() {
          return auth.isAdmin && auth.adminId === "master";
        }

        function attemptLogin(password, teamId = null, asAdmin = false) {
          // Admin login
          if (asAdmin) {
            const admin = (game.admins || []).find(a => a.password === password);
            if (admin) {
              setAuth({ loggedInAs: null, isAdmin: true, adminId: admin.id, adminName: admin.name });
              return true;
            }
            return false;
          }
          
          // Team login
          const team = game.teams.find((t) => t.id === teamId);
          if (!team) return false;
          
          // If team password hasn't been set by admin yet, deny login
          if (!team.password || team.password === "") {
            return false;
          }
          
          // Team has password - require it to match
          if (String(password) === String(team.password)) {
            setAuth({ loggedInAs: teamId, isAdmin: false, adminId: null, adminName: null });
            return true;
          }
          
          return false;
        }

        function logout() {
          setAuth({ loggedInAs: null, isAdmin: false, adminId: null, adminName: null });
        }

        const currentTeam = auth.loggedInAs ? game.teams.find((t) => t.id === auth.loggedInAs) : null;

        // ===== main UI handlers
        function onAddTeam() {
          if (!checkAdminAuth()) {
            alert('Admin authentication required.');
            return;
          }
          dispatch({ type: "ADD_TEAM", name: ui.newTeamName, adminName: auth.adminName });
          setUi((u) => ({ ...u, newTeamName: "" }));
        }
        function onReset() {
          if (!confirm("?? Reset everything? This will delete ALL data (teams, tiles, events, everything) and start fresh. This CANNOT be undone.")) return;
          if (isFirebaseEnabled) {
            if (!confirm("Last chance: This will permanently delete all Firebase data. Continue?")) return;
            database.ref('events').remove();
            database.ref('gameState').remove();
          }
          try {
            localStorage.removeItem(STORAGE_KEY_GAME);
          } catch {}
          dispatch({ type: "RESET_ALL" });
          setUi((u) => ({
            ...u,
            usePowerupTeamId: null,
            claimTeamId: null,
            claimSelectedPowerTileId: null,
            claimConfirmOpen: false,
            editTeamId: null,
            mainTileModalOpen: false,
            powerTileModalOpen: false,
            createPowerOpen: false,
            draftOpen: false,
            importTasksOpen: false,
            importTasksData: "",
            completePickerTeamId: null,
            completePickerPlayers: [],
          }));
          // Ensure full UI refresh after reset
          if (typeof window !== "undefined") {
            setTimeout(() => {
              window.location.reload();
            }, 50);
          }
        }

        // ===== convenience lookups
        const usePowerTeam = teams.find((t) => t.id === ui.usePowerupTeamId) || null;
        const claimTeam = teams.find((t) => t.id === ui.claimTeamId) || null;
        const editTeam = teams.find((t) => t.id === ui.editTeamId) || null;

        // Use powerup modal controls
        const [usePwrId, setUsePwrId] = useState("skip1");
        const [useTargetId, setUseTargetId] = useState("");
        const [useFutureTile, setUseFutureTile] = useState("");
        const [useChangeTaskId, setUseChangeTaskId] = useState("");

        useEffect(() => {
          if (!usePowerTeam) return;
          setUsePwrId(usePowerTeam.inventory?.[0] || "skip1");
          setUseTargetId("");
          setUseFutureTile("");
          setUseChangeTaskId("");
        }, [ui.usePowerupTeamId]);

        // Change-future derived
        const parsedFuture = Number(useFutureTile);
        const futureValid =
          Number.isFinite(parsedFuture) &&
          parsedFuture >= 2 &&
          parsedFuture <= MAX_TILE;

        const futureAlreadyChanged = futureValid ? changedTiles.has(parsedFuture) : false;
        const futureDiff = futureValid ? tileDiff(game, parsedFuture) : null;
        const poolAll = futureDiff ? (game.taskPools?.[String(futureDiff)] || []) : [];
        const poolUnused = poolAll.filter((x) => !usedPoolTaskIds.has(x.id));

        useEffect(() => {
          if (usePwrId !== "changeTile") return;
          if (!futureValid || futureAlreadyChanged || poolUnused.length === 0) {
            setUseChangeTaskId("");
            return;
          }
          if (!poolUnused.some((x) => x.id === useChangeTaskId)) setUseChangeTaskId(poolUnused[0].id);
        }, [usePwrId, useFutureTile, ui.usePowerupTeamId, game.usedPoolTaskIds]);

        // Claim modal derived list
        function claimablePowerTiles(team) {
          if (!team) return [];
          return (game.powerupTiles || []).map((pt) => {
            const claimType = pt.claimType || "eachTeam";
            const hasReward = !!pt.rewardPowerupId;
            const teamClaimed = (team.claimedPowerupTiles || []).includes(pt.id);
            
            let disabled = !hasReward;
            let claimedByTeam = null;
            
            if (claimType === "eachTeam") {
              // Each team can claim once
              disabled = disabled || teamClaimed;
            } else if (claimType === "firstTeam") {
              // Only one team globally can claim
              const teamThatClaimed = game.teams.find(t => (t.claimedPowerupTiles || []).includes(pt.id));
              if (teamThatClaimed) {
                disabled = true;
                claimedByTeam = teamThatClaimed.name;
              }
            }
            // claimType === "unlimited" - never disabled based on claims
            
            return { ...pt, claimed: teamClaimed, disabled, claimedByTeam };
          });
        }

        // Admin edit team inputs
        const [editPos, setEditPos] = useState("1");
        const [editInvText, setEditInvText] = useState("");
        const [editMembersText, setEditMembersText] = useState("");
        const [editCaptain, setEditCaptain] = useState("");
        const [editPlayerPoints, setEditPlayerPoints] = useState({});
        useEffect(() => {
          if (!editTeam) return;
          setEditPos(String(editTeam.pos));
          setEditInvText((editTeam.inventory || []).join("\n"));
          setEditMembersText((editTeam.members || []).join("\n"));
          setEditCaptain(editTeam.captain || "");
          setEditPlayerPoints(editTeam.playerPoints ? { ...editTeam.playerPoints } : {});
        }, [ui.editTeamId]);

        // Main tile modal edit fields
        const mainModalTile = getRaceTile(game, ui.mainTileModalN);
        const [mainEditLabel, setMainEditLabel] = useState(mainModalTile.label || "");
        const [mainEditDiff, setMainEditDiff] = useState(String(mainModalTile.difficulty || 1));
        const [mainEditReward, setMainEditReward] = useState(mainModalTile.rewardPowerupId || "");
        const [mainEditInstructions, setMainEditInstructions] = useState(mainModalTile.instructions || "");
        const [mainEditImage, setMainEditImage] = useState(mainModalTile.image || "");
        const [mainEditMaxCompletions, setMainEditMaxCompletions] = useState(String(mainModalTile.maxCompletions || 1));
        const [mainEditMinCompletions, setMainEditMinCompletions] = useState(String(mainModalTile.minCompletions || 1));

        useEffect(() => {
          const t = getRaceTile(game, ui.mainTileModalN);
          setMainEditLabel(t.label || "");
          setMainEditDiff(String(t.difficulty || 1));
          setMainEditReward(t.rewardPowerupId || "");
          setMainEditInstructions(t.instructions || "");
          setMainEditImage(t.image || "");
          setMainEditMaxCompletions(String(t.maxCompletions || 1));
          setMainEditMinCompletions(String(t.minCompletions || 1));
        }, [ui.mainTileModalN, ui.mainTileModalOpen]);

        // Pool task edit state
        const [poolEditId, setPoolEditId] = useState(null);
        const [poolEditLabel, setPoolEditLabel] = useState("");
        const [poolEditInstructions, setPoolEditInstructions] = useState("");
        const [poolEditImage, setPoolEditImage] = useState("");

        useEffect(() => {
          if (!poolEditId) return;
          const t = Object.values(game.taskPools || {}).flat().find((x) => x.id === poolEditId);
          if (!t) return;
          setPoolEditLabel(t.label || "");
          setPoolEditInstructions(t.instructions || "");
          setPoolEditImage(t.image || "");
        }, [poolEditId]);

        const completeTeam = (game.teams || []).find((t) => t.id === ui.completePickerTeamId) || null;

        // Power tile modal edit fields
        const powerModalTile = (game.powerupTiles || []).find((t) => t.id === ui.powerTileModalId) || null;
        const [powerEditLabel, setPowerEditLabel] = useState("");
        const [powerEditReward, setPowerEditReward] = useState("");
        const [powerEditInstructions, setPowerEditInstructions] = useState("");
        const [powerEditImage, setPowerEditImage] = useState("");
        const [powerEditPoints, setPowerEditPoints] = useState(1);
        const [powerEditMaxComp, setPowerEditMaxComp] = useState(1);
        const [powerEditMinComp, setPowerEditMinComp] = useState(1);
        const [powerEditClaimType, setPowerEditClaimType] = useState("eachTeam");

        useEffect(() => {
          if (!powerModalTile) return;
          setPowerEditLabel(powerModalTile.label || "");
          setPowerEditReward(powerModalTile.rewardPowerupId || "");
          setPowerEditInstructions(powerModalTile.instructions || "");
          setPowerEditImage(powerModalTile.image || "");
          setPowerEditPoints(powerModalTile.pointsPerCompletion || 1);
          setPowerEditMaxComp(powerModalTile.maxCompletions || 1);
          setPowerEditMinComp(powerModalTile.minCompletions || 1);
          setPowerEditClaimType(powerModalTile.claimType || "eachTeam");
        }, [ui.powerTileModalId, ui.powerTileModalOpen]);

        // ===== render helpers
        function shortDot(bgClass) {
          return <span className={`inline-block h-3 w-3 rounded-full ${bgClass}`} />;
        }

        function renderMarkersAt(tileNumber) {
          const at = teams.filter((t) => t.pos === tileNumber);
          if (at.length === 0) return null;

          // Scale markers down as more teams share the tile so they all fit nicely
          let markerHeight = "h-5";
          let padding = "px-2 py-0.5";
          let textSize = "text-[10px]";
          
          if (at.length === 2) {
            markerHeight = "h-4";
            padding = "px-1.5 py-0.5";
            textSize = "text-[9px]";
          } else if (at.length === 3) {
            markerHeight = "h-3.5";
            padding = "px-1.5 py-0.5";
            textSize = "text-[8px]";
          }

          // For 3 teams: pyramid layout with 1 centered on top, 2 on bottom
          if (at.length === 3) {
            return (
              <div className="absolute bottom-3 left-1 z-10 flex flex-col gap-0.5 items-start">
                <div
                  className={`flex items-center justify-center rounded-full text-white font-semibold ${at[2].color} ${markerHeight} ${padding} ${textSize} flex-shrink-0`}
                  title={at[2].name}
                >
                  {at[2].name}
                </div>
                <div
                  className={`flex items-center justify-center rounded-full text-white font-semibold ${at[0].color} ${markerHeight} ${padding} ${textSize} flex-shrink-0`}
                  title={at[0].name}
                >
                  {at[0].name}
                </div>
                <div
                  className={`flex items-center justify-center rounded-full text-white font-semibold ${at[1].color} ${markerHeight} ${padding} ${textSize} flex-shrink-0`}
                  title={at[1].name}
                >
                  {at[1].name}
                </div>
              </div>
            );
          }

          // For 1-2 teams: vertical stacking
          return (
            <div className="absolute bottom-3 left-1 z-10 flex flex-col gap-0.5 items-start">
              {at.map((t) => (
                <div
                  key={t.id}
                  className={`flex items-center justify-center rounded-full text-white font-semibold ${t.color} ${markerHeight} ${padding} ${textSize} flex-shrink-0`}
                  title={t.name}
                >
                  {t.name}
                </div>
              ))}
            </div>
          );
        }

        function renderRaceTileBadges(n) {
          const badges = [];
          for (const t of teams) {
            if ((t.preCleared || []).includes(n)) {
              badges.push(
                <span key={`pre-${t.id}`} className={`inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-[10px] ${
                  ui.darkMode ? 'border-slate-600 bg-slate-800/90 text-slate-200' : 'border-slate-300 bg-slate-100/90 text-slate-700'
                }`}>
                  {shortDot(t.color)} pre-cleared
                </span>
              );
            }
            if ((t.copyChoice || []).some((x) => x.tile === n)) {
              badges.push(
                <span key={`copy-${t.id}`} className={`inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-[10px] ${
                  ui.darkMode ? 'border-slate-600 bg-slate-800/90 text-slate-200' : 'border-slate-300 bg-slate-100/90 text-slate-700'
                }`}>
                  {shortDot(t.color)} copy-choice
                </span>
              );
            }
          }
          if (changedTiles.has(n)) {
            badges.push(
              <span key={`changed-${n}`} className={`inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-[10px] ${
                ui.darkMode ? 'border-slate-600 bg-slate-800/90 text-slate-200' : 'border-slate-300 bg-slate-100/90 text-slate-700'
              }`}>
                <span className={`inline-block h-2 w-2 rounded-full ${ui.darkMode ? 'bg-slate-900' : 'bg-slate-200'}`} /> changed
              </span>
            );
          }
          if (doubledTiles.has(n)) {
            badges.push(
              <span key={`doubled-${n}`} className={`inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-[10px] ${
                ui.darkMode ? 'border-orange-600 bg-orange-900/90 text-orange-200' : 'border-orange-400 bg-orange-100/90 text-orange-800'
              }`}>
                <span className={`inline-block h-2 w-2 rounded-full ${ui.darkMode ? 'bg-orange-700' : 'bg-orange-500'}`} /> doubled
              </span>
            );
          }
          if (badges.length === 0) return null;
          return <div className="absolute bottom-[33%] right-1 flex flex-col items-end gap-1">{badges}</div>;
        }

        // ===== draft modal helpers (UI-only)
        function openDraft() {
          setUi((u) => ({ ...u, draftOpen: true }));
          setDraft((d) => ({ ...d, step: "setup" }));
        }

        function startDraftFromSetup() {
          const players = draft.playersText
            .split("\n")
            .map((x) => x.trim())
            .filter(Boolean);

          const teamNames = draft.teamsText
            .split("\n")
            .map((x) => x.trim())
            .filter(Boolean);

          if (players.length < 2 || teamNames.length < 2) return;

          // Ensure captains are selected; if missing, auto-assign from first players
          let captains = { ...draft.captains };
          const usedCaps = new Set(Object.values(captains).filter(Boolean));
          let remainingForCaps = players.filter((p) => !usedCaps.has(p));

          for (const tn of teamNames) {
            if (!captains[tn]) {
              const auto = remainingForCaps.shift();
              captains[tn] = auto || "";
            }
          }

          // Remove captains from available pool
          const capSet = new Set(Object.values(captains).filter(Boolean));
          const available = players.filter((p) => !capSet.has(p));

          // Initialize picks with captains included
          const picks = {};
          for (const tn of teamNames) {
            picks[tn] = captains[tn] ? [captains[tn]] : [];
          }

          setDraft((d) => ({
            ...d,
            step: "picking",
            captains,
            available,
            order: teamNames,
            pickIndex: 0,
            picks,
          }));
        }

        function currentDraftTeam() {
          if (!draft.order.length) return "";
          return draft.order[draft.pickIndex % draft.order.length];
        }

        function draftPick(playerName) {
          const tn = currentDraftTeam();
          if (!tn) return;

          setDraft((d) => {
            const available = d.available.filter((p) => p !== playerName);
            const picks = { ...d.picks, [tn]: [...(d.picks[tn] || []), playerName] };
            const nextPickIndex = d.pickIndex + 1;
            const step = available.length === 0 ? "stealing" : d.step;
            
            // Snapshot original teams when entering steal phase
            let originalTeams = d.originalTeams;
            if (step === "stealing" && Object.keys(d.originalTeams).length === 0) {
              originalTeams = {};
              d.order.forEach((teamName) => {
                (picks[teamName] || []).forEach((p) => {
                  originalTeams[p] = teamName;
                });
              });
            }
            
            return { ...d, available, picks, pickIndex: nextPickIndex, step, originalTeams };
          });
        }

        function currentStealTeam() {
          if (!draft.order.length) return "";
          return draft.order[draft.stealIndex % draft.order.length];
        }

        function stealPlayer(fromTeam, playerName) {
          const toTeam = currentStealTeam();
          if (!toTeam || fromTeam === toTeam) return;

          setDraft((d) => {
            // Remove player from source team
            const picks = { ...d.picks };
            picks[fromTeam] = (picks[fromTeam] || []).filter((p) => p !== playerName);
            // Add player to stealing team
            picks[toTeam] = [...(picks[toTeam] || []), playerName];
            
            // Mark this team as having used their steal
            const stealsUsed = { ...d.stealsUsed, [toTeam]: true };
            const stolenFrom = { ...d.stolenFrom, [fromTeam]: true };
            const lastStolenBy = { ...d.lastStolenBy, [fromTeam]: toTeam };
            const nextStealIndex = d.stealIndex + 1;
            
            // Check if all teams have used their steal or skipped
            const allDone = d.order.every((tn) => stealsUsed[tn]);
            const step = allDone ? "summary" : d.step;
            
            return { ...d, picks, stealsUsed, stolenFrom, lastStolenBy, stealIndex: nextStealIndex, step };
          });
        }

        function skipSteal() {
          const toTeam = currentStealTeam();
          setDraft((d) => {
            const stealsUsed = { ...d.stealsUsed, [toTeam]: true };
            const nextStealIndex = d.stealIndex + 1;
            
            // Check if all teams have used their steal or skipped
            const allDone = d.order.every((tn) => stealsUsed[tn]);
            const step = allDone ? "summary" : d.step;
            
            return { ...d, stealsUsed, stealIndex: nextStealIndex, step };
          });
        }

        function applyDraftToGame() {
          if (!checkAdminAuth()) {
            alert('Admin authentication required to apply draft.');
            return;
          }
          const teamNames = draft.order.length ? draft.order : draft.teamsText.split("\n").map((x) => x.trim()).filter(Boolean);
          const payloadTeams = teamNames.map((name) => ({
            name,
            captain: draft.captains[name] || "",
            members: draft.picks[name] || [],
          }));
          dispatch({ type: "ADMIN_APPLY_DRAFT_TEAMS", teams: payloadTeams, adminName: auth.adminName });
          setUi((u) => ({ ...u, draftOpen: false }));
        }

        function renderEventLogEntry(message) {
          // Identify primary team color from first team mentioned
          let primaryColor = null;
          const teamNames = (teams || []).map((t) => t.name);

          // Fast path: no teams yet ? just render text
          if (!teamNames.length) {
            return <div className={`rounded-lg p-2 text-xs leading-relaxed ${ui.darkMode ? 'bg-slate-800 text-slate-300' : 'bg-slate-100 text-slate-700'}`}>{message}</div>;
          }
          
          for (const tName of teamNames) {
            if (message.includes(tName)) {
              const team = teams.find((t) => t.name === tName);
              if (team && !primaryColor) {
                primaryColor = team.color;
                break;
              }
            }
          }

          // Build parts: plain text and team badges
          const parts = [];
          let lastIdx = 0;
          const regex = new RegExp(`(${teamNames.map((n) => n.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")).join("|")})`, "g");
          let match;
          
          while ((match = regex.exec(message)) !== null) {
            if (match.index > lastIdx) {
              parts.push(message.substring(lastIdx, match.index));
            }
            const tName = match[0];
            const team = teams.find((t) => t.name === tName);
            if (team) {
              parts.push(
                <span key={`badge-${match.index}`} className={`inline-flex items-center gap-0.5 rounded-full px-2 py-0.5 text-[10px] text-white font-semibold ${team.color}`}>
                  ?{tName}
                </span>
              );
            } else {
              parts.push(tName);
            }
            lastIdx = match.index + match[0].length;
          }
          if (lastIdx < message.length) {
            parts.push(message.substring(lastIdx));
          }

          return (
            <div className={`rounded-lg p-2 text-xs leading-relaxed ${
              primaryColor 
                ? primaryColor + (ui.darkMode ? "/30 text-slate-100" : "/20 text-slate-800")
                : ui.darkMode ? "bg-slate-800 text-slate-300" : "bg-slate-100 text-slate-700"
            }`}>
              {parts}
            </div>
          );
        }

        // Show loading screen
        if (isLoading) {
          return (
            <div className="min-h-screen flex items-center justify-center bg-slate-900">
              <div className="text-center">
                <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-white mx-auto mb-4"></div>
                <p className="text-white text-lg">Loading game state...</p>
                <p className="text-slate-400 text-sm mt-2">
                  {isFirebaseEnabled ? 'Connecting to Firebase...' : 'Loading from local storage...'}
                </p>
              </div>
            </div>
          );
        }

        return (
          <div className={`min-h-screen p-4 ${ui.darkMode ? 'bg-slate-900 text-slate-100' : 'bg-slate-50 text-slate-900'}`}>
            {/* Connection Status Banner */}
            {isFirebaseEnabled && (
              <div className="fixed top-0 left-0 right-0 z-50 bg-green-600 text-white text-center py-1 text-sm">
                ?? Real-time sync enabled - Everyone sees the same game state
              </div>
            )}
            {!isFirebaseEnabled && (
              <div className="fixed top-0 left-0 right-0 z-50 bg-orange-600 text-white text-center py-1 text-sm">
                ?? Local mode - Changes only saved on this device
              </div>
            )}
            
            <div className={`mx-auto ${isFirebaseEnabled || !isFirebaseEnabled ? 'pt-8' : ''}`}>
              <header className="mb-4 flex flex-col gap-2 md:flex-row md:items-end md:justify-between">
                <div>
                  <h1 className="text-2xl font-bold">Rawbellion CC Christmas Tile Race</h1>
                </div>

                <div className="flex items-center gap-3">
                  <button
                    onClick={() => setUi((u) => ({ ...u, showPlayerPoints: !u.showPlayerPoints }))}
                    className={`rounded-xl border px-3 py-2 text-sm shadow-sm ${
                      ui.darkMode 
                        ? 'border-slate-700 bg-slate-800 hover:bg-slate-700 text-slate-100' 
                        : 'border-slate-300 bg-white hover:bg-slate-100 text-slate-900'
                    }`}
                    title="Toggle player points"
                  >
                    📊
                  </button>

                  <button
                    onClick={() => setUi((u) => ({ ...u, darkMode: !u.darkMode }))}
                    className={`rounded-xl border px-3 py-2 text-sm shadow-sm ${
                      ui.darkMode 
                        ? 'border-slate-700 bg-slate-800 hover:bg-slate-700 text-slate-100' 
                        : 'border-slate-300 bg-white hover:bg-slate-100 text-slate-900'
                    }`}
                    title="Toggle theme"
                  >
                    {ui.darkMode ? '🌙' : '☀️'}
                  </button>

                  {/* Authentication UI */}
                  {auth.isAdmin || auth.loggedInAs ? (
                    <div className="flex items-center gap-2">
                      <span className={`text-xs ${textMuted(ui.darkMode)}`}>
                        {auth.isAdmin ? `👤 ${auth.adminName || 'Admin'}` : `🏆 ${currentTeam?.name || 'Team'}`}
                      </span>
                      <button
                        onClick={logout}
                        className={`rounded-xl border px-3 py-2 text-sm shadow-sm ${
                          ui.darkMode 
                            ? 'border-slate-700 bg-slate-800 hover:bg-slate-700 text-slate-100' 
                            : 'border-slate-300 bg-white hover:bg-slate-100 text-slate-900'
                        }`}
                      >
                        Logout
                      </button>
                    </div>
                  ) : (
                    <button
                      onClick={() => setUi((u) => ({ ...u, loginModalOpen: true }))}
                      className={`rounded-xl border px-3 py-2 text-sm shadow-sm ${
                        ui.darkMode 
                          ? 'border-slate-700 bg-slate-800 hover:bg-slate-700 text-slate-100' 
                          : 'border-slate-300 bg-white hover:bg-slate-100 text-slate-900'
                      }`}
                    >
                      🔑 Login
                    </button>
                  )}

                  {auth.isAdmin && (
                    <div className="relative">
                      <button 
                        onClick={() => setUi((u) => ({ ...u, optionsMenuOpen: !u.optionsMenuOpen }))}
                        className={`rounded-xl border px-3 py-2 text-sm shadow-sm ${
                          ui.darkMode 
                            ? 'border-slate-700 bg-slate-800 hover:bg-slate-700 text-slate-100' 
                            : 'border-slate-300 bg-white hover:bg-slate-100 text-slate-900'
                        }`}
                      >
                        ?? Options
                      </button>
                      
                      {ui.optionsMenuOpen && (
                        <div className={`absolute right-0 top-full mt-2 z-50 w-56 rounded-xl border shadow-lg ${
                          ui.darkMode 
                            ? 'border-slate-700 bg-slate-800' 
                            : 'border-slate-200 bg-white'
                        }`}>
                          <button
                            onClick={() => {
                              setUi((u) => ({ ...u, optionsMenuOpen: false }));
                              openDraft();
                            }}
                            className={`w-full px-4 py-3 text-left text-sm border-b ${
                              ui.darkMode 
                                ? 'hover:bg-slate-700 text-slate-100 border-slate-700' 
                                : 'hover:bg-slate-50 text-slate-900 border-slate-200'
                            }`}
                          >
                            ?? Form teams
                          </button>

                          <button
                            onClick={() => {
                              setUi((u) => ({ ...u, optionsMenuOpen: false, importTasksOpen: true }));
                            }}
                            className={`w-full px-4 py-3 text-left text-sm border-b ${
                              ui.darkMode 
                                ? 'hover:bg-slate-700 text-slate-100 border-slate-700' 
                                : 'hover:bg-slate-50 text-slate-900 border-slate-200'
                            }`}
                          >
                            ?? Import tasks
                          </button>

                          <button
                            onClick={() => {
                              setUi((u) => ({ ...u, optionsMenuOpen: false, importPowerupsOpen: true }));
                            }}
                            className={`w-full px-4 py-3 text-left text-sm border-b ${
                              ui.darkMode 
                                ? 'hover:bg-slate-700 text-slate-100 border-slate-700' 
                                : 'hover:bg-slate-50 text-slate-900 border-slate-200'
                            }`}
                          >
                            ?? Import powerups
                          </button>

                          <button
                            onClick={() => {
                              setUi((u) => ({ ...u, optionsMenuOpen: false, gradientSettingsOpen: true }));
                            }}
                            className={`w-full px-4 py-3 text-left text-sm border-b ${
                              ui.darkMode 
                                ? 'hover:bg-slate-700 text-slate-100 border-slate-700' 
                                : 'hover:bg-slate-50 text-slate-900 border-slate-200'
                            }`}
                          >
                            ?? Gradient settings
                          </button>

                          <button
                            onClick={() => {
                              setUi((u) => ({ ...u, optionsMenuOpen: false }));
                              if (!checkAdminAuth()) {
                                alert('Admin authentication required.');
                                return;
                              }
                              if (confirm("Randomize tile difficulties? This will reassign difficulty levels to all tiles.")) {
                                const payload = ui.gradientEnabled
                                  ? { gradient: true, early: { easy: ui.earlyEasy, medium: ui.earlyMedium, hard: ui.earlyHard }, late: { easy: ui.lateEasy, medium: ui.lateMedium, hard: ui.lateHard } }
                                  : { weights: { easy: ui.weightEasy, medium: ui.weightMedium, hard: ui.weightHard } };
                                dispatch({ type: "ADMIN_RANDOMIZE_DIFFICULTIES", ...payload, adminName: auth.adminName });
                              }
                            }}
                            className={`w-full px-4 py-3 text-left text-sm border-b ${
                              ui.darkMode 
                                ? 'hover:bg-slate-700 text-slate-100 border-slate-700' 
                                : 'hover:bg-slate-50 text-slate-900 border-slate-200'
                            }`}
                          >
                            ?? Randomize difficulties
                          </button>

                          {checkMasterAdmin() && (
                            <>
                              <button
                                onClick={() => {
                                  setUi((u) => ({ ...u, fogOfWarOverride: !u.fogOfWarOverride }));
                                }}
                                className={`w-full px-4 py-3 text-left text-sm border-b ${
                                  ui.darkMode 
                                    ? 'hover:bg-slate-700 text-slate-100 border-slate-700' 
                                    : 'hover:bg-slate-50 text-slate-900 border-slate-200'
                                }`}
                              >
                                {ui.fogOfWarOverride ? '?? Enable Fog of War' : '??? Disable Fog of War (Testing)'}
                              </button>
                              
                              <button
                                onClick={() => {
                                  const now = Date.now();
                                  const today = new Date().toDateString();
                                  const MAX_BACKUPS_PER_DAY = 10;
                                  
                                  // Reset counter if it's a new day
                                  if (ui.backupDay !== today) {
                                    setUi((u) => ({ ...u, backupCount: 0, backupDay: today }));
                                  }
                                  
                                  if (ui.backupDay === today && ui.backupCount >= MAX_BACKUPS_PER_DAY) {
                                    alert(`Maximum ${MAX_BACKUPS_PER_DAY} backups per day reached. Try again tomorrow.`);
                                    return;
                                  }
                                  
                                  const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                                  const backup = {
                                    exportDate: new Date().toISOString(),
                                    gameState: {
                                      raceTiles: game.raceTiles,
                                      powerupTiles: game.powerupTiles,
                                      taskPools: game.taskPools,
                                      usedPoolTaskIds: game.usedPoolTaskIds,
                                      changedTiles: game.changedTiles,
                                      doubledTiles: game.doubledTiles,
                                      doubledTilesInfo: game.doubledTilesInfo,
                                      revealedTiles: game.revealedTiles,
                                      teams: game.teams,
                                      playerPoints: game.playerPoints,
                                      log: game.log,
                                    },
                                    metadata: {
                                      maxTile: MAX_TILE,
                                      version: "1.0",
                                      note: "Full game state backup - can be restored via 'Restore Game Backup' button"
                                    }
                                  };
                                  
                                  const json = JSON.stringify(backup, null, 2);
                                  const blob = new Blob([json], { type: 'application/json' });
                                  const url = URL.createObjectURL(blob);
                                  const a = document.createElement('a');
                                  a.href = url;
                                  a.download = `tile-race-backup-${timestamp}.json`;
                                  a.click();
                                  URL.revokeObjectURL(url);
                                  
                                  const newCount = ui.backupDay === today ? ui.backupCount + 1 : 1;
                                  setUi((u) => ({ ...u, optionsMenuOpen: false, lastBackupTime: now, backupCount: newCount, backupDay: today }));
                                  alert(`Game backup downloaded! (${newCount}/${MAX_BACKUPS_PER_DAY} backups today)`);
                                }}
                                className={`w-full px-4 py-3 text-left text-sm border-b ${
                                  ui.darkMode 
                                    ? 'hover:bg-slate-700 text-slate-100 border-slate-700' 
                                    : 'hover:bg-slate-50 text-slate-900 border-slate-200'
                                }`}
                              >
                                ?? Download Game Backup
                              </button>
                              
                              <button
                                onClick={() => {
                                  if (!confirm('?? WARNING: Restoring a backup will completely replace the current game state!\n\nBefore proceeding:\n1. Make a backup of the current state if needed\n2. If using Firebase, this may cause conflicts with live data\n3. Consider clearing Firebase data first for clean restore\n\nRecommendation: Only use this for disaster recovery, not during active gameplay.\n\nContinue with restore?')) {
                                    return;
                                  }
                                  
                                  const input = document.createElement('input');
                                  input.type = 'file';
                                  input.accept = '.json';
                                  input.onchange = async (e) => {
                                    const file = e.target.files[0];
                                    if (!file) return;
                                    
                                    try {
                                      const text = await file.text();
                                      const backup = JSON.parse(text);
                                      
                                      if (!backup.gameState) {
                                        alert('Invalid backup file format: missing gameState.');
                                        return;
                                      }
                                      
                                      if (!confirm(`Restore game from backup dated ${backup.exportDate}?\n\nThis is your last chance to cancel!`)) {
                                        return;
                                      }
                                      
                                      // Build restored state with all required fields
                                      const restored = {
                                        raceTiles: backup.gameState.raceTiles || game.raceTiles,
                                        powerupTiles: backup.gameState.powerupTiles || game.powerupTiles,
                                        taskPools: backup.gameState.taskPools || { 1: [], 2: [], 3: [] },
                                        usedPoolTaskIds: backup.gameState.usedPoolTaskIds || [],
                                        changedTiles: backup.gameState.changedTiles || [],
                                        doubledTiles: backup.gameState.doubledTiles || [],
                                        doubledTilesInfo: backup.gameState.doubledTilesInfo || {},
                                        revealedTiles: backup.gameState.revealedTiles || [1, 2, 3, 4, 5, 6, 7, 8],
                                        teams: backup.gameState.teams || [],
                                        playerPoints: backup.gameState.playerPoints || {},
                                        log: backup.gameState.log || [],
                                        admins: game.admins, // Keep existing admins
                                      };
                                      
                                      // Clear history to prevent undo issues
                                      setHistory([]);
                                      
                                      // Apply the restored state
                                      setGame(restored);
                                      
                                      setUi((u) => ({ ...u, optionsMenuOpen: false }));
                                      
                                      setTimeout(() => {
                                        alert(`? Game restored from backup dated ${backup.exportDate}.\n\nIMPORTANT:\n- If using Firebase, this restore is LOCAL only\n- Reload the page to see if Firebase overwrites this\n- Consider clearing Firebase and re-uploading if needed\n- Teams: ${restored.teams.length}\n- Race Tiles: ${restored.raceTiles.length}`);
                                      }, 100);
                                      
                                    } catch (err) {
                                      console.error('[RESTORE] Error:', err);
                                      alert(`? Failed to restore backup:\n\n${err.message}\n\nCheck console for details.`);
                                    }
                                  };
                                  input.click();
                                }}
                                className={`w-full px-4 py-3 text-left text-sm border-b ${
                                  ui.darkMode 
                                    ? 'hover:bg-slate-700 text-slate-100 border-slate-700' 
                                    : 'hover:bg-slate-50 text-slate-900 border-slate-200'
                                }`}
                              >
                                ?? Restore Game Backup
                              </button>
                              
                              <button
                                onClick={() => {
                                  setUi((u) => ({ ...u, optionsMenuOpen: false, adminManagementOpen: true }));
                                }}
                                className={`w-full px-4 py-3 text-left text-sm border-b ${
                                  ui.darkMode 
                                    ? 'hover:bg-slate-700 text-slate-100 border-slate-700' 
                                    : 'hover:bg-slate-50 text-slate-900 border-slate-200'
                                }`}
                              >
                                ?? Manage Admins
                              </button>
                            </>
                          )}

                          <button
                            onClick={() => {
                              setUi((u) => ({ ...u, optionsMenuOpen: false, changeMyPasswordOpen: true }));
                            }}
                            className={`w-full px-4 py-3 text-left text-sm border-b ${
                              ui.darkMode 
                                ? 'hover:bg-slate-700 text-slate-100 border-slate-700' 
                                : 'hover:bg-slate-50 text-slate-900 border-slate-200'
                            }`}
                          >
                            ?? Change Password
                          </button>

                          <button
                            onClick={() => {
                              setUi((u) => ({ ...u, optionsMenuOpen: false, passwordSetupOpen: true }));
                            }}
                            className={`w-full px-4 py-3 text-left text-sm border-b ${
                              ui.darkMode 
                                ? 'hover:bg-slate-700 text-slate-100 border-slate-700' 
                                : 'hover:bg-slate-50 text-slate-900 border-slate-200'
                            }`}
                          >
                            ?? Set Team Passwords
                          </button>

                          <button
                            onClick={() => {
                              if (history.length > 0 && confirm("Undo the last action? This will restore the previous game state.")) {
                                undoLastAction();
                              }
                              setUi((u) => ({ ...u, optionsMenuOpen: false }));
                            }}
                            disabled={history.length === 0}
                            className={`w-full px-4 py-3 text-left text-sm border-b ${
                              history.length === 0
                                ? ui.darkMode 
                                  ? 'text-slate-600 cursor-not-allowed border-slate-700' 
                                  : 'text-slate-400 cursor-not-allowed border-slate-200'
                                : ui.darkMode 
                                  ? 'hover:bg-slate-700 text-slate-100 border-slate-700' 
                                  : 'hover:bg-slate-50 text-slate-900 border-slate-200'
                            }`}
                            title={history.length === 0 ? "No actions to undo" : `Undo last action (${history.length} in history)`}
                          >
                            ? Undo
                          </button>
                          
                          <button
                            onClick={() => {
                              setUi((u) => ({ ...u, optionsMenuOpen: false }));
                              onReset();
                            }}
                            className={`w-full px-4 py-3 text-left text-sm rounded-b-xl ${
                              ui.darkMode 
                                ? 'hover:bg-slate-700 text-slate-100' 
                                : 'hover:bg-slate-50 text-slate-900'
                            }`}
                          >
                            ??? Reset all
                          </button>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </header>

              <div className={`grid grid-cols-1 gap-4 ${
                ui.showPlayerPoints 
                  ? 'lg:grid-cols-[280px_minmax(0,1fr)_240px_340px]' 
                  : 'lg:grid-cols-[280px_minmax(0,1fr)_340px]'
              }`}>
                {/* Teams */}
                <div className={`rounded-2xl border p-4 shadow-sm ${
                  ui.darkMode ? 'border-slate-700 bg-slate-800' : 'border-slate-200 bg-white'
                }`}>
                  <h2 className="text-lg font-semibold">Teams</h2>

                      {auth.isAdmin && (
                        <div className="mt-3 flex gap-2">
                          <input
                            value={ui.newTeamName || ''}
                            onChange={(e) => setUi((u) => ({ ...u, newTeamName: e.target.value }))}
                            onKeyDown={(e) => (e.key === "Enter" ? onAddTeam() : null)}
                            placeholder="Team name"
                            className={inputClass(ui.darkMode, "w-full outline-none focus:ring-2")}
                        />
                        <button onClick={onAddTeam} className={btnClass("primary", ui.darkMode)}>
                          Add
                        </button>
                        </div>
                      )}

                  {teams.length === 0 ? (
                    <p className="mt-4 text-sm text-slate-400">Add at least one team to begin.</p>
                  ) : (
                    <div className="mt-4 space-y-2">
                      {sortedTeams.map((t) => {
                        const pct = progressPct(t.pos);
                        const hasCopyHere = (t.copyChoice || []).some((x) => x.tile === t.pos);
                        return (
                          <div key={t.id} className={`relative rounded-2xl border p-3 ${
                            ui.darkMode ? 'border-slate-700 bg-slate-800' : 'border-slate-300 bg-slate-100/95'
                          }`}>
                            <div className={`absolute top-2 right-2 rounded-full px-2 py-0.5 text-xs font-bold ${
                              ui.darkMode ? 'bg-slate-700 text-slate-200' : 'bg-slate-200 text-slate-700'
                            }`}>
                              #{t.pos}
                            </div>
                            <div className="flex items-start justify-between gap-2">
                              <div className="text-left">
                                <div className="flex items-center gap-2">
                                  <div>
                                    <div className="font-semibold">{t.name}</div>
                                    <div className={`mt-1 h-1 w-12 rounded-full ${t.color}`} />
                                    {(t.captain || (t.members || []).length) ? (
                                      <div className="mt-2 flex flex-wrap gap-2">
                                        {(t.members || []).length ? (
                                          (t.members || []).map((m, idx) => (
                                            <div key={idx} className="text-xs">
                                              {m === t.captain ? (
                                                <span className={`rounded-full px-2 py-0.5 text-[11px] font-semibold ${ui.darkMode ? 'bg-slate-600 text-slate-100' : 'bg-slate-700 text-white'}`}>{m}</span>
                                              ) : (
                                                <span className={`rounded-full px-2 py-0.5 text-[11px] ${ui.darkMode ? 'bg-slate-600 text-slate-100' : 'bg-slate-700 text-white'}`}>{m}</span>
                                              )}
                                            </div>
                                          ))
                                        ) : (
                                          <span className="text-xs text-slate-400">No members.</span>
                                        )}
                                      </div>
                                    ) : null}
                                    <div className={`mt-3 text-sm font-medium ${ui.darkMode ? 'text-slate-200' : 'text-slate-700'}`}>
                                      {tileLabel(game, t.pos)}
                                    </div>
                                  </div>
                                </div>
                              </div>

                              <div className="flex items-center gap-2">
                                {auth.isAdmin && (
                                  <button onClick={() => setUi((u) => ({ ...u, editTeamId: t.id }))} className={`rounded-xl border px-2 py-1 text-xs ${
                                    ui.darkMode 
                                      ? 'border-slate-700 bg-slate-800 hover:bg-slate-700 text-slate-100' 
                                      : 'border-slate-300 bg-white hover:bg-slate-100 text-slate-900'
                                  }`}>
                                    Edit
                                  </button>
                                )}
                                {auth.isAdmin && (
                                  <button onClick={() => dispatch({ type: "REMOVE_TEAM", teamId: t.id })} className={`rounded-xl border px-2 py-1 text-xs ${
                                    ui.darkMode 
                                      ? 'border-slate-700 bg-slate-800 hover:bg-slate-700 text-slate-100' 
                                      : 'border-slate-300 bg-white hover:bg-slate-100 text-slate-900'
                                  }`}>
                                    Remove
                                  </button>
                                )}
                              </div>
                            </div>

                            <div className="mt-3">
                              <div className={`flex items-center justify-between text-[11px] ${ui.darkMode ? 'text-slate-300' : 'text-slate-600'}`}>
                                <span>Progress</span>
                                <span>{Math.round(pct)}%</span>
                              </div>
                              <div className={`mt-1 h-2 w-full rounded-full ${
                                ui.darkMode ? 'bg-slate-700' : 'bg-slate-200'
                              }`}>
                                <div className="h-2 rounded-full bg-emerald-500" style={{ width: `${pct}%` }} />
                              </div>
                            </div>

                            {checkTeamAuth(t.id) && (
                              <div className="mt-3 space-y-2">
                                <button onClick={() => setUi((u) => ({ ...u, completePickerTeamId: t.id, completePickerPlayers: [] }))} className={`w-full rounded-xl px-3 py-2 text-xs font-semibold ${
                                  ui.darkMode 
                                    ? 'bg-slate-900 text-white hover:bg-slate-800' 
                                    : 'bg-slate-700 text-white hover:bg-slate-600'
                                }`}>
                                  Complete tile
                                </button>

                                <div className="flex gap-2">
                                  <button
                                    onClick={() => setUi((u) => ({ ...u, claimTeamId: t.id }))}
                                    className={`flex-1 rounded-xl border px-3 py-2 text-xs disabled:opacity-50 ${
                                      ui.darkMode 
                                        ? 'border-slate-700 bg-slate-800 hover:bg-slate-700 text-slate-100' 
                                        : 'border-slate-300 bg-white hover:bg-slate-100 text-slate-900'
                                    }`}
                                    disabled={(game.powerupTiles || []).length === 0}
                                  >
                                    Claim powerup
                                  </button>

                                  {t.powerupCooldown ? (
                                    <div className={`flex-1 rounded-xl border px-2 py-2 text-xs ${
                                      ui.darkMode 
                                        ? 'border-red-700 bg-red-900/30 text-red-300' 
                                        : 'border-red-300 bg-red-50 text-red-700'
                                    }`}>
                                      <div className="text-center">
                                        ?? Cooldown
                                        {(t.inventory || []).includes("clearCooldown") && (
                                          <button
                                            onClick={() => {
                                              if (!checkTeamAuth(t.id)) {
                                                alert('You must be logged in as this team to use powerups.');
                                                return;
                                              }
                                              if (confirm("Use Clear Cooldown powerup to remove your cooldown? This will consume 1 powerup.")) {
                                                dispatch({
                                                  type: "USE_POWERUP",
                                                  teamId: t.id,
                                                  powerupId: "clearCooldown",
                                                });
                                              }
                                            }}
                                            className={`mt-1 w-full rounded px-2 py-1 text-[10px] font-bold transition ${
                                              ui.darkMode 
                                                ? 'bg-green-700 border border-green-500 text-white hover:bg-green-600' 
                                                : 'bg-green-600 border border-green-500 text-white hover:bg-green-700'
                                            }`}
                                          >
                                            Clear
                                          </button>
                                        )}
                                      </div>
                                    </div>
                                  ) : (
                                    <button
                                      onClick={() => setUi((u) => ({ ...u, usePowerupTeamId: t.id }))}
                                      className={`flex-1 rounded-xl border px-3 py-2 text-xs disabled:opacity-50 ${
                                        ui.darkMode 
                                          ? 'border-slate-700 bg-slate-800 hover:bg-slate-700 text-slate-100' 
                                          : 'border-slate-300 bg-white hover:bg-slate-100 text-slate-900'
                                      }`}
                                      disabled={(t.inventory || []).length === 0}
                                    >
                                      Use powerup
                                    </button>
                                  )}
                                </div>

                                {hasCopyHere && (
                                  <button onClick={() => dispatch({ type: "USE_COPY_CHOICE", teamId: t.id })} className={`w-full rounded-xl border px-3 py-2 text-xs ${
                                    ui.darkMode 
                                      ? 'border-slate-700 bg-slate-800 hover:bg-slate-700 text-slate-100' 
                                      : 'border-slate-300 bg-white hover:bg-slate-100 text-slate-900'
                                  }`}>
                                    Use copy-choice (+1)
                                  </button>
                                )}
                              </div>
                            )}

                            <div className={`mt-2 text-xs ${ui.darkMode ? 'text-slate-400' : 'text-slate-600'}`}>
                              Powerups stored: <b>{(t.inventory || []).length}</b>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>

                {/* Main Board */}
                <div className={`rounded-2xl border p-4 shadow-sm ${
                  ui.darkMode ? 'border-slate-700 bg-slate-800' : 'border-slate-200 bg-white'
                }`}>
                  <div className="flex items-center justify-between gap-3">
                    <div>
                      <h2 className="text-lg font-semibold">Main Race Board</h2>
                      <p className={`text-sm ${textMuted(ui.darkMode)}`}>Click tiles to view instructions {auth.isAdmin ? "(and edit)." : "."}</p>
                    </div>

                    <div className={`hidden sm:flex items-center gap-2 text-xs ${ui.darkMode ? 'text-slate-300' : 'text-slate-600'}`}>
                      <span className={`rounded-full px-2 py-1 border ${ui.darkMode ? 'bg-emerald-900/40 border-emerald-600 text-slate-100' : 'bg-emerald-200/80 border-emerald-500 text-slate-900'}`}>Easy</span>
                      <span className={`rounded-full px-2 py-1 border ${ui.darkMode ? 'bg-amber-900/40 border-amber-600 text-slate-100' : 'bg-amber-200/90 border-amber-500 text-slate-900'}`}>Medium</span>
                      <span className={`rounded-full px-2 py-1 border ${ui.darkMode ? 'bg-purple-900/40 border-purple-600 text-slate-100' : 'bg-purple-200/80 border-purple-500 text-slate-900'}`}>Hard</span>
                    </div>
                  </div>

                  <div className="mt-4 grid grid-cols-4 gap-3">
                    {serpentRows.flat().map((cell, idx) => {
                      if (!cell) return <div key={`p-${idx}`} className="h-28 w-full"></div>;
                      const tile = cell;
                      const isRevealed = revealedTiles.has(tile.n) || ui.fogOfWarOverride;
                      const canClick = isRevealed || auth.isMasterAdmin;
                      const tint = isRevealed ? diffTint(tile.difficulty, ui.darkMode) : (ui.darkMode ? 'border-slate-600 bg-slate-800' : 'border-slate-300 bg-slate-100');
                      const hasReward = !!tile.rewardPowerupId;
                      const teamsOnTile = teams.filter((t) => t.pos === tile.n).length;
                      const labelMargin = teamsOnTile === 3 ? '-mt-5' : '-mt-3';
                      const isFinalTile = tile.n === MAX_TILE;
                      const tileHeight = isFinalTile ? 'h-36' : 'h-28';
                      const textSize = isFinalTile ? 'text-sm' : 'text-xs';
                      const colSpan = isFinalTile ? 'col-span-4' : '';
                      return (
                        <button
                          key={tile.n}
                          onClick={() => canClick ? setUi((u) => ({ ...u, mainTileModalOpen: true, mainTileModalN: tile.n })) : null}
                          disabled={!canClick}
                          className={`relative ${tileHeight} w-full rounded-xl border p-3 pt-6 ${textSize} shadow-sm transition ${canClick ? 'hover:brightness-[0.98] cursor-pointer' : 'cursor-not-allowed'} ${tint} overflow-hidden ${colSpan}`}
                        >
                          <div className="flex items-center justify-center h-full -mt-2">
                            <div className={`absolute top-1 left-1 text-[10px] font-semibold ${ui.darkMode ? 'text-slate-200/90' : 'text-slate-700/90'}`}>{tile.n}</div>

                            {isRevealed ? (
                              <div className="flex flex-col items-center justify-center gap-2">
                                {tile.image ? (
                                  <div className="relative flex-shrink-0">
                                    <img src={tile.image} alt={`Image for ${tile.label}`} onError={imageOnError} className="h-16 w-16 rounded-md object-contain" />
                                  </div>
                                ) : null}
                                <div className={`text-[12px] font-bold line-clamp-2 break-words text-center ${ui.darkMode ? 'text-slate-100/90' : 'text-slate-900/90'}`}>{tile.label}</div>
                                {hasReward ? (
                                  <span className={`absolute top-1 right-1 rounded-full px-2 py-0.5 text-[10px] text-white ${ui.darkMode ? 'bg-slate-900' : 'bg-slate-800'}`}>PWR</span>
                                ) : null}
                              </div>
                            ) : (
                              <div className="flex flex-col items-center justify-center gap-1">
                                <div className={`text-6xl font-bold ${ui.darkMode ? 'text-slate-600' : 'text-slate-400'}`}>?</div>
                                {tile.n % 8 === 1 && tile.n > 8 && tile.n !== MAX_TILE ? (
                                  <div className={`text-[10px] font-semibold ${ui.darkMode ? 'text-slate-500' : 'text-slate-500'}`}>+8 vision</div>
                                ) : null}
                              </div>
                            )}
                          </div>
                          {renderMarkersAt(tile.n)}
                          {isRevealed ? renderRaceTileBadges(tile.n) : null}
                        </button>
                      );
                    })}
                  </div>
                </div>

                {/* Player Points Sidebar */}
                {ui.showPlayerPoints && (
                  <div className={`rounded-2xl border p-4 shadow-sm max-h-[calc(100vh-8rem)] overflow-y-auto ${
                    ui.darkMode ? 'border-slate-700 bg-slate-800 dark-scrollbar' : 'border-slate-200 bg-white'
                  }`}>
                  <div className="mb-4">
                    <div className="text-lg font-semibold">Player Points</div>
                    <div className={`mt-1 text-xs ${
                      ui.darkMode ? 'text-slate-400' : 'text-slate-600'
                    }`}>All competitors</div>
                  </div>

                  <div className="space-y-2">
                    {(() => {
                      const allPlayerPoints = game.playerPoints || {};
                      const map = {};
                      
                      // Collect all players from teams
                      (game.teams || []).forEach((t) => {
                        const names = new Set([...(t.members || []), t.captain].filter(Boolean));
                        names.forEach((n) => {
                          if (!map[n]) map[n] = { pts: 0, teams: new Set() };
                          map[n].teams.add(t.name);
                        });
                      });
                      
                      // Add points from global playerPoints
                      Object.entries(allPlayerPoints).forEach(([name, pts]) => {
                        if (!map[name]) map[name] = { pts: 0, teams: new Set() };
                        map[name].pts = pts;
                      });
                      
                      const rows = Object.entries(map).sort((a, b) => b[1].pts - a[1].pts);
                      if (rows.length === 0) return <div className={`text-sm ${
                        ui.darkMode ? 'text-slate-400' : 'text-slate-500'
                      }`}>No players yet</div>;
                      return rows.map(([name, info]) => (
                        <div key={name} className={`rounded-lg border px-3 py-2 ${
                          ui.darkMode ? 'border-slate-700 bg-slate-900' : 'border-slate-200 bg-slate-50'
                        }`}>
                          <div className="flex items-center justify-between">
                            <div className="font-medium text-sm">{name}</div>
                            <div className="text-sm font-semibold">{Math.round(info.pts * 100) / 100}</div>
                          </div>
                          <div className={`text-xs mt-1 ${
                            ui.darkMode ? 'text-slate-400' : 'text-slate-500'
                          }`}>{[...info.teams].join(", ")}</div>
                        </div>
                      ));
                    })()}
                  </div>
                </div>
                )}

                {/* Event Log */}
                <div className={`rounded-2xl border p-4 shadow-sm ${
                  ui.darkMode ? 'border-slate-700 bg-slate-900' : 'border-slate-200 bg-white'
                }`}>
                  <h2 className="text-lg font-semibold">Event Log</h2>
                  <div className={`mt-3 max-h-[720px] overflow-auto rounded-xl border p-3 ${
                    ui.darkMode ? 'border-slate-900 bg-slate-950 dark-scrollbar' : 'border-slate-200 bg-slate-50'
                  }`}>
                    {(game.log || []).length === 0 ? (
                      <div className={`text-sm ${textMuted(ui.darkMode)}`}>No actions yet.</div>
                    ) : (
                      <ul className="space-y-2">
                        {game.log.map((l) => (
                          <li key={l.id}>
                            <span className={`text-[10px] ${ui.darkMode ? 'text-slate-400' : 'text-slate-500'}`}>{new Date(l.ts).toLocaleString()} ? </span>
                            {renderEventLogEntry(l.message)}
                          </li>
                        ))}
                      </ul>
                    )}
                  </div>
                </div>
              </div>

              {/* Powerup Board */}
              <div className={`mt-4 rounded-2xl border p-4 shadow-sm ${
                ui.darkMode ? 'border-slate-700 bg-slate-800' : 'border-slate-200 bg-white'
              }`}>
                <div className="flex flex-col gap-2 md:flex-row md:items-end md:justify-between">
                  <div>
                    <h2 className="text-lg font-semibold">Powerup Board</h2>
                    <p className={`text-sm ${textMuted(ui.darkMode)}`}>Click powerups to view instructions {auth.isAdmin ? "(and edit)." : "."}</p>
                  </div>

                  {auth.isAdmin && (
                    <div className="flex gap-2">
                      <button
                        onClick={() => setUi((u) => ({ ...u, createPowerOpen: true, createPowerLabel: "", createPowerReward: "", createPowerInstructions: "" }))}
                        className={btnClass("primary", ui.darkMode)}
                      >
                        Create a powerup
                      </button>
                      <button
                        onClick={() => {
                          if (!checkAdminAuth()) {
                            alert('Admin authentication required.');
                            return;
                          }
                          if (!confirm('Are you sure you want to clear ALL powerup tiles? This will remove all powerup tiles and reset all teams\' claimed powerups.')) return;
                          dispatch({ type: "ADMIN_CLEAR_POWERUP_TILES", adminName: auth.adminName });
                        }}
                        className={btnClass("danger", ui.darkMode)}
                      >
                        Clear Powerup Board
                      </button>
                    </div>
                  )}
                </div>

                {(game.powerupTiles || []).length === 0 ? (
                  <div className={`mt-4 rounded-xl border p-4 text-sm ${ui.darkMode ? 'border-slate-700 bg-slate-800 text-slate-400' : 'border-slate-200 bg-slate-50 text-slate-600'}`}>
                    No powerups created yet.
                    {auth.isAdmin ? " Click ?Create a powerup? to add your first one." : ""}
                  </div>
                ) : (
                  <div className="mt-4 grid grid-cols-2 gap-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6">
                    {(game.powerupTiles || []).map((tile) => {
                      // Find teams that have claimed this powerup
                      const claimedTeams = teams.filter((t) => (t.claimedPowerupTiles || []).includes(tile.id));
                      
                      return (
                        <button
                          key={tile.id}
                          onClick={() => setUi((u) => ({ ...u, powerTileModalOpen: true, powerTileModalId: tile.id }))}
                          className={`rounded-xl border p-2 text-left text-xs shadow-sm transition ${
                            ui.darkMode 
                              ? 'border-slate-700 bg-slate-800 hover:bg-slate-700' 
                              : 'border-slate-200 bg-white hover:bg-slate-50'
                          }`}
                        >
                          <div className="flex items-start justify-between gap-2">
                            <div className="flex items-center gap-3">
                              {tile.image ? <img src={tile.image} alt={`Image for ${tile.label}`} onError={imageOnError} className="h-8 w-8 rounded-md object-contain" /> : null}
                              <div className={`mt-1 line-clamp-2 text-[11px] ${ui.darkMode ? 'text-slate-100' : 'text-slate-900'}`}>{tile.label}</div>
                            </div>
                            <span className={`rounded-full px-2 py-0.5 text-[10px] text-white ${ui.darkMode ? 'bg-slate-900' : 'bg-slate-800'}`}>PWR</span>
                          </div>

                          <div className={`mt-2 text-[10px] ${ui.darkMode ? 'text-slate-400' : 'text-slate-600'}`}>{tile.rewardPowerupId ? `Reward: ${powerupLabel(tile.rewardPowerupId)}` : null}</div>
                          <div className={`mt-1 text-[10px] ${ui.darkMode ? 'text-slate-400' : 'text-slate-600'}`}>{tile.pointsPerCompletion || 1} pts per completion</div>
                          <div className={`text-[10px] ${ui.darkMode ? 'text-slate-400' : 'text-slate-600'}`}>Max {tile.maxCompletions || 1}?</div>
                          <div className={`text-[10px] font-semibold ${ui.darkMode ? 'text-blue-300' : 'text-blue-700'}`}>
                            {tile.claimType === "firstTeam" ? "First team only" : tile.claimType === "unlimited" ? "Unlimited" : "Once per team"}
                          </div>
                          
                          {tile.instructions && (
                            <div className={`mt-2 text-[10px] leading-tight line-clamp-2 ${ui.darkMode ? 'text-slate-400' : 'text-slate-600'}`}>
                              {tile.instructions}
                            </div>
                          )}

                          {claimedTeams.length > 0 && (
                            <div className="mt-2 flex flex-wrap items-center gap-1">
                              {claimedTeams.map((t) => (
                                <span key={t.id} title={`Claimed by ${t.name}`} className={`inline-block h-3 w-3 rounded-full ${t.color}`} />
                              ))}
                            </div>
                          )}
                        </button>
                      );
                    })}
                  </div>
                )}
              </div>

              {/* Admin Pools */}
              {auth.isAdmin && (
                <div className="mt-4">
                  <div className="flex items-center justify-between mb-4">
                    <h2 className="text-xl font-semibold">Task Pools</h2>
                    <button
                      onClick={() => {
                        if (!checkAdminAuth()) {
                          alert('Admin authentication required.');
                          return;
                        }
                        if (!confirm('Are you sure you want to clear ALL task pools? This will remove all tasks from all difficulty levels.')) return;
                        dispatch({ type: "ADMIN_CLEAR_TASK_POOLS", adminName: auth.adminName });
                      }}
                      className={btnClass("danger", ui.darkMode)}
                    >
                      Clear All Task Pools
                    </button>
                  </div>
                  <div className="grid grid-cols-1 gap-4 lg:grid-cols-3">
                  {[1, 2, 3].map((d) => (
                    <div key={d} className={cardClass(ui.darkMode)}>
                      <h3 className="text-lg font-semibold">Possible Tasks (Difficulty {d})</h3>
                      <p className="text-sm text-slate-600">USED tasks won?t appear in ?Change future tile?.</p>

                      <div className="mt-3 flex gap-2">
                        <input
                          value={ui.poolInputs[String(d)] || ""}
                          onChange={(e) => setUi((u) => ({ ...u, poolInputs: { ...u.poolInputs, [String(d)]: e.target.value } }))}
                          onKeyDown={(e) => {
                            if (e.key !== "Enter") return;
                            if (!checkAdminAuth()) {
                              alert('Admin authentication required.');
                              return;
                            }
                            dispatch({ type: "ADMIN_ADD_POOL_TASK", diff: d, label: ui.poolInputs[String(d)], adminName: auth.adminName });
                            setUi((u) => ({ ...u, poolInputs: { ...u.poolInputs, [String(d)]: "" } }));
                          }}
                          className={inputClass(ui.darkMode)}
                        />
                        <button
                          onClick={() => {
                            if (!checkAdminAuth()) {
                              alert('Admin authentication required.');
                              return;
                            }
                            dispatch({ type: "ADMIN_ADD_POOL_TASK", diff: d, label: ui.poolInputs[String(d)], adminName: auth.adminName });
                            setUi((u) => ({ ...u, poolInputs: { ...u.poolInputs, [String(d)]: "" } }));
                          }}
                          className={btnClass("primary", ui.darkMode)}
                        >
                          Add
                        </button>
                      </div>

                      <div className={`mt-3 max-h-[260px] overflow-auto rounded-xl border p-3 ${ui.darkMode ? 'border-slate-700 bg-slate-900' : 'border-slate-200 bg-slate-50'}`}>
                        {(game.taskPools?.[String(d)] || []).length === 0 ? (
                          <div className="text-sm text-slate-400">No tasks added yet.</div>
                        ) : (
                          <ul className="space-y-2">
                            {(game.taskPools?.[String(d)] || []).map((t) => {
                              const used = usedPoolTaskIds.has(t.id);
                              const editing = poolEditId === t.id;
                              return (
                                <li key={t.id} className={`rounded-xl border p-2 ${ui.darkMode ? 'border-slate-700 bg-slate-800' : 'border-slate-200 bg-white'}`}>
                                  {!editing ? (
                                    <div className="flex items-start justify-between gap-2">
                                      <div className="flex items-center gap-2 text-sm text-slate-100">
                                        {t.image ? <img src={t.image} alt={`Image for ${t.label}`} onError={imageOnError} className="h-8 w-8 rounded-md object-contain" /> : null}
                                        <div className="break-words">{t.label}</div>
                                        {used && <span className={`ml-2 rounded-full px-2 py-0.5 text-[10px] text-white ${ui.darkMode ? 'bg-slate-900' : 'bg-slate-800'}`}>USED</span>}
                                      </div>

                                      <div className="flex items-center gap-2">
                                        <button
                                          onClick={() => setPoolEditId(t.id)}
                                          className={`rounded-lg border px-2 py-1 text-xs hover:opacity-80 ${ui.darkMode ? 'border-slate-700 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900 hover:bg-slate-100'}`}
                                        >
                                          Edit
                                        </button>
                                        <button
                                          onClick={() => {
                                            if (!checkAdminAuth()) {
                                              alert('Admin authentication required.');
                                              return;
                                            }
                                            dispatch({ type: "ADMIN_REMOVE_POOL_TASK", diff: d, taskId: t.id, adminName: auth.adminName });
                                          }}
                                          className={`rounded-lg border px-2 py-1 text-xs hover:opacity-80 ${ui.darkMode ? 'border-slate-700 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900 hover:bg-slate-100'}`}
                                        >
                                          Remove
                                        </button>
                                      </div>
                                    </div>
                                  ) : (
                                    <div className="space-y-2">
                                      <div>
                                        <label className="text-xs font-semibold text-slate-600">Label</label>
                                        <input value={poolEditLabel} onChange={(e) => setPoolEditLabel(e.target.value)} className={inputClass(ui.darkMode, "mt-1")} />
                                      </div>

                                      <div>
                                        <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Image URL (optional)</label>
                                        <input value={poolEditImage} onChange={(e) => setPoolEditImage(e.target.value)} className={inputClass(ui.darkMode, "mt-1")} placeholder="https://..." />
                                        {poolEditImage ? <img src={poolEditImage} alt="Preview" onError={imageOnError} className="mt-2 h-24 w-auto rounded-md object-contain" /> : null}
                                      </div>



                                      <div>
                                        <label className="text-xs font-semibold text-slate-600">Detailed instructions</label>
                                        <textarea value={poolEditInstructions} onChange={(e) => setPoolEditInstructions(e.target.value)} className={textareaClass(ui.darkMode, "mt-1 h-24 w-full")} placeholder="Explain how to complete this task?" />
                                      </div>

                                      <div className="flex items-center gap-2">
                                        <button
                                          onClick={() => {
                                            if (!checkAdminAuth()) {
                                              alert('Admin authentication required.');
                                              return;
                                            }
                                            dispatch({ type: "ADMIN_EDIT_POOL_TASK", diff: d, id: t.id, label: poolEditLabel, instructions: poolEditInstructions, image: poolEditImage, adminName: auth.adminName });
                                            setPoolEditId(null);
                                          }}
                                          className={btnClass("primary", ui.darkMode)}
                                        >
                                          Save
                                        </button>

                                        <button onClick={() => setPoolEditId(null)} className={`rounded-lg border px-3 py-2 text-sm hover:opacity-80 ${ui.darkMode ? 'border-slate-700 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900 hover:bg-slate-100'}`}>
                                          Cancel
                                        </button>
                                      </div>
                                    </div>
                                  )}
                                </li>
                              );
                            })}
                          </ul>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
                </div>
              )}

              {/* ===================== MODALS ===================== */}

              {/* MAIN TILE MODAL (players see instructions, admin can edit) */}
              {ui.mainTileModalOpen && (
                <div className="fixed inset-0 z-50 flex items-start justify-center bg-black/30 p-4 overflow-auto">
                  <div className={`w-full max-w-3xl rounded-2xl p-4 shadow-xl my-8 ${ui.darkMode ? 'bg-slate-800 dark-scrollbar' : 'bg-white'}`}>
                    <div className="flex items-start justify-between gap-3">
                      <div>
                        <div className="text-lg font-semibold">Tile {ui.mainTileModalN}</div>
                        <div className={`mt-1 text-sm ${ui.darkMode ? 'text-slate-300' : 'text-slate-700'}`}>
                          <span className="font-semibold">Task:</span> {tileLabel(game, ui.mainTileModalN)}
                        </div>
                        <div className={`mt-1 text-sm ${ui.darkMode ? 'text-slate-300' : 'text-slate-700'}`}>
                          <span className="font-semibold">Difficulty:</span> {tileDiff(game, ui.mainTileModalN)}
                        </div>
                        <div className="mt-2 text-sm">
                          <span className="font-semibold">Reward:</span>{" "}
                          {tileReward(game, ui.mainTileModalN) ? (
                            <span className={`rounded-full px-2 py-1 text-xs text-white ${ui.darkMode ? 'bg-slate-900' : 'bg-slate-800'}`}>{powerupLabel(tileReward(game, ui.mainTileModalN))}</span>
                          ) : (
                            <span className={`${ui.darkMode ? 'text-slate-400' : 'text-slate-500'}`}>None</span>
                          )}
                        </div>

                        {tileInstructions(game, ui.mainTileModalN) && mainModalTile.image && (
                          <div className="mt-4">
                            <img src={mainModalTile.image} alt={`Image for ${tileLabel(game, ui.mainTileModalN)}`} onError={imageOnError} className="max-h-36 w-auto rounded-md object-contain" />
                          </div>
                        )}
                      </div>

                      <button onClick={() => setUi((u) => ({ ...u, mainTileModalOpen: false }))} className={btnClass("secondary", ui.darkMode, "hover:opacity-80")}>
                        Close
                      </button>
                    </div>

                    <div className={`mt-4 rounded-2xl border p-4 ${ui.darkMode ? 'border-slate-700 bg-slate-900' : 'border-slate-200 bg-slate-50'}`}>
                      <div className="text-sm font-semibold">Instructions</div>
                      <div className={`mt-2 whitespace-pre-wrap text-sm ${ui.darkMode ? 'text-slate-300' : 'text-slate-700'}`}>
                        {tileInstructions(game, ui.mainTileModalN) ? tileInstructions(game, ui.mainTileModalN) : <span className={`${ui.darkMode ? 'text-slate-400' : 'text-slate-500'}`}>No instructions added yet.</span>}
                      </div>
                      
                      {!auth.isAdmin && (
                        <div className="mt-3 pt-3 border-t border-slate-600/30">
                          <span className={`text-xs font-semibold ${ui.darkMode ? 'text-slate-400' : 'text-slate-600'}`}>
                            Max: {mainModalTile.maxCompletions}, Min: {mainModalTile.minCompletions || 1}
                          </span>
                        </div>
                      )}
                    </div>

                    {auth.isAdmin && (
                      <div className={`mt-4 rounded-2xl border p-4 ${ui.darkMode ? 'border-slate-700 bg-slate-800' : 'border-slate-200 bg-white'}`}>
                        <div className="text-sm font-semibold">Admin edit</div>

                        <div className="mt-3 space-y-3">
                          <div>
                            <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Task label</label>
                            <input value={mainEditLabel} onChange={(e) => setMainEditLabel(e.target.value)} className={inputClass(ui.darkMode, "mt-1")} />
                          </div>

                          <div className="grid grid-cols-1 gap-3 md:grid-cols-3">
                            <div>
                              <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Difficulty</label>
                              <select value={mainEditDiff} onChange={(e) => setMainEditDiff(e.target.value)} className={selectClass(ui.darkMode, "mt-1")}>
                                <option value="1">1 (Easy)</option>
                                <option value="2">2 (Medium)</option>
                                <option value="3">3 (Hard)</option>
                              </select>
                            </div>

                            <div>
                              <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Max completions</label>
                              <input 
                                type="number" 
                                min="1" 
                                value={mainEditMaxCompletions} 
                                onChange={(e) => setMainEditMaxCompletions(e.target.value)} 
                                className={inputClass(ui.darkMode, "mt-1 w-full")} 
                                placeholder="1"
                              />
                            </div>

                            <div>
                              <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Min completions</label>
                              <input 
                                type="number" 
                                min="1" 
                                max={mainEditMaxCompletions}
                                value={mainEditMinCompletions} 
                                onChange={(e) => setMainEditMinCompletions(e.target.value)} 
                                className={inputClass(ui.darkMode, "mt-1 w-full")} 
                                placeholder="1"
                              />
                            </div>
                          </div>

                          <div>
                            <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Reward powerup</label>
                            <select value={mainEditReward} onChange={(e) => setMainEditReward(e.target.value)} className={selectClass(ui.darkMode, "mt-1")}>
                              <option value="">None</option>
                              {POWERUP_DEFS.map((p) => (
                                <option key={p.id} value={p.id}>
                                  {p.name}
                                </option>
                              ))}
                            </select>
                          </div>

                          <div>
                            <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Image URL (optional)</label>
                            <input value={mainEditImage} onChange={(e) => setMainEditImage(e.target.value)} className={inputClass(ui.darkMode, "mt-1")} placeholder="https://..." />
                            {mainEditImage ? <img src={mainEditImage} alt="Preview" onError={imageOnError} className="mt-2 h-24 w-auto rounded-md object-contain" /> : null}
                          </div>

                          <div>
                            <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Detailed instructions</label>
                            <textarea
                              value={mainEditInstructions}
                              onChange={(e) => setMainEditInstructions(e.target.value)}
                              className={textareaClass(ui.darkMode, "mt-1 h-40 w-full")}
                              placeholder="Explain how to complete this tile?"
                            ></textarea>
                          </div>

                          <button
                            onClick={() => {
                              dispatch({
                                type: "ADMIN_EDIT_RACE_TILE",
                                n: ui.mainTileModalN,
                                label: mainEditLabel,
                                difficulty: mainEditDiff,
                                rewardPowerupId: mainEditReward,
                                instructions: mainEditInstructions,
                                image: mainEditImage,
                                maxCompletions: mainEditMaxCompletions,
                                minCompletions: mainEditMinCompletions,
                                adminName: auth.adminName
                              });
                            }}
                            className={btnClass("primary", ui.darkMode)}
                          >
                            Save changes
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* COMPLETE PICKER MODAL */}
              {ui.completePickerTeamId && completeTeam && (() => {
                const currentTile = getRaceTile(game, completeTeam.pos);
                const maxCompletions = currentTile.maxCompletions || 1;
                const allPlayers = [completeTeam.captain, ...(completeTeam.members || []).filter((m) => m !== completeTeam.captain)].filter(Boolean);
                
                return (
                  <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/30 p-4">
                    <div className={`w-full max-w-md max-h-[90vh] overflow-y-auto rounded-2xl p-4 shadow-xl ${ui.darkMode ? 'bg-slate-800 dark-scrollbar' : 'bg-white'}`}>
                      <div className="flex items-start justify-between gap-3">
                        <div>
                          <div className="text-lg font-semibold">Who completed the tile?</div>
                          <div className={`mt-1 text-sm ${ui.darkMode ? 'text-slate-300' : 'text-slate-600'}`}>
                            Tile: <b>{tileLabel(game, completeTeam.pos)}</b>
                          </div>
                        </div>

                        <button onClick={() => setUi((u) => ({ ...u, completePickerTeamId: null, completePickerPlayers: [] }))} className={btnClass("secondary", ui.darkMode, "hover:opacity-80")}>
                          Close
                        </button>
                      </div>

                      <div className="mt-4 space-y-3">
                        {maxCompletions === 1 ? (
                          <div>
                            <label className={`text-xs font-semibold mb-2 block ${ui.darkMode ? 'text-slate-300' : 'text-slate-600'}`}>Select player</label>
                            <div className="space-y-2">
                              {allPlayers.map((playerName, idx) => (
                                <label key={idx} className="flex items-center gap-2 cursor-pointer">
                                  <input
                                    type="radio"
                                    name="completePlayer"
                                    checked={ui.completePickerPlayers.includes(playerName)}
                                    onChange={() => {
                                      setUi((u) => ({
                                        ...u,
                                        completePickerPlayers: [playerName],
                                      }));
                                    }}
                                    className="rounded border-slate-300"
                                  />
                                  <span className={`text-sm ${ui.darkMode ? 'text-slate-200' : 'text-slate-900'}`}>{playerName}</span>
                                </label>
                              ))}
                            </div>
                          </div>
                        ) : (
                          <div>
                            <label className={`text-xs font-semibold mb-2 block ${ui.darkMode ? 'text-slate-300' : 'text-slate-600'}`}>
                              Select completors
                            </label>
                            <div className="space-y-2">
                              {allPlayers.map((playerName, idx) => {
                                const count = ui.completePickerPlayers.filter(p => p === playerName).length;
                                return (
                                  <div key={idx} className={`flex items-center justify-between gap-2 rounded-lg border px-3 py-2 ${ui.darkMode ? 'border-slate-700 bg-slate-900' : 'border-slate-200 bg-slate-50'}`}>
                                    <span className="text-sm font-medium">{playerName}</span>
                                    <div className="flex items-center gap-2">
                                      <button
                                        onClick={() => {
                                          if (count > 0) {
                                            const idx = ui.completePickerPlayers.lastIndexOf(playerName);
                                            setUi((u) => ({
                                              ...u,
                                              completePickerPlayers: [...u.completePickerPlayers.slice(0, idx), ...u.completePickerPlayers.slice(idx + 1)],
                                            }));
                                          }
                                        }}
                                        disabled={count === 0}
                                        className={`rounded px-2 py-1 text-sm font-bold ${count > 0 ? (ui.darkMode ? 'bg-slate-700 hover:bg-slate-600 text-white' : 'bg-slate-200 hover:bg-slate-300 text-slate-900') : (ui.darkMode ? 'bg-slate-800 text-slate-500 cursor-not-allowed' : 'bg-slate-100 text-slate-400 cursor-not-allowed')}`}
                                      >
                                        -
                                      </button>
                                      <span className="text-sm font-semibold w-6 text-center">{count}</span>
                                      <button
                                        onClick={() => {
                                          if (ui.completePickerPlayers.length < maxCompletions) {
                                            setUi((u) => ({
                                              ...u,
                                              completePickerPlayers: [...u.completePickerPlayers, playerName],
                                            }));
                                          }
                                        }}
                                        disabled={ui.completePickerPlayers.length >= maxCompletions}
                                        className={`rounded px-2 py-1 text-sm font-bold ${ui.completePickerPlayers.length < maxCompletions ? (ui.darkMode ? 'bg-slate-900 text-white hover:bg-slate-800' : 'bg-slate-800 text-white hover:bg-slate-700') : (ui.darkMode ? 'bg-slate-700 text-slate-400 cursor-not-allowed' : 'bg-slate-100 text-slate-400 cursor-not-allowed')}`}
                                      >
                                        +
                                      </button>
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                            <div className={`mt-2 text-xs ${ui.darkMode ? 'text-slate-400' : 'text-slate-500'}`}>
                              Total selections: {ui.completePickerPlayers.length} (min: {(() => {
                                const rt = getRaceTile(game, completeTeam.pos);
                                const doubledTilesInfo = game.doubledTilesInfo || {};
                                const isDoubled = doubledTilesInfo[completeTeam.pos] ? true : false;
                                return isDoubled ? (rt.minCompletions || 1) * 2 : (rt.minCompletions || 1);
                              })()}, max: {maxCompletions})
                            </div>
                          </div>
                        )}

                        <div className="flex items-center gap-2">
                          <button
                            onClick={() => {
                              if (ui.completePickerPlayers.length === 0) return;
                              if (!checkTeamAuth(completeTeam.id)) {
                                alert('You must be logged in as this team to complete tiles.');
                                return;
                              }
                              dispatch({ type: "COMPLETE_TILE", teamId: completeTeam.id, playerNames: ui.completePickerPlayers });
                              setUi((u) => ({ ...u, completePickerTeamId: null, completePickerPlayers: [] }));
                            }}
                            disabled={ui.completePickerPlayers.length === 0}
                            className={`${btnClass("primary", ui.darkMode)} ${ui.completePickerPlayers.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}`}
                          >
                            Confirm {ui.completePickerPlayers.length > 0 ? `(${ui.completePickerPlayers.length})` : ''}
                          </button>

                          <button onClick={() => setUi((u) => ({ ...u, completePickerTeamId: null, completePickerPlayers: [] }))} className={`rounded-lg border px-3 py-2 text-sm hover:opacity-80 ${ui.darkMode ? 'border-slate-700 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900 hover:bg-slate-100'}`}>
                            Cancel
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })()}

              {/* POWERUP CLAIM PLAYER SELECTION MODAL */}
              {ui.powerupClaimPickerOpen && (() => {
                const team = game.teams.find(t => t.id === ui.powerupClaimPickerTeamId);
                const tile = (game.powerupTiles || []).find(pt => pt.id === ui.powerupClaimPickerTileId);
                if (!team || !tile) return null;

                const allPlayers = [team.captain, ...(team.members || []).filter((m) => m !== team.captain)].filter(Boolean);
                const maxCompletions = tile.maxCompletions || 1;
                const minCompletions = tile.minCompletions || 1;
                const pointsPerCompletion = tile.pointsPerCompletion || 1;
                const claimType = tile.claimType || "eachTeam";
                
                const claimTypeLabels = {
                  eachTeam: "Once per team",
                  firstTeam: "First team only",
                  unlimited: "Unlimited claims"
                };

                return (
                  <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/30 p-4">
                    <div className={`w-full max-w-md max-h-[90vh] overflow-y-auto rounded-2xl p-4 shadow-xl ${ui.darkMode ? 'bg-slate-800 dark-scrollbar' : 'bg-white'}`}>
                      <div className="flex items-start justify-between gap-3">
                        <div className="flex-1">
                          <div className="text-lg font-semibold">Who completed this?</div>
                          <div className={`mt-1 text-sm ${ui.darkMode ? 'text-slate-300' : 'text-slate-600'}`}>
                            Task: <b>{tile.label}</b>
                          </div>
                          <div className={`mt-2 text-xs ${ui.darkMode ? 'text-slate-400' : 'text-slate-500'}`}>
                            {pointsPerCompletion} points per completion
                          </div>
                          <div className={`mt-1 text-xs font-semibold ${ui.darkMode ? 'text-blue-300' : 'text-blue-700'}`}>
                            Claim type: {claimTypeLabels[claimType]}
                          </div>
                          {tile.instructions && (
                            <div className={`mt-2 rounded-lg border p-2 text-xs ${ui.darkMode ? 'border-slate-700 bg-slate-900 text-slate-300' : 'border-slate-200 bg-slate-50 text-slate-700'}`}>
                              <div className={`font-semibold mb-1 ${ui.darkMode ? 'text-slate-200' : 'text-slate-800'}`}>Instructions:</div>
                              {tile.instructions}
                            </div>
                          )}
                        </div>

                        <button onClick={() => setUi((u) => ({ ...u, powerupClaimPickerOpen: false, powerupClaimPickerPlayers: [] }))} className={btnClass("secondary", ui.darkMode, "hover:opacity-80")}>
                          Close
                        </button>
                      </div>

                      <div className="mt-4 space-y-3">
                        {maxCompletions === 1 ? (
                          <div>
                            <label className={`text-xs font-semibold mb-2 block ${ui.darkMode ? 'text-slate-300' : 'text-slate-600'}`}>Select player</label>
                            <div className="space-y-2">
                              {allPlayers.map((playerName, idx) => (
                                <label key={idx} className="flex items-center gap-2 cursor-pointer">
                                  <input
                                    type="radio"
                                    name="powerupClaimPlayer"
                                    checked={ui.powerupClaimPickerPlayers.includes(playerName)}
                                    onChange={() => {
                                      setUi((u) => ({
                                        ...u,
                                        powerupClaimPickerPlayers: [playerName],
                                      }));
                                    }}
                                    className="rounded border-slate-300"
                                  />
                                  <span className={`text-sm ${ui.darkMode ? 'text-slate-200' : 'text-slate-900'}`}>{playerName}</span>
                                </label>
                              ))}
                            </div>
                          </div>
                        ) : (
                          <div>
                            <div className="flex items-center justify-between mb-2">
                              <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>
                                Select completors
                              </label>
                              <div className={`text-xs ${ui.darkMode ? 'text-slate-400' : 'text-slate-500'}`}>
                                Min: {minCompletions}, Max: {maxCompletions}
                              </div>
                            </div>
                            <div className="space-y-2">
                              {allPlayers.map((playerName, idx) => {
                                const count = ui.powerupClaimPickerPlayers.filter(p => p === playerName).length;
                                return (
                                  <div key={idx} className={`flex items-center justify-between gap-2 rounded-lg border px-3 py-2 ${ui.darkMode ? 'border-slate-700 bg-slate-900' : 'border-slate-200 bg-slate-50'}`}>
                                    <span className={`text-sm ${ui.darkMode ? 'text-slate-200' : 'text-slate-900'}`}>{playerName}</span>
                                    <div className="flex items-center gap-2">
                                      <button
                                        onClick={() => {
                                          const idx = ui.powerupClaimPickerPlayers.indexOf(playerName);
                                          if (idx !== -1) {
                                            setUi((u) => ({
                                              ...u,
                                              powerupClaimPickerPlayers: [...u.powerupClaimPickerPlayers.slice(0, idx), ...u.powerupClaimPickerPlayers.slice(idx + 1)],
                                            }));
                                          }
                                        }}
                                        disabled={count === 0}
                                        className={`rounded px-2 py-1 text-sm font-bold ${count > 0 ? (ui.darkMode ? 'bg-slate-700 hover:bg-slate-600 text-white' : 'bg-slate-200 hover:bg-slate-300 text-slate-900') : (ui.darkMode ? 'bg-slate-800 text-slate-500 cursor-not-allowed' : 'bg-slate-100 text-slate-400 cursor-not-allowed')}`}
                                      >
                                        -
                                      </button>
                                      <span className="text-sm font-semibold w-6 text-center">{count}</span>
                                      <button
                                        onClick={() => {
                                          if (ui.powerupClaimPickerPlayers.length < maxCompletions) {
                                            setUi((u) => ({
                                              ...u,
                                              powerupClaimPickerPlayers: [...u.powerupClaimPickerPlayers, playerName],
                                            }));
                                          }
                                        }}
                                        disabled={ui.powerupClaimPickerPlayers.length >= maxCompletions}
                                        className={`rounded px-2 py-1 text-sm font-bold ${ui.powerupClaimPickerPlayers.length < maxCompletions ? (ui.darkMode ? 'bg-slate-700 hover:bg-slate-600 text-white' : 'bg-slate-200 hover:bg-slate-300 text-slate-900') : (ui.darkMode ? 'bg-slate-800 text-slate-500 cursor-not-allowed' : 'bg-slate-100 text-slate-400 cursor-not-allowed')}`}
                                      >
                                        +
                                      </button>
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        )}

                        <div className="flex gap-2">
                          <button
                            onClick={() => {
                              if (!checkTeamAuth(team.id)) {
                                alert('You must be logged in as this team to claim powerups.');
                                return;
                              }
                              dispatch({ type: "CLAIM_POWERUP_TILE", teamId: team.id, powerTileId: tile.id, playerNames: ui.powerupClaimPickerPlayers });
                              setUi((u) => ({ ...u, powerupClaimPickerOpen: false, powerupClaimPickerPlayers: [], claimTeamId: null, claimSelectedPowerTileId: null }));
                            }}
                            disabled={ui.powerupClaimPickerPlayers.length === 0}
                            className={`${btnClass("primary", ui.darkMode)} ${ui.powerupClaimPickerPlayers.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}`}
                          >
                            Confirm {ui.powerupClaimPickerPlayers.length > 0 ? `(${ui.powerupClaimPickerPlayers.length})` : ''}
                          </button>

                          <button onClick={() => setUi((u) => ({ ...u, powerupClaimPickerOpen: false, powerupClaimPickerPlayers: [] }))} className={`rounded-lg border px-3 py-2 text-sm hover:opacity-80 ${ui.darkMode ? 'border-slate-700 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900 hover:bg-slate-100'}`}>
                            Cancel
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })()}

              {/* IMPORT TASKS MODAL */}
              {ui.importTasksOpen && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/30 p-4">
                  <div className={`w-full max-w-3xl max-h-[90vh] overflow-y-auto rounded-2xl p-4 shadow-xl ${ui.darkMode ? 'bg-slate-800 dark-scrollbar' : 'bg-white'}`}>
                    <div className="flex items-start justify-between gap-3">
                      <div>
                        <div className="text-lg font-semibold">Import Tasks from Spreadsheet</div>
                        <div className="mt-1 text-sm text-slate-600">
                          Paste data from Google Sheets (CSV or TSV format)
                        </div>
                      </div>

                      <button onClick={() => setUi((u) => ({ ...u, importTasksOpen: false, importTasksData: "" }))} className={btnClass("secondary", ui.darkMode, "hover:opacity-80")}>
                        Close
                      </button>
                    </div>

                    <div className="mt-4 space-y-3">
                      <div className="rounded-lg bg-blue-50 border border-blue-200 p-3 text-sm text-blue-900">
                        <div className="font-semibold mb-1">Format (one task per line):</div>
                        <div className="text-xs font-mono bg-white rounded px-2 py-1">
                          Label, Difficulty, MaxCompletions, MinCompletions, Instructions, ImageURL
                        </div>
                        <div className="mt-2 text-xs">
                          <strong>Example:</strong><br/>
                          <code className="bg-white rounded px-1">Complete 10 agility laps, 1, 1, 1, Run 10 laps at Gnome Stronghold, https://example.com/image.png</code>
                        </div>
                        <div className="mt-2 text-xs text-blue-700">
                          ? Use commas or tabs to separate fields<br/>
                          ? Difficulty: 1 (Easy), 2 (Medium), 3 (Hard)<br/>
                          ? MaxCompletions: How many times points can be awarded<br/>
                          ? MinCompletions: Minimum player selections required to complete<br/>
                          ? Instructions and ImageURL are optional<br/>
                          ? After import, tasks are added to the pool for difficulty randomization
                        </div>
                      </div>

                      <div>
                        <label className="text-xs font-semibold text-slate-400 block mb-2">Paste spreadsheet data:</label>
                        <textarea
                          value={ui.importTasksData}
                          onChange={(e) => setUi((u) => ({ ...u, importTasksData: e.target.value }))}
                          className={textareaClass(ui.darkMode, "w-full h-64 font-mono")}
                          placeholder="Task name, 1, 3, 1, Instructions, https://image.url&#10;Another task, 2, 5, 2, More info, https://..."
                        />
                      </div>

                      <div className="flex items-center gap-2">
                        <button
                          onClick={() => {
                            if (!ui.importTasksData.trim()) return;
                            if (!checkAdminAuth()) {
                              alert('Admin authentication required.');
                              return;
                            }
                            dispatch({ type: "ADMIN_IMPORT_TASKS", data: ui.importTasksData, adminName: auth.adminName });
                            setUi((u) => ({ ...u, importTasksOpen: false, importTasksData: "" }));
                          }}
                          disabled={!ui.importTasksData.trim()}
                          className={`rounded-xl px-4 py-2 text-sm font-semibold text-white ${ui.importTasksData.trim() ? (ui.darkMode ? 'bg-slate-900 hover:bg-slate-800' : 'bg-slate-800 hover:bg-slate-700') : 'bg-slate-300 cursor-not-allowed'}`}
                        >
                          Import Tasks
                        </button>

                        <button 
                          onClick={() => setUi((u) => ({ ...u, importTasksOpen: false, importTasksData: "" }))} 
                          className={`rounded-xl border px-4 py-2 text-sm hover:opacity-80 ${ui.darkMode ? 'border-slate-700 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900 hover:bg-slate-100'}`}
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* IMPORT POWERUPS MODAL */}
              {ui.importPowerupsOpen && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/30 p-4">
                  <div className={`w-full max-w-3xl max-h-[90vh] overflow-y-auto rounded-2xl p-4 shadow-xl ${ui.darkMode ? 'bg-slate-800 dark-scrollbar' : 'bg-white'}`}>
                    <div className="flex items-start justify-between gap-3">
                      <div>
                        <div className="text-lg font-semibold">Import Powerup Tiles from Spreadsheet</div>
                        <div className={`mt-1 text-sm ${ui.darkMode ? 'text-slate-400' : 'text-slate-600'}`}>
                          Paste data from Google Sheets (CSV or TSV format)
                        </div>
                      </div>

                      <button onClick={() => setUi((u) => ({ ...u, importPowerupsOpen: false, importPowerupsData: "" }))} className={btnClass("secondary", ui.darkMode, "hover:opacity-80")}>
                        Close
                      </button>
                    </div>

                    <div className="mt-4 space-y-3">
                      <div className={`rounded-lg border p-3 text-sm ${
                        ui.darkMode ? 'bg-blue-900/30 border-blue-700 text-blue-200' : 'bg-blue-50 border-blue-200 text-blue-900'
                      }`}>
                        <div className="font-semibold mb-1">Format (one powerup tile per line):</div>
                        <div className={`text-xs font-mono rounded px-2 py-1 ${ui.darkMode ? 'bg-slate-900' : 'bg-white'}`}>
                          RewardPowerupId, Label, PointsPerCompletion, MaxCompletions, MinCompletions, ClaimType, Instructions, ImageURL
                        </div>
                        <div className="mt-2 text-xs">
                          <strong>Example:</strong><br/>
                          <code className={`rounded px-1 ${ui.darkMode ? 'bg-slate-900' : 'bg-white'}`}>skip2, Complete 100 fire strikes, 5, 3, 1, eachTeam, Cast fire strike 100 times, https://example.com/fire.png</code>
                        </div>
                        <div className={`mt-2 text-xs ${ui.darkMode ? 'text-blue-300' : 'text-blue-700'}`}>
                          ? Use commas or tabs to separate fields<br/>
                          ? RewardPowerupId: skip1, skip2, skip3, back1, back2, back3, copypaste, changeTile, clearCooldown, disablePowerup, doublePowerup, doubleEasy, doubleMedium, doubleHard<br/>
                          ? PointsPerCompletion: Points awarded per completion (default: 1)<br/>
                          ? MaxCompletions: Maximum times it can be claimed (default: 1)<br/>
                          ? MinCompletions: Minimum players required to complete (default: 1)<br/>
                          ? ClaimType: eachTeam (once per team), firstTeam (one claim total), unlimited (no restrictions) - default: eachTeam<br/>
                          ? Instructions and ImageURL are optional<br/>
                          ? Instructions and Link are optional
                        </div>
                      </div>

                      <div>
                        <label className={`text-xs font-semibold block mb-2 ${ui.darkMode ? 'text-slate-400' : 'text-slate-400'}`}>Paste spreadsheet data:</label>
                        <textarea
                          value={ui.importPowerupsData}
                          onChange={(e) => setUi((u) => ({ ...u, importPowerupsData: e.target.value }))}
                          className={textareaClass(ui.darkMode, "w-full h-64 font-mono")}
                          placeholder="Powerup name, skip1, Instructions, https://image.url&#10;Another powerup, back2, More info, https://..."
                        />
                      </div>

                      <div className="flex items-center gap-2">
                        <button
                          onClick={() => {
                            if (!ui.importPowerupsData.trim()) return;
                            if (!checkAdminAuth()) {
                              alert('Admin authentication required.');
                              return;
                            }
                            dispatch({ type: "ADMIN_IMPORT_POWERUPS", data: ui.importPowerupsData, adminName: auth.adminName });
                            setUi((u) => ({ ...u, importPowerupsOpen: false, importPowerupsData: "" }));
                          }}
                          disabled={!ui.importPowerupsData.trim()}
                          className={`rounded-xl px-4 py-2 text-sm font-semibold text-white ${ui.importPowerupsData.trim() ? (ui.darkMode ? 'bg-slate-900 hover:bg-slate-800' : 'bg-slate-800 hover:bg-slate-700') : 'bg-slate-300 cursor-not-allowed'}`}
                        >
                          Import Powerups
                        </button>

                        <button 
                          onClick={() => setUi((u) => ({ ...u, importPowerupsOpen: false, importPowerupsData: "" }))} 
                          className={`rounded-xl border px-4 py-2 text-sm hover:opacity-80 ${ui.darkMode ? 'border-slate-700 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900 hover:bg-slate-100'}`}
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* POWERUP TILE MODAL (players see instructions, admin can edit) */}
              {ui.powerTileModalOpen && powerModalTile && (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/30 p-4">
                  <div className={`w-full max-w-3xl max-h-[90vh] overflow-y-auto rounded-2xl p-4 shadow-xl ${ui.darkMode ? 'bg-slate-800 dark-scrollbar' : 'bg-white'}`}>
                    <div className="flex items-start justify-between gap-3">
                      <div>
                        <div className={`text-sm ${ui.darkMode ? 'text-slate-300' : 'text-slate-700'}`}>
                          <span className="font-semibold">Task:</span> {powerModalTile.label}
                        </div>
                        <div className="mt-2 text-sm">
                          <span className="font-semibold">Reward:</span>{" "}
                          {powerModalTile.rewardPowerupId ? (
                            <span className={`rounded-full px-2 py-1 text-xs text-white ${ui.darkMode ? 'bg-slate-900' : 'bg-slate-800'}`}>{powerupLabel(powerModalTile.rewardPowerupId)}</span>
                          ) : (
                            <span className={`${ui.darkMode ? 'text-slate-400' : 'text-slate-500'}`}>None</span>
                          )}
                        </div>
                      </div>

                      <button onClick={() => setUi((u) => ({ ...u, powerTileModalOpen: false }))} className={btnClass("secondary", ui.darkMode, "hover:opacity-80")}>
                        Close
                      </button>
                    </div>

                    <div className={`mt-4 rounded-2xl border p-4 ${ui.darkMode ? 'border-slate-700 bg-slate-900' : 'border-slate-200 bg-slate-50'}`}>
                      <div className="text-sm font-semibold">Instructions</div>
                      <div className={`mt-2 whitespace-pre-wrap text-sm ${ui.darkMode ? 'text-slate-300' : 'text-slate-700'}`}>
                        {powerModalTile.instructions ? powerModalTile.instructions : <span className="text-slate-500">No instructions added yet.</span>}
                      </div>
                      <div className={`mt-3 space-y-1 text-xs ${ui.darkMode ? 'text-slate-400' : 'text-slate-600'}`}>
                        <div>Points awarded: <span className="font-semibold">{powerModalTile.pointsPerCompletion || 1}</span> per completion</div>
                        <div>Can be completed: <span className="font-semibold">{powerModalTile.maxCompletions || 1}</span> {(powerModalTile.maxCompletions || 1) === 1 ? 'time' : 'times'} total</div>
                      </div>
                    </div>

                    {powerModalTile.image ? (
                      <div className="mt-4">
                        <img src={powerModalTile.image} alt={`Image for ${powerModalTile.label}`} onError={imageOnError} className="w-full max-h-64 rounded-md object-contain" />
                      </div>
                    ) : null}

                    {auth.isAdmin && (
                      <div className={`mt-4 rounded-2xl border p-4 ${ui.darkMode ? 'border-slate-700 bg-slate-800' : 'border-slate-200 bg-white'}`}>
                        <div className="text-sm font-semibold">Admin edit</div>

                        <div className="mt-3 space-y-3">
                          <div>
                            <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Task label</label>
                            <input value={powerEditLabel} onChange={(e) => setPowerEditLabel(e.target.value)} className={inputClass(ui.darkMode, "mt-1")} />
                          </div>

                          <div>
                            <label className="text-xs font-semibold text-slate-400">Reward powerup</label>
                            <select value={powerEditReward} onChange={(e) => setPowerEditReward(e.target.value)} className={selectClass(ui.darkMode, "mt-1")}>
                              <option value="">None</option>
                              {POWERUP_DEFS.map((p) => (
                                <option key={p.id} value={p.id}>
                                  {p.name}
                                </option>
                              ))}
                            </select>
                          </div>

                          <div>
                            <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Image URL (optional)</label>
                            <input value={powerEditImage} onChange={(e) => setPowerEditImage(e.target.value)} className={inputClass(ui.darkMode, "mt-1")} placeholder="https://..." />
                            {powerEditImage ? <img src={powerEditImage} alt="Preview" onError={imageOnError} className="mt-2 h-24 w-auto rounded-md object-contain" /> : null}
                          </div>

                          <div className="grid grid-cols-2 gap-3">
                            <div>
                              <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Points per completion</label>
                              <input
                                type="number"
                                min="1"
                                value={powerEditPoints}
                                onChange={(e) => setPowerEditPoints(Math.max(1, Number(e.target.value) || 1))}
                                className={inputClass(ui.darkMode, "mt-1 w-full")}
                              />
                            </div>
                            <div>
                              <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Max completions</label>
                              <input
                                type="number"
                                min="1"
                                value={powerEditMaxComp}
                                onChange={(e) => setPowerEditMaxComp(Math.max(1, Number(e.target.value) || 1))}
                                className={inputClass(ui.darkMode, "mt-1 w-full")}
                              />
                            </div>
                            <div>
                              <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Min completions</label>
                              <input
                                type="number"
                                min="1"
                                max={powerEditMaxComp}
                                value={powerEditMinComp}
                                onChange={(e) => setPowerEditMinComp(Math.max(1, Math.min(powerEditMaxComp, Number(e.target.value) || 1)))}
                                className={inputClass(ui.darkMode, "mt-1 w-full")}
                              />
                            </div>
                          </div>

                          <div>
                            <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Claim type</label>
                            <select
                              value={powerEditClaimType}
                              onChange={(e) => setPowerEditClaimType(e.target.value)}
                              className={selectClass(ui.darkMode, "mt-1 w-full")}
                            >
                              <option value="eachTeam">Each Team (once per team)</option>
                              <option value="firstTeam">First Team (only one claim total)</option>
                              <option value="unlimited">Unlimited (no restrictions)</option>
                            </select>
                          </div>

                          <div>
                            <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Detailed instructions</label>
                            <textarea
                              value={powerEditInstructions}
                              onChange={(e) => setPowerEditInstructions(e.target.value)}
                              className={textareaClass(ui.darkMode, "mt-1 h-40 w-full")}
                              placeholder="Explain how to complete this powerup task?"
                            ></textarea>
                          </div>

                          <button
                            onClick={() => {
                              dispatch({
                                type: "ADMIN_EDIT_POWERUP_TILE",
                                id: powerModalTile.id,
                                label: powerEditLabel,
                                rewardPowerupId: powerEditReward,
                                instructions: powerEditInstructions,
                                image: powerEditImage,
                                pointsPerCompletion: powerEditPoints,
                                maxCompletions: powerEditMaxComp,
                                minCompletions: powerEditMinComp,
                                claimType: powerEditClaimType,
                                adminName: auth.adminName
                              });
                            }}
                            className={btnClass("primary", ui.darkMode)}
                          >
                            Save changes
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* CREATE POWERUP MODAL */}
              {ui.createPowerOpen && auth.isAdmin && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/30 p-4">
                  <div className={`w-full max-w-xl max-h-[90vh] overflow-y-auto rounded-2xl p-4 shadow-xl ${ui.darkMode ? 'bg-slate-800 dark-scrollbar' : 'bg-white'}`}>
                    <div className="flex items-start justify-between gap-3">
                      <div>
                        <div className="text-lg font-semibold">Create a powerup</div>
                        <div className={`mt-1 text-xs ${ui.darkMode ? 'text-slate-300' : 'text-slate-600'}`}>Write the task, choose reward, add instructions.</div>
                      </div>
                      <button onClick={() => setUi((u) => ({ ...u, createPowerOpen: false }))} className={btnClass("secondary", ui.darkMode, "hover:opacity-80")}>
                        Close
                      </button>
                    </div>

                    <div className="mt-4 space-y-3">
                      <div>
                        <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Task (required)</label>
                        <input
                          value={ui.createPowerLabel}
                          onChange={(e) => setUi((u) => ({ ...u, createPowerLabel: e.target.value }))}
                          className={inputClass(ui.darkMode, "mt-1 w-full")}
                        />
                      </div>

                      <div>
                        <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Reward powerup (required)</label>
                        <select
                          value={ui.createPowerReward}
                          onChange={(e) => setUi((u) => ({ ...u, createPowerReward: e.target.value }))}
                          className={selectClass(ui.darkMode, "mt-1")}
                        >
                          <option value="">Choose?</option>
                          {POWERUP_DEFS.map((p) => (
                            <option key={p.id} value={p.id}>
                              {p.name}
                            </option>
                          ))}
                        </select>
                      </div>

                      <div>
                        <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Image URL (optional)</label>
                        <input
                          value={ui.createPowerImage}
                          onChange={(e) => setUi((u) => ({ ...u, createPowerImage: e.target.value }))}
                          className={inputClass(ui.darkMode, "mt-1 w-full")}
                          placeholder="https://..."
                        />
                      </div>

                      <div className="grid grid-cols-3 gap-3">
                        <div>
                          <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Points per completion</label>
                          <input
                            type="number"
                            min="1"
                            value={ui.createPowerPoints}
                            onChange={(e) => setUi((u) => ({ ...u, createPowerPoints: Math.max(1, Number(e.target.value) || 1) }))}
                            className={inputClass(ui.darkMode, "mt-1 w-full")}
                          />
                        </div>
                        <div>
                          <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Max completions</label>
                          <input
                            type="number"
                            min="1"
                            value={ui.createPowerMaxComp}
                            onChange={(e) => setUi((u) => ({ ...u, createPowerMaxComp: Math.max(1, Number(e.target.value) || 1) }))}
                            className={inputClass(ui.darkMode, "mt-1 w-full")}
                          />
                        </div>
                        <div>
                          <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Min completions</label>
                          <input
                            type="number"
                            min="1"
                            max={ui.createPowerMaxComp}
                            value={ui.createPowerMinComp}
                            onChange={(e) => setUi((u) => ({ ...u, createPowerMinComp: Math.max(1, Math.min(u.createPowerMaxComp, Number(e.target.value) || 1)) }))}
                            className={inputClass(ui.darkMode, "mt-1 w-full")}
                          />
                        </div>
                      </div>

                      <div>
                        <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Claim type</label>
                        <select
                          value={ui.createPowerClaimType}
                          onChange={(e) => setUi((u) => ({ ...u, createPowerClaimType: e.target.value }))}
                          className={selectClass(ui.darkMode, "mt-1 w-full")}
                        >
                          <option value="eachTeam">Each Team (once per team)</option>
                          <option value="firstTeam">First Team (only one claim total)</option>
                          <option value="unlimited">Unlimited (no restrictions)</option>
                        </select>
                      </div>

                      <div>
                        <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Detailed instructions</label>
                        <textarea
                          value={ui.createPowerInstructions}
                          onChange={(e) => setUi((u) => ({ ...u, createPowerInstructions: e.target.value }))}
                          className={textareaClass(ui.darkMode, "mt-1 h-36 w-full")}
                          placeholder="How to complete this powerup task?"
                        ></textarea>
                      </div>

                      <button
                        onClick={() => {
                          dispatch({
                            type: "ADMIN_CREATE_POWERUP_TILE",
                            label: ui.createPowerLabel,
                            rewardPowerupId: ui.createPowerReward,
                            instructions: ui.createPowerInstructions,
                            image: ui.createPowerImage,
                            pointsPerCompletion: ui.createPowerPoints,
                            maxCompletions: ui.createPowerMaxComp,
                            minCompletions: ui.createPowerMinComp,
                            claimType: ui.createPowerClaimType,
                            adminName: auth.adminName
                          });
                          setUi((u) => ({ ...u, createPowerOpen: false, createPowerLabel: "", createPowerReward: "", createPowerInstructions: "", createPowerImage: "", createPowerPoints: 1, createPowerMaxComp: 1, createPowerMinComp: 1, createPowerClaimType: "eachTeam" }));
                        }}
                        className={`${btnClass("primary", ui.darkMode, "w-full")} disabled:opacity-40`}
                        disabled={!ui.createPowerLabel.trim() || !ui.createPowerReward}
                      >
                        Create
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* USE POWERUP MODAL */}
              {usePowerTeam && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/30 p-4">
                  <div className={`w-full max-w-xl max-h-[90vh] overflow-y-auto rounded-2xl p-4 shadow-xl ${ui.darkMode ? 'bg-slate-800 dark-scrollbar' : 'bg-white'}`}>
                    <div className="flex items-start justify-between gap-3">
                      <div>
                        <div className="text-lg font-semibold">Use powerup</div>
                        <div className={`mt-1 text-xs ${ui.darkMode ? 'text-slate-300' : 'text-slate-600'}`}>Using powerup consumes it.</div>
                      </div>
                      <button onClick={() => setUi((u) => ({ ...u, usePowerupTeamId: null }))} className={btnClass("secondary", ui.darkMode, "hover:opacity-80")}>
                        Close
                      </button>
                    </div>

                    <div className="mt-4 space-y-3">
                      <div>
                        <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Powerup selector</label>
                        <select
                          value={usePwrId}
                          onChange={(e) => {
                            setUsePwrId(e.target.value);
                            setUseTargetId("");
                            setUseFutureTile("");
                            setUseChangeTaskId("");
                          }}
                          className={selectClass(ui.darkMode, "mt-1")}
                        >
                          {Array.from(new Set(usePowerTeam.inventory || [])).map((pid) => {
                            const count = (usePowerTeam.inventory || []).filter((x) => x === pid).length;
                            const label = powerupLabel(pid);
                            const spaces = ' '.repeat(Math.max(0, 50 - label.length));
                            return (
                              <option key={pid} value={pid}>
                                {label}{spaces}(x{count} stored)
                              </option>
                            );
                          })}
                        </select>
                      </div>

                      {(usePwrId === "back1" || usePwrId === "back2" || usePwrId === "back3") && (
                        <div>
                          <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Target team</label>
                          <select value={useTargetId} onChange={(e) => setUseTargetId(e.target.value)} className={selectClass(ui.darkMode, "mt-1")}>
                            <option value="">Choose?</option>
                            {teams.filter((t) => t.id !== usePowerTeam.id).map((t) => (
                              <option key={t.id} value={t.id}>
                                {t.name}
                              </option>
                            ))}
                          </select>
                        </div>
                      )}

                      {usePwrId === "disablePowerup" && (
                        <>
                          <div>
                            <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Target team</label>
                            <select value={useTargetId} onChange={(e) => setUseTargetId(e.target.value)} className={selectClass(ui.darkMode, "mt-1")}>
                              <option value="">Choose?</option>
                              {teams.filter((t) => t.id !== usePowerTeam.id).map((t) => (
                                <option key={t.id} value={t.id}>
                                  {t.name}
                                </option>
                              ))}
                            </select>
                          </div>
                          {useTargetId && (() => {
                            const targetTeam = teams.find((t) => t.id === useTargetId);
                            return targetTeam && (targetTeam.inventory || []).length > 0 ? (
                              <div>
                                <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Target powerup to disable</label>
                                <select value={ui.useTargetPowerupId || ""} onChange={(e) => setUi((u) => ({ ...u, useTargetPowerupId: e.target.value }))} className={selectClass(ui.darkMode, "mt-1")}>
                                  <option value="">Choose powerup?</option>
                                  {Array.from(new Set(targetTeam.inventory || [])).map((pid) => (
                                    <option key={pid} value={pid}>
                                      {powerupLabel(pid)} (x{(targetTeam.inventory || []).filter((x) => x === pid).length})
                                    </option>
                                  ))}
                                </select>
                              </div>
                            ) : (
                              <div className={`text-xs ${textMuted(ui.darkMode)}`}>Target team has no powerups.</div>
                            );
                          })()}
                        </>
                      )}

                      {usePwrId === "doublePowerup" && (
                        <div>
                          <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Powerup to double</label>
                          <select value={ui.useTargetPowerupId || ""} onChange={(e) => setUi((u) => ({ ...u, useTargetPowerupId: e.target.value }))} className={selectClass(ui.darkMode, "mt-1")}>
                            <option value="">Choose?</option>
                            {Array.from(new Set(usePowerTeam.inventory || [])).filter((pid) => pid !== usePwrId).map((pid) => (
                              <option key={pid} value={pid}>
                                {powerupLabel(pid)} (x{(usePowerTeam.inventory || []).filter((x) => x === pid).length})
                              </option>
                            ))}
                          </select>
                        </div>
                      )}

                      {(usePwrId === "markFuture" || usePwrId === "copypaste" || usePwrId === "changeTile" || usePwrId === "doubleEasy" || usePwrId === "doubleMedium" || usePwrId === "doubleHard") && (
                        <div>
                          <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>
                            Select tile
                          </label>
                          
                          <div className={`mt-2 max-h-96 overflow-y-auto rounded-xl border p-2 ${ui.darkMode ? 'border-slate-600 bg-slate-900' : 'border-slate-200 bg-slate-50'}`}>
                            <div className="grid grid-cols-4 gap-1">
                              {serpentRows.flat().map((cell, idx) => {
                                if (!cell) return <div key={`empty-${idx}`} className="w-full h-10"></div>;
                                const tile = cell;
                                const tileN = tile.n;
                                
                                // Check if tile is revealed (fog of war)
                                const isRevealed = revealedTiles.has(tileN);
                                
                                // Determine if this tile can be selected based on powerup
                                let canSelect = true;
                                let reason = "";
                                
                                // Hidden tiles cannot be selected
                                if (!isRevealed) {
                                  canSelect = false;
                                  reason = "Hidden";
                                }
                                else if (usePwrId === "copypaste") {
                                  const teamOnTile = (game.teams || []).some((t) => t.pos === tileN);
                                  if (teamOnTile) {
                                    canSelect = false;
                                    reason = "Team on tile";
                                  } else {
                                    const currentDiff = tileDiff(game, usePowerTeam.pos);
                                    const targetDiff = tileDiff(game, tileN);
                                    if (targetDiff > currentDiff) {
                                      canSelect = false;
                                      reason = "Higher difficulty";
                                    } else if (tileN === usePowerTeam.pos) {
                                      canSelect = false;
                                      reason = "Current tile";
                                    }
                                  }
                                }
                                else if (usePwrId === "changeTile") {
                                  const teamOnTile = (game.teams || []).some((t) => t.pos === tileN);
                                  if (teamOnTile) {
                                    canSelect = false;
                                    reason = "Team on tile";
                                  } else if (tileN === MAX_TILE) {
                                    canSelect = false;
                                    reason = "Final tile";
                                  } else if (changedTiles.has(tileN)) {
                                    canSelect = false;
                                    reason = "Already changed";
                                  }
                                }
                                else if (usePwrId === "doubleEasy") {
                                  if (tileN === MAX_TILE) {
                                    canSelect = false;
                                    reason = "Final tile";
                                  } else if (tileDiff(game, tileN) !== 1) {
                                    canSelect = false;
                                    reason = "Not easy";
                                  } else if (doubledTiles.has(tileN)) {
                                    canSelect = false;
                                    reason = "Already doubled";
                                  }
                                }
                                else if (usePwrId === "doubleMedium") {
                                  if (tileN === MAX_TILE) {
                                    canSelect = false;
                                    reason = "Final tile";
                                  } else if (tileDiff(game, tileN) !== 2) {
                                    canSelect = false;
                                    reason = "Not medium";
                                  } else if (doubledTiles.has(tileN)) {
                                    canSelect = false;
                                    reason = "Already doubled";
                                  }
                                }
                                else if (usePwrId === "doubleHard") {
                                  if (tileN === MAX_TILE) {
                                    canSelect = false;
                                    reason = "Final tile";
                                  } else if (tileDiff(game, tileN) !== 3) {
                                    canSelect = false;
                                    reason = "Not hard";
                                  } else if (doubledTiles.has(tileN)) {
                                    canSelect = false;
                                    reason = "Already doubled";
                                  }
                                }
                                
                                const isSelected = useFutureTile === String(tileN);
                                const isFinalTile = tileN === MAX_TILE;
                                const colSpan = isFinalTile ? 'col-span-4' : '';
                                
                                // Get tile colors based on difficulty
                                const tileBgColor = isRevealed ? diffTint(tile.difficulty, ui.darkMode) : '';
                                
                                // Find teams on this tile
                                const teamsOnTile = (game.teams || []).filter(t => t.pos === tileN);
                                
                                return (
                                  <button
                                    key={tileN}
                                    onClick={() => canSelect && setUseFutureTile(String(tileN))}
                                    disabled={!canSelect}
                                    className={`relative w-full h-10 rounded border flex items-center justify-center gap-1 font-bold transition ${colSpan} ${
                                      isSelected
                                        ? ui.darkMode ? 'border-amber-500 bg-amber-900/50 text-amber-200' : 'border-amber-500 bg-amber-100 text-amber-900'
                                        : canSelect && isRevealed
                                        ? `${tileBgColor} hover:brightness-95`
                                        : canSelect
                                        ? ui.darkMode ? 'border-slate-600 bg-slate-800 text-slate-100 hover:bg-slate-700' : 'border-slate-300 bg-white text-slate-900 hover:bg-slate-100'
                                        : ui.darkMode ? 'border-slate-700 bg-slate-900/50 text-slate-600 cursor-not-allowed' : 'border-slate-200 bg-slate-100 text-slate-400 cursor-not-allowed'
                                    }`}
                                    title={canSelect ? `Tile ${tileN}` : reason}
                                  >
                                    {isRevealed ? (
                                      <>
                                        {tile.image && (
                                          <img src={tile.image} alt="" onError={imageOnError} className="h-6 w-6 rounded object-contain" />
                                        )}
                                        <span className="text-base">{tileN}</span>
                                        {teamsOnTile.length > 0 && (
                                          <div className="absolute top-0.5 right-0.5 flex gap-0.5">
                                            {teamsOnTile.map((t, idx) => (
                                              <div key={idx} className={`w-2 h-2 rounded-full border border-white/50 ${t.color}`} title={t.name}></div>
                                            ))}
                                          </div>
                                        )}
                                      </>
                                    ) : (
                                      <span className="text-2xl">?</span>
                                    )}
                                  </button>
                                );
                              })}
                            </div>
                          </div>

                          {usePwrId === "changeTile" && (
                            <div className={`mt-2 text-xs ${ui.darkMode ? 'text-slate-300' : 'text-slate-600'}`}>
                              {futureValid && futureAlreadyChanged && (
                                <span className={`${ui.darkMode ? 'text-amber-400' : 'text-amber-700'}`}>Tile {parsedFuture} already changed once.</span>
                              )}
                            </div>
                          )}
                        </div>
                      )}

                      {usePwrId === "changeTile" && (
                        <div>
                          <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Change to task (same difficulty, unused)</label>
                          <select
                            value={useChangeTaskId}
                            onChange={(e) => setUseChangeTaskId(e.target.value)}
                            className={selectClass(ui.darkMode, "mt-1")}
                            disabled={!futureValid || futureAlreadyChanged || poolUnused.length === 0}
                          >
                            {(!futureValid || futureAlreadyChanged || poolUnused.length === 0) && (
                              <option value="">
                                {!futureValid ? "Choose tile first" : futureAlreadyChanged ? "This tile is locked" : "No unused tasks left"}
                              </option>
                            )}
                            {futureValid &&
                              !futureAlreadyChanged &&
                              poolUnused.map((t) => (
                                <option key={t.id} value={t.id}>
                                  {t.label}
                                </option>
                              ))}
                          </select>
                            {useChangeTaskId ? (
                              (() => {
                                const chosen = poolUnused.find((x) => x.id === useChangeTaskId);
                                if (!chosen) return null;
                                return (
                                  <div className={`mt-3 rounded-xl border p-3 text-sm ${ui.darkMode ? 'border-slate-700 bg-slate-900' : 'border-slate-200 bg-slate-50'}`}>
                                    {chosen.image ? <img src={chosen.image} alt={`Image for ${chosen.label}`} onError={imageOnError} className="mb-2 h-28 w-auto rounded-md object-contain" /> : null}
                                    <div className={`font-semibold ${ui.darkMode ? 'text-slate-200' : 'text-slate-700'}`}>{chosen.label}</div>
                                  </div>
                                );
                              })()
                            ) : null}
                        </div>
                      )}

                      <button
                        onClick={() => {
                          if (!checkTeamAuth(usePowerTeam.id)) {
                            alert('You must be logged in as this team to use powerups.');
                            return;
                          }
                          dispatch({
                            type: "USE_POWERUP",
                            teamId: usePowerTeam.id,
                            powerupId: usePwrId,
                            targetId: useTargetId,
                            futureTile: useFutureTile,
                            changeTaskId: useChangeTaskId,
                            targetPowerupId: ui.useTargetPowerupId,
                          });
                          setUi((u) => ({ ...u, usePowerupTeamId: null, useTargetPowerupId: null }));
                        }}
                        className={`${btnClass("primary", ui.darkMode, "w-full")} disabled:opacity-40`}
                        disabled={
                          (usePwrId === "back1" || usePwrId === "back2" || usePwrId === "back3")
                            ? !useTargetId
                            : usePwrId === "disablePowerup"
                            ? !useTargetId || !ui.useTargetPowerupId
                            : usePwrId === "doublePowerup"
                            ? !ui.useTargetPowerupId
                            : (usePwrId === "markFuture" || usePwrId === "copypaste" || usePwrId === "doubleEasy" || usePwrId === "doubleMedium" || usePwrId === "doubleHard")
                            ? !useFutureTile
                            : usePwrId === "changeTile"
                            ? !futureValid || futureAlreadyChanged || !useChangeTaskId
                            : false
                        }
                      >
                        Use powerup
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* CLAIM POWERUP MODAL */}
              {claimTeam && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/30 p-4">
                  <div className={`w-full max-w-3xl max-h-[90vh] overflow-y-auto rounded-2xl p-4 shadow-xl ${ui.darkMode ? 'bg-slate-800 dark-scrollbar' : 'bg-white'}`}>
                    <div className="flex items-start justify-between gap-3">
                      <div>
                        <div className="text-lg font-semibold">Claim powerup</div>
                      </div>
                      <button
                        onClick={() => setUi((u) => ({ ...u, claimTeamId: null, claimSelectedPowerTileId: null, claimConfirmOpen: false }))}
                        className={btnClass("secondary", ui.darkMode, "hover:opacity-80")}
                      >
                        Close
                      </button>
                    </div>

                    <div className={`mt-4 overflow-auto rounded-xl border ${ui.darkMode ? 'border-slate-700' : 'border-slate-300'}`}>
                      <table className={`w-full text-left text-sm ${ui.darkMode ? 'text-slate-200' : 'text-slate-900'}`}>
                        <thead className={`text-xs ${ui.darkMode ? 'bg-slate-900 text-slate-300' : 'bg-slate-50 text-slate-600'}`}>
                          <tr>
                            <th className="p-3">Image</th>
                            <th className="p-3">Task</th>
                            <th className="p-3">Reward</th>
                            <th className="p-3">Claim Type</th>
                            <th className="p-3">Status</th>
                            <th className="p-3"></th>
                          </tr>
                        </thead>
                        <tbody>
                          {claimablePowerTiles(claimTeam).map((pt) => (
                            <tr key={pt.id} className={`border-t ${ui.darkMode ? 'border-slate-700' : 'border-slate-300'}`}>
                              <td className="p-3">
                                {pt.image ? (
                                  <img src={pt.image} alt={pt.label} onError={imageOnError} className="h-12 w-12 rounded-md object-contain" />
                                ) : (
                                  <div className={`h-12 w-12 rounded-md flex items-center justify-center ${ui.darkMode ? 'bg-slate-700' : 'bg-slate-200'}`}>
                                    <span className="text-xs text-slate-500">-</span>
                                  </div>
                                )}
                              </td>
                              <td className="p-3">
                                <button
                                  onClick={() => setUi((u) => ({ ...u, powerTileModalOpen: true, powerTileModalId: pt.id }))}
                                  className={`font-medium text-left hover:underline ${ui.darkMode ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-700'}`}
                                >
                                  {pt.label}
                                </button>
                              </td>
                              <td className={`p-3 ${ui.darkMode ? 'text-slate-300' : 'text-slate-700'}`}>
                                {pt.rewardPowerupId ? powerupLabel(pt.rewardPowerupId) : <span className={`${ui.darkMode ? 'text-slate-500' : 'text-slate-400'}`}>No reward</span>}
                              </td>
                              <td className={`p-3 text-xs ${ui.darkMode ? 'text-slate-400' : 'text-slate-600'}`}>
                                {pt.claimType === "eachTeam" ? "Each Team" : pt.claimType === "firstTeam" ? "First Team" : "Unlimited"}
                              </td>
                              <td className="p-3">
                                {pt.claimed ? (
                                  <span className={`rounded-full px-2 py-1 text-xs ${ui.darkMode ? 'bg-slate-700 text-slate-200' : 'bg-slate-100 text-slate-700'}`}>Claimed</span>
                                ) : pt.claimedByTeam ? (
                                  <span className={`rounded-full px-2 py-1 text-xs ${ui.darkMode ? 'bg-slate-700 text-slate-300' : 'bg-slate-200 text-slate-700'}`}>
                                    {pt.claimedByTeam}
                                  </span>
                                ) : pt.disabled && pt.rewardPowerupId ? (
                                  <span className={`rounded-full px-2 py-1 text-xs ${ui.darkMode ? 'bg-red-900 text-red-200' : 'bg-red-50 text-red-800'}`}>Unavailable</span>
                                ) : pt.rewardPowerupId ? (
                                  <span className={`rounded-full px-2 py-1 text-xs ${ui.darkMode ? 'bg-emerald-900 text-emerald-200' : 'bg-emerald-50 text-emerald-800'}`}>Available</span>
                                ) : (
                                  <span className={`rounded-full px-2 py-1 text-xs ${ui.darkMode ? 'bg-amber-900 text-amber-200' : 'bg-amber-50 text-amber-900'}`}>Needs reward</span>
                                )}
                              </td>
                              <td className="p-3 text-right">
                                <button
                                  disabled={pt.disabled}
                                  onClick={() => setUi((u) => ({ ...u, claimSelectedPowerTileId: pt.id, claimConfirmOpen: true }))}
                                  className={`rounded-xl px-3 py-2 text-xs font-semibold text-white disabled:opacity-40 ${ui.darkMode ? 'bg-slate-900 hover:bg-slate-800' : 'bg-slate-800 hover:bg-slate-700'}`}
                                >
                                  Select
                                </button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              )}

              {/* CLAIM POWERUP CONFIRMATION MODAL */}
              {claimTeam && ui.claimConfirmOpen && ui.claimSelectedPowerTileId != null &&
                (() => {
                  const chosen = (game.powerupTiles || []).find((x) => x.id === Number(ui.claimSelectedPowerTileId)) || null;
                  if (!chosen) return null;
                  const alreadyClaimed = (claimTeam.claimedPowerupTiles || []).includes(chosen.id);
                  return (
                    <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 p-4">
                      <div className={`w-full max-w-md rounded-2xl p-6 shadow-xl ${ui.darkMode ? 'bg-slate-800 border border-slate-700' : 'bg-white border border-slate-200'}`}>
                        <div className="text-lg font-semibold">Confirm completion</div>
                        <div className={`mt-3 text-sm ${ui.darkMode ? 'text-slate-300' : 'text-slate-700'}`}>
                          <div className="space-y-2">
                            <div>Task: <b>{chosen.label}</b></div>
                            <div>
                              Reward: <b>{chosen.rewardPowerupId ? powerupLabel(chosen.rewardPowerupId) : "No reward"}</b>{alreadyClaimed && <span className={`ml-2 text-xs ${ui.darkMode ? 'text-slate-500' : 'text-slate-400'}`}>(already claimed)</span>}
                            </div>
                            {(chosen.image || chosen.instructions) && (
                              <div className="mt-2 flex gap-3">
                                {chosen.image && (
                                  <div className="flex-shrink-0">
                                    <img src={chosen.image} alt={chosen.label} onError={imageOnError} className="h-24 w-auto rounded-lg object-contain border border-slate-600" />
                                  </div>
                                )}
                                {chosen.instructions && (
                                  <div className={`flex-1 rounded-lg border p-2 text-xs ${ui.darkMode ? 'border-slate-700 bg-slate-900 text-slate-300' : 'border-slate-200 bg-slate-50 text-slate-700'}`}>
                                    <div className={`font-semibold mb-1 ${ui.darkMode ? 'text-slate-200' : 'text-slate-800'}`}>Instructions:</div>
                                    {chosen.instructions}
                                  </div>
                                )}
                              </div>
                            )}
                          </div>
                        </div>

                        <div className="mt-4 flex flex-wrap gap-2">
                          <button
                            onClick={() => {
                              if (!checkTeamAuth(claimTeam.id)) {
                                alert('You must be logged in as this team to claim powerups.');
                                return;
                              }
                              // Open player selection modal
                              setUi((u) => ({ 
                                ...u, 
                                powerupClaimPickerOpen: true,
                                powerupClaimPickerTeamId: claimTeam.id,
                                powerupClaimPickerTileId: chosen.id,
                                powerupClaimPickerPlayers: [],
                                claimConfirmOpen: false
                              }));
                            }}
                            className={`flex-1 rounded-xl px-4 py-2 text-sm font-semibold text-white disabled:opacity-40 ${ui.darkMode ? 'bg-emerald-700 hover:bg-emerald-600' : 'bg-emerald-600 hover:bg-emerald-700'}`}
                            disabled={!chosen.rewardPowerupId || alreadyClaimed}
                          >
                            Select players
                          </button>
                          <button onClick={() => setUi((u) => ({ ...u, claimSelectedPowerTileId: null, claimConfirmOpen: false }))} className={`flex-1 rounded-xl border px-4 py-2 text-sm hover:opacity-80 ${ui.darkMode ? 'border-slate-700 bg-slate-700 text-slate-100' : 'border-slate-300 bg-slate-100 text-slate-900 hover:bg-slate-200'}`}>
                            Cancel
                          </button>
                        </div>
                      </div>
                    </div>
                  );
                })()}

              {/* ADMIN: EDIT TEAM MODAL */}
              {editTeam && auth.isAdmin && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/30 p-4">
                  <div className={`w-full max-w-2xl max-h-[90vh] overflow-y-auto rounded-2xl p-4 shadow-xl ${ui.darkMode ? 'bg-slate-800 dark-scrollbar' : 'bg-white'}`}>
                    <div className="flex items-start justify-between gap-3">
                      <div>
                        <div className="text-lg font-semibold">Edit team: {editTeam.name}</div>
                        <div className={`mt-1 text-xs ${ui.darkMode ? 'text-slate-300' : 'text-slate-600'}`}>Set current tile and stored powerups (one id per line).</div>
                        <div className={`mt-1 text-xs ${ui.darkMode ? 'text-slate-400' : 'text-slate-500'}`}>Valid ids: {POWERUP_DEFS.map((p) => p.id).join(", ")}</div>
                      </div>
                      <button onClick={() => setUi((u) => ({ ...u, editTeamId: null }))} className={btnClass("secondary", ui.darkMode, "hover:opacity-80")}>
                        Close
                      </button>
                    </div>

                    <div className="mt-4 grid grid-cols-1 gap-4 md:grid-cols-2">
                      <div>
                        <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Current tile</label>
                        <input value={editPos} onChange={(e) => setEditPos(e.target.value)} className={inputClass(ui.darkMode, "mt-1")} />
                        <div className={`mt-2 text-xs ${ui.darkMode ? 'text-slate-400' : 'text-slate-500'}`}>Current: {tileDesc(game, editTeam.pos)}</div>

                        <div className="mt-3">
                          <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Captain</label>
                          <input value={editCaptain} onChange={(e) => setEditCaptain(e.target.value)} placeholder="Captain name" className={`mt-1 w-full rounded-xl border px-3 py-2 text-sm placeholder-slate-400 ${ui.darkMode ? 'border-slate-700 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900'}`} />
                        </div>

                        <div className="mt-3">
                          <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Members (one per line)</label>
                          <textarea value={editMembersText} onChange={(e) => setEditMembersText(e.target.value)} className={textareaClass(ui.darkMode, "mt-1 h-28 w-full")} />

                          <div className={`mt-3 rounded-xl border p-3 text-sm ${ui.darkMode ? 'border-slate-700 bg-slate-900' : 'border-slate-200 bg-slate-50'}`}>
                            <div className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Player points (admin)</div>
                            <div className="mt-2 space-y-2">
                              {(() => {
                                const names = Array.from(new Set([...(editMembersText || "").split("\n").map((x) => x.trim()).filter(Boolean), editCaptain || ""].flat().filter(Boolean)));
                                if (names.length === 0) return <div className={`text-xs ${ui.darkMode ? 'text-slate-400' : 'text-slate-500'}`}>No players to set.</div>;
                                return names.map((n) => (
                                  <div key={n} className="flex items-center gap-2">
                                    <div className={`w-36 text-sm ${ui.darkMode ? 'text-slate-200' : 'text-slate-900'}`}>{n}</div>
                                    <input type="number" value={(editPlayerPoints[n] || 0)} min={0} onChange={(e) => setEditPlayerPoints((p) => ({ ...p, [n]: Number(e.target.value) }))} className={inputClass(ui.darkMode, "w-20")} />
                                  </div>
                                ));
                              })()}
                            </div>
                          </div>
                        </div>
                      </div>

                      <div>
                        <label className={`text-xs font-semibold ${textNormal(ui.darkMode)}`}>Stored powerups (IDs)</label>
                        <textarea value={editInvText} onChange={(e) => setEditInvText(e.target.value)} className={textareaClass(ui.darkMode, "mt-1 h-40 w-full")} />
                      </div>
                    </div>

                    <div className="mt-4 flex flex-wrap gap-2">
                      <button
                        onClick={() => {
                          if (!checkAdminAuth()) {
                            alert('Admin authentication required.');
                            return;
                          }
                          const lines = (editInvText || "").split("\n").map((x) => x.trim()).filter(Boolean);
                          const members = (editMembersText || "").split("\n").map((x) => x.trim()).filter(Boolean);
                          dispatch({ type: "ADMIN_SET_TEAM", teamId: editTeam.id, pos: editPos, inventory: lines, members, captain: editCaptain, playerPoints: editPlayerPoints, adminName: auth.adminName });
                          setUi((u) => ({ ...u, editTeamId: null }));
                        }}
                        className={btnClass("primary", ui.darkMode)}
                      >
                        Save
                      </button>
                      <button onClick={() => setUi((u) => ({ ...u, editTeamId: null }))} className={btnClass("secondary", ui.darkMode, "hover:opacity-80")}>
                        Cancel
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* ===================== DRAFT / FORM TEAMS MODAL ===================== */}
              {ui.draftOpen && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/30 p-4">
                  <div className={`w-full max-w-5xl max-h-[90vh] overflow-y-auto rounded-2xl p-4 shadow-xl ${ui.darkMode ? 'bg-slate-800 dark-scrollbar' : 'bg-white'}`}>
                    <div className="flex items-start justify-between gap-3">
                      <div>
                        <div className="text-lg font-semibold">Form teams (Draft simulator)</div>
                        <div className="mt-1 text-xs text-slate-600">Testing/dev tool. Doesn?t affect the race until you click ?Apply to game?.</div>
                      </div>
                      <button onClick={() => setUi((u) => ({ ...u, draftOpen: false }))} className={btnClass("secondary", ui.darkMode, "hover:opacity-80")}>
                        Close
                      </button>
                    </div>

                    {/* Setup */}
                    {draft.step === "setup" && (
                      <div className="mt-4 grid grid-cols-1 gap-4 lg:grid-cols-2">
                        <div className={`rounded-2xl border p-4 ${ui.darkMode ? 'border-slate-600 bg-slate-800' : 'border-slate-200 bg-white'}`}>
                          <div className="text-sm font-semibold">Player pool (one per line)</div>
                          <textarea
                            value={draft.playersText}
                            onChange={(e) => setDraft((d) => ({ ...d, playersText: e.target.value }))}
                            className={textareaClass(ui.darkMode, "mt-2 h-56 w-full")}
                          ></textarea>
                        </div>

                        <div className={`rounded-2xl border p-4 ${ui.darkMode ? 'border-slate-600 bg-slate-800' : 'border-slate-200 bg-white'}`}>
                          <div className="text-sm font-semibold">Teams (one per line)</div>
                          <textarea
                            value={draft.teamsText}
                            onChange={(e) => setDraft((d) => ({ ...d, teamsText: e.target.value }))}
                            className={textareaClass(ui.darkMode, "mt-2 h-32 w-full")}
                          ></textarea>

                          <div className="mt-4 text-sm font-semibold">Captains</div>
                          <div className="mt-2 space-y-2">
                            {draft.teamsText
                              .split("\n")
                              .map((x) => x.trim())
                              .filter(Boolean)
                              .map((tn) => (
                                <div key={tn} className="flex items-center gap-2">
                                  <div className="w-40 text-sm">{tn}</div>
                                  <input
                                    value={draft.captains[tn] || ""}
                                    onChange={(e) => setDraft((d) => ({ ...d, captains: { ...d.captains, [tn]: e.target.value } }))}
                                    placeholder="Captain name"
                                    className={`w-full rounded-xl border px-3 py-2 text-sm placeholder-slate-400 ${
                                      ui.darkMode ? 'border-slate-700 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900'
                                    }`}
                                  />
                                </div>
                              ))}
                          </div>

                          <div className="mt-4 flex flex-wrap gap-2">
                            <button
                              onClick={startDraftFromSetup}
                              className={btnClass("primary", ui.darkMode)}
                            >
                              Start draft
                            </button>
                            <button
                              onClick={() => setDraft((d) => ({ ...d, captains: {} }))}
                              className={btnClass("secondary", ui.darkMode, "hover:opacity-80")}
                            >
                              Clear captains
                            </button>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Picking */}
                    {draft.step === "picking" && (
                      <div className="mt-4 grid grid-cols-1 gap-4 lg:grid-cols-3">
                        <div className="rounded-2xl border border-slate-600 p-4 lg:col-span-2">
                          <div className="flex items-center justify-between gap-3">
                            <div>
                              <div className="text-sm font-semibold">Available players</div>
                              <div className={`mt-1 text-xs ${
                                ui.darkMode ? 'text-slate-300' : 'text-slate-600'
                              }`}>
                                Current pick: <span className="font-semibold">{currentDraftTeam()}</span>
                              </div>
                            </div>
                            <button
                              onClick={() => setDraft((d) => ({ ...d, step: "summary" }))}
                              className={btnClass("secondary", ui.darkMode, "hover:opacity-80")}
                            >
                              Finish early
                            </button>
                          </div>

                          <div className="mt-3 grid grid-cols-1 gap-2 sm:grid-cols-2">
                            {draft.available.map((p) => (
                              <button
                                key={p}
                                onClick={() => draftPick(p)}
                                className={`flex items-center justify-between rounded-xl border px-3 py-2 text-sm ${
                                  ui.darkMode ? 'border-slate-700 bg-slate-800 hover:bg-slate-700 text-slate-100' : 'border-slate-300 bg-white hover:bg-slate-50 text-slate-900'
                                }`}
                              >
                                <span>{p}</span>
                                <span className={`rounded-lg px-2 py-1 text-xs font-semibold text-white ${ui.darkMode ? 'bg-slate-900' : 'bg-slate-800'}`}>Pick</span>
                              </button>
                            ))}
                          </div>

                          {draft.available.length === 0 && (
                            <div className={`mt-3 rounded-xl border p-3 text-sm ${ui.darkMode ? 'border-slate-700 bg-slate-900 text-slate-400' : 'border-slate-200 bg-slate-50 text-slate-600'}`}>
                              No players left. Draft complete.
                            </div>
                          )}
                        </div>

                        <div className={`rounded-2xl border p-4 ${ui.darkMode ? 'border-slate-600 bg-slate-800' : 'border-slate-200 bg-white'}`}>
                          <div className="text-sm font-semibold">Teams</div>
                          <div className="mt-3 space-y-3">
                            {draft.order.map((tn) => (
                              <div key={tn} className={`rounded-xl border p-3 ${ui.darkMode ? 'border-slate-700 bg-slate-900' : 'border-slate-200 bg-slate-50'}`}>
                                <div className="text-sm font-semibold">{tn}</div>
                                <div className="mt-1 text-xs text-slate-600">Captain: {draft.captains[tn] || "?"}</div>
                                <div className="mt-2 text-sm">
                                  {(draft.picks[tn] || []).length ? (
                                    <ul className="list-disc pl-5">
                                      {(draft.picks[tn] || []).map((m, idx) => (
                                        <li key={idx}>{m}</li>
                                      ))}
                                    </ul>
                                  ) : (
                                    <span className="text-slate-500">No picks yet.</span>
                                  )}
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Stealing */}
                    {draft.step === "stealing" && (
                      <div className="mt-4 grid grid-cols-1 gap-4 lg:grid-cols-3">
                        <div className={`rounded-2xl border p-4 lg:col-span-2 ${ui.darkMode ? 'border-slate-600 bg-slate-800' : 'border-slate-200 bg-white'}`}>
                          <div className="flex items-center justify-between gap-3">
                            <div>
                              <div className="text-sm font-semibold">Steal Phase</div>
                              <div className={`mt-1 text-xs ${ui.darkMode ? 'text-slate-300' : 'text-slate-600'}`}>
                                Current turn: <span className="font-semibold">{currentStealTeam()}</span>
                              </div>
                              <div className={`mt-1 text-xs ${ui.darkMode ? 'text-slate-400' : 'text-slate-500'}`}>
                                Each team can steal one player (not captain) from another team
                              </div>
                            </div>
                            <button
                              onClick={() => setDraft((d) => ({ ...d, step: "summary" }))}
                              className={btnClass("secondary", ui.darkMode, "hover:opacity-80")}
                            >
                              Finish early
                            </button>
                          </div>

                          <div className="mt-4">
                            <button
                              onClick={skipSteal}
                              className={`rounded-xl border px-3 py-2 text-sm mb-4 ${ui.darkMode ? 'border-slate-700 bg-slate-800 hover:bg-slate-700 text-slate-100' : 'border-slate-300 bg-white hover:bg-slate-50 text-slate-900'}`}
                            >
                              Skip steal
                            </button>
                          </div>

                          <div className="mt-3 space-y-3">
                            {draft.order.filter((tn) => {
                              const currentTeam = currentStealTeam();
                              if (tn === currentTeam) return false;
                              if (draft.stolenFrom[tn]) return false; // Already had someone stolen
                              if (draft.lastStolenBy[currentTeam] === tn) return false; // Can't steal back from team that just stole from you
                              return true;
                            }).map((targetTeam) => {
                              const stealablePlayers = (draft.picks[targetTeam] || []).filter(
                                (p) => p !== draft.captains[targetTeam]
                              );
                              if (stealablePlayers.length === 0) return null;
                              
                              return (
                                <div key={targetTeam} className={`rounded-xl border p-3 ${ui.darkMode ? 'border-slate-700 bg-slate-900' : 'border-slate-200 bg-slate-50'}`}>
                                  <div className="text-sm font-semibold mb-2">{targetTeam}</div>
                                  <div className="grid grid-cols-1 gap-2 sm:grid-cols-2">
                                    {stealablePlayers.map((p) => (
                                      <button
                                        key={p}
                                        onClick={() => stealPlayer(targetTeam, p)}
                                        className={`flex items-center justify-between rounded-lg border px-3 py-2 text-sm ${
                                          ui.darkMode ? 'border-slate-600 bg-slate-800 hover:bg-slate-700 text-slate-100' : 'border-slate-300 bg-white hover:bg-slate-50 text-slate-900'
                                        }`}
                                      >
                                        <span>{p}</span>
                                        <span className={`rounded px-2 py-1 text-xs font-semibold text-white ${ui.darkMode ? 'bg-red-900' : 'bg-red-700'}`}>Steal</span>
                                      </button>
                                    ))}
                                  </div>
                                </div>
                              );
                            })}
                          </div>

                          {draft.order.every((tn) => {
                            const currentTeam = currentStealTeam();
                            if (tn === currentTeam) return true;
                            if (draft.stolenFrom[tn]) return true; // Already had someone stolen
                            if (draft.lastStolenBy[currentTeam] === tn) return true; // Can't steal back
                            const stealablePlayers = (draft.picks[tn] || []).filter((p) => p !== draft.captains[tn]);
                            return stealablePlayers.length === 0;
                          }) && (
                            <div className={`mt-3 rounded-xl border p-3 text-sm ${ui.darkMode ? 'border-slate-700 bg-slate-900 text-slate-400' : 'border-slate-200 bg-slate-50 text-slate-600'}`}>
                              No players available to steal.
                            </div>
                          )}
                        </div>

                        <div className={`rounded-2xl border p-4 ${ui.darkMode ? 'border-slate-600 bg-slate-800' : 'border-slate-200 bg-white'}`}>
                          <div className="text-sm font-semibold">Teams</div>
                          <div className="mt-3 space-y-3">
                            {draft.order.map((tn) => (
                              <div key={tn} className={`rounded-xl border p-3 ${
                                tn === currentStealTeam() 
                                  ? ui.darkMode ? 'border-amber-600 bg-amber-900/20' : 'border-amber-400 bg-amber-50'
                                  : ui.darkMode ? 'border-slate-700 bg-slate-900' : 'border-slate-200 bg-slate-50'
                              }`}>
                                <div className="flex items-center justify-between">
                                  <div className="text-sm font-semibold">{tn}</div>
                                  {draft.stealsUsed[tn] && (
                                    <span className={`text-[10px] px-2 py-0.5 rounded-full ${ui.darkMode ? 'bg-slate-700 text-slate-400' : 'bg-slate-200 text-slate-600'}`}>
                                      Steal used
                                    </span>
                                  )}
                                </div>
                                <div className={`mt-1 text-xs ${ui.darkMode ? 'text-slate-400' : 'text-slate-600'}`}>Captain: {draft.captains[tn] || "?"}</div>
                                <div className="mt-2 text-sm">
                                  {(draft.picks[tn] || []).length ? (
                                    <ul className="list-disc pl-5">
                                      {(draft.picks[tn] || []).map((m, idx) => (
                                        <li key={idx} className={m === draft.captains[tn] ? 'font-semibold' : ''}>{m}</li>
                                      ))}
                                    </ul>
                                  ) : (
                                    <span className={`${ui.darkMode ? 'text-slate-500' : 'text-slate-400'}`}>No picks yet.</span>
                                  )}
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Summary */}
                    {draft.step === "summary" && (
                      <div className="mt-4">
                        <div className={`rounded-2xl border p-4 ${ui.darkMode ? 'border-slate-700 bg-slate-900' : 'border-slate-200 bg-slate-50'}`}>
                          <div className="text-sm font-semibold">Draft summary</div>
                          <div className="mt-3 grid grid-cols-1 gap-3 lg:grid-cols-2">
                            {draft.order.map((tn) => (
                              <div key={tn} className={`rounded-xl border p-3 ${ui.darkMode ? 'border-slate-700 bg-slate-800' : 'border-slate-300 bg-white'}`}>
                                <div className="text-sm font-semibold">{tn}</div>
                                <div className="mt-1 text-xs text-slate-600">Captain: {draft.captains[tn] || "?"}</div>
                                <div className="mt-2 text-sm">
                                  {(draft.picks[tn] || []).length ? (
                                    <ul className="list-disc pl-5">
                                      {(draft.picks[tn] || []).map((m, idx) => (
                                        <li key={idx}>{m}</li>
                                      ))}
                                    </ul>
                                  ) : (
                                    <span className={`${ui.darkMode ? 'text-slate-400' : 'text-slate-500'}`}>No members.</span>
                                  )}
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>

                        <div className="mt-4 flex flex-wrap gap-2">
                          <button
                            onClick={applyDraftToGame}
                            className={btnClass("primary", ui.darkMode)}
                          >
                            Apply to game
                          </button>
                          <button
                            onClick={() => setDraft((d) => ({ ...d, step: "setup" }))}
                            className={btnClass("secondary", ui.darkMode, "hover:opacity-80")}
                          >
                            Back to setup
                          </button>
                          <button
                            onClick={() => setUi((u) => ({ ...u, draftOpen: false }))}
                            className={btnClass("secondary", ui.darkMode, "hover:opacity-80")}
                          >
                            Close
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* Login Modal */}
              {ui.loginModalOpen && (
                <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/50 p-4">
                  <div className={`w-full max-w-md rounded-2xl border shadow-2xl max-h-[90vh] overflow-y-auto dark-scrollbar ${ui.darkMode ? 'border-slate-700 bg-slate-900' : 'border-slate-300 bg-white'}`}>
                    <div className={`border-b px-6 py-4 ${ui.darkMode ? 'border-slate-700' : 'border-slate-200'}`}>
                      <h2 className="text-lg font-bold">Login</h2>
                    </div>
                    <div className="space-y-4 px-6 py-4">
                      {!ui.loginAsAdmin ? (
                        <>
                          <div>
                            <label className="block text-sm font-semibold mb-2">Login as Team:</label>
                            <select
                              value={ui.loginAsTeam ?? ''}
                              onChange={(e) => setUi((u) => ({ ...u, loginAsTeam: e.target.value || null }))}
                              className={`w-full rounded-lg border px-3 py-2 ${ui.darkMode ? 'border-slate-600 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900'}`}
                            >
                              <option value="">Select a team...</option>
                              {(game.teams || []).map((t) => (
                                <option key={t.id} value={t.id}>{t.name}</option>
                              ))}
                            </select>
                          </div>
                          <div>
                            <label className="block text-sm font-semibold mb-2">Password:</label>
                            <input
                              type="password"
                              value={ui.loginPassword ?? ''}
                              onChange={(e) => setUi((u) => ({ ...u, loginPassword: e.target.value }))}
                              onKeyDown={(e) => {
                                if (e.key === 'Enter' && ui.loginAsTeam) {
                                  const success = attemptLogin(ui.loginPassword || '', ui.loginAsTeam, false);
                                  if (success) {
                                    setUi((u) => ({ ...u, loginModalOpen: false, loginPassword: '', loginAsTeam: null }));
                                  } else {
                                    alert('Incorrect password.');
                                  }
                                }
                              }}
                              placeholder={ui.loginAsTeam ? "Enter team password" : "Select a team first"}
                              disabled={!ui.loginAsTeam}
                              className={`w-full rounded-lg border px-3 py-2 ${ui.darkMode ? 'border-slate-600 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900'} ${!ui.loginAsTeam ? 'opacity-50 cursor-not-allowed' : ''}`}
                            />
                            {ui.loginAsTeam && (
                              <div className={`mt-1 text-xs ${ui.darkMode ? 'text-slate-400' : 'text-slate-500'}`}>
                                {game.teams.find(t => t.id === ui.loginAsTeam)?.password ? 
                                  "Password required" : "No password set - leave blank"}
                              </div>
                            )}
                          </div>
                          <div className="text-center pt-2">
                            <button
                              onClick={() => setUi((u) => ({ ...u, loginAsAdmin: true, loginAsTeam: null, loginPassword: '', loginSelectedAdmin: null }))}
                              className={`text-sm hover:underline ${ui.darkMode ? 'text-blue-400' : 'text-blue-600'}`}
                            >
                              or login as admin
                            </button>
                          </div>
                        </>
                      ) : (
                        <>
                          <div>
                            <label className="block text-sm font-semibold mb-2">Login as Admin:</label>
                            <select
                              value={ui.loginSelectedAdmin ?? ''}
                              onChange={(e) => setUi((u) => ({ ...u, loginSelectedAdmin: e.target.value || null }))}
                              className={`w-full rounded-lg border px-3 py-2 ${ui.darkMode ? 'border-slate-600 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900'}`}
                            >
                              <option value="">Select an admin...</option>
                              {(game.admins || []).map((admin) => (
                                <option key={`admin-${admin.id}`} value={admin.id}>{admin.name}</option>
                              ))}
                            </select>
                          </div>
                          <div>
                            <label className="block text-sm font-semibold mb-2">Password:</label>
                            <input
                              type="password"
                              value={ui.loginPassword ?? ''}
                              onChange={(e) => setUi((u) => ({ ...u, loginPassword: e.target.value }))}
                              onKeyDown={(e) => {
                                if (e.key === 'Enter' && ui.loginSelectedAdmin) {
                                  const admin = game.admins.find(a => a.id === ui.loginSelectedAdmin);
                                  if (admin && admin.password === ui.loginPassword) {
                                    setAuth({ loggedInAs: null, isAdmin: true, adminId: admin.id, adminName: admin.name });
                                    setUi((u) => ({ ...u, loginModalOpen: false, loginPassword: '', loginAsAdmin: false, loginSelectedAdmin: null }));
                                  } else {
                                    alert('Incorrect password.');
                                  }
                                }
                              }}
                              placeholder={ui.loginSelectedAdmin ? "Enter admin password" : "Select an admin first"}
                              disabled={!ui.loginSelectedAdmin}
                              className={`w-full rounded-lg border px-3 py-2 ${ui.darkMode ? 'border-slate-600 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900'} ${!ui.loginSelectedAdmin ? 'opacity-50 cursor-not-allowed' : ''}`}
                            />
                          </div>
                          <div className="text-center pt-2">
                            <button
                              onClick={() => setUi((u) => ({ ...u, loginAsAdmin: false, loginSelectedAdmin: null, loginPassword: '' }))}
                              className={`text-sm hover:underline ${ui.darkMode ? 'text-blue-400' : 'text-blue-600'}`}
                            >
                              or login as team
                            </button>
                          </div>
                        </>
                      )}
                    </div>
                    <div className={`flex gap-2 border-t px-6 py-4 ${ui.darkMode ? 'border-slate-700' : 'border-slate-200'}`}>
                      <button
                        onClick={() => {
                          if (ui.loginAsAdmin) {
                            const admin = game.admins.find(a => a.id === ui.loginSelectedAdmin);
                            if (admin && admin.password === ui.loginPassword) {
                              setAuth({ loggedInAs: null, isAdmin: true, adminId: admin.id, adminName: admin.name });
                              setUi((u) => ({ ...u, loginModalOpen: false, loginPassword: '', loginAsAdmin: false, loginSelectedAdmin: null }));
                            } else {
                              alert('Incorrect password.');
                            }
                          } else {
                            if (!ui.loginAsTeam) {
                              alert('Please select a team.');
                              return;
                            }
                            const success = attemptLogin(ui.loginPassword || '', ui.loginAsTeam, false);
                            if (success) {
                              setUi((u) => ({ ...u, loginModalOpen: false, loginPassword: '', loginAsTeam: null }));
                            } else {
                              alert('Incorrect password.');
                            }
                          }
                        }}
                        className={`flex-1 rounded-xl border px-4 py-2 text-sm font-semibold shadow-sm hover:opacity-80 ${
                          ui.darkMode ? 'border-green-700 bg-green-800 text-green-100' : 'border-green-600 bg-green-600 text-white'
                        }`}
                      >
                        Login
                      </button>
                      <button
                        onClick={() => setUi((u) => ({ ...u, loginModalOpen: false, loginPassword: '', loginAsTeam: null, loginAsAdmin: false, loginSelectedAdmin: null }))}
                        className={`rounded-xl border px-4 py-2 text-sm hover:opacity-80 ${
                          ui.darkMode ? 'border-slate-700 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900 hover:bg-slate-100'
                        }`}
                      >
                        Cancel
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Password Setup Modal - Teams Only */}
              {ui.passwordSetupOpen && (
                <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/50 p-4">
                  <div className={`w-full max-w-2xl rounded-2xl border shadow-2xl max-h-[90vh] overflow-y-auto dark-scrollbar ${ui.darkMode ? 'border-slate-700 bg-slate-900' : 'border-slate-300 bg-white'}`}>
                    <div className={`border-b px-6 py-4 ${ui.darkMode ? 'border-slate-700' : 'border-slate-200'}`}>
                      <h2 className="text-lg font-bold">Team Password Setup</h2>
                      <div className={`mt-1 text-sm ${ui.darkMode ? 'text-slate-400' : 'text-slate-600'}`}>
                        Set passwords for teams. Leave blank for no password.
                      </div>
                    </div>
                    <div className="space-y-4 px-6 py-4">
                        {(game.teams || []).map((team) => (
                          <div key={team.id} className={`rounded-xl border p-4 ${ui.darkMode ? 'border-slate-700 bg-slate-800' : 'border-slate-200 bg-slate-50'}`}>
                            <label className="block text-sm font-semibold mb-2">{team.name}:</label>
                            {ui[`editingTeamPassword_${team.id}`] ? (
                              <div className="flex gap-2">
                                <input
                                  type="text"
                                  value={ui[`tempTeamPassword_${team.id}`] ?? team.password}
                                  onChange={(e) => setUi((u) => ({ ...u, [`tempTeamPassword_${team.id}`]: e.target.value }))}
                                  placeholder="Leave blank for no password"
                                  className={`flex-1 rounded-lg border px-3 py-2 ${ui.darkMode ? 'border-slate-600 bg-slate-900 text-slate-100' : 'border-slate-300 bg-white text-slate-900'}`}
                                  autoFocus
                                />
                                <button
                                  onClick={() => {
                                    const pwd = ui[`tempTeamPassword_${team.id}`] ?? team.password;
                                    dispatch({ type: "ADMIN_SET_TEAM_PASSWORD", teamId: team.id, password: pwd, adminName: auth.adminName });
                                    setUi((u) => {
                                      const newUi = { ...u };
                                      delete newUi[`tempTeamPassword_${team.id}`];
                                      delete newUi[`editingTeamPassword_${team.id}`];
                                      return newUi;
                                    });
                                  }}
                                  className={`rounded-lg px-4 py-2 text-sm font-semibold shadow-sm hover:opacity-80 ${
                                    ui.darkMode ? 'border border-green-700 bg-green-800 text-green-100' : 'border border-green-600 bg-green-600 text-white'
                                  }`}
                                >
                                  Set
                                </button>
                                <button
                                  onClick={() => {
                                    setUi((u) => {
                                      const newUi = { ...u };
                                      delete newUi[`tempTeamPassword_${team.id}`];
                                      delete newUi[`editingTeamPassword_${team.id}`];
                                      return newUi;
                                    });
                                  }}
                                  className={`rounded-lg px-4 py-2 text-sm hover:opacity-80 ${
                                    ui.darkMode ? 'border border-slate-700 bg-slate-800 text-slate-100' : 'border border-slate-300 bg-white text-slate-900'
                                  }`}
                                >
                                  Cancel
                                </button>
                              </div>
                            ) : (
                              <button
                                onClick={() => {
                                  // Close all other editing states first
                                  setUi((u) => {
                                    const newUi = { ...u };
                                    // Clear all team password editing states
                                    Object.keys(newUi).forEach(key => {
                                      if (key.startsWith('editingTeamPassword_') || key.startsWith('tempTeamPassword_')) {
                                        delete newUi[key];
                                      }
                                    });
                                    // Open only this one
                                    newUi[`editingTeamPassword_${team.id}`] = true;
                                    newUi[`tempTeamPassword_${team.id}`] = team.password;
                                    return newUi;
                                  });
                                }}
                                className={`rounded-lg border px-4 py-2 text-sm font-semibold shadow-sm hover:opacity-80 ${
                                  ui.darkMode ? 'border-slate-700 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900'
                                }`}
                              >
                                {team.password ? '?? Change Password' : '?? Set Password'}
                              </button>
                            )}
                          </div>
                        ))}
                    </div>
                    <div className={`flex gap-2 border-t px-6 py-4 ${ui.darkMode ? 'border-slate-700' : 'border-slate-200'}`}>
                      <button
                        onClick={() => {
                          // Clear temp values and close
                          const clearedUi = { ...ui, passwordSetupOpen: false };
                          game.teams.forEach((team) => {
                            delete clearedUi[`tempTeamPassword_${team.id}`];
                            delete clearedUi[`editingTeamPassword_${team.id}`];
                          });
                          setUi(clearedUi);
                        }}
                        className={`flex-1 rounded-xl border px-4 py-2 text-sm hover:opacity-80 ${
                          ui.darkMode ? 'border-slate-700 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900 hover:bg-slate-100'
                        }`}
                      >
                        Close
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Change My Password Modal */}
              {ui.changeMyPasswordOpen && (
                <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/50 p-4">
                  <div className={`w-full max-w-md rounded-2xl border shadow-2xl ${ui.darkMode ? 'border-slate-700 bg-slate-900' : 'border-slate-300 bg-white'}`}>
                    <div className={`border-b px-6 py-4 ${ui.darkMode ? 'border-slate-700' : 'border-slate-200'}`}>
                      <h2 className="text-lg font-bold">Change Password</h2>
                      <div className={`mt-1 text-sm ${ui.darkMode ? 'text-slate-400' : 'text-slate-600'}`}>
                        Change password for {auth.adminName}
                      </div>
                    </div>
                    <div className="space-y-4 px-6 py-4">
                      <div>
                        <label className="block text-sm font-semibold mb-2">Current Password:</label>
                        <input
                          type="password"
                          value={ui.currentPassword || ''}
                          onChange={(e) => setUi((u) => ({ ...u, currentPassword: e.target.value }))}
                          placeholder="Enter current password"
                          className={`w-full rounded-lg border px-3 py-2 text-sm ${ui.darkMode ? 'border-slate-600 bg-slate-900 text-slate-100' : 'border-slate-300 bg-white text-slate-900'}`}
                          autoFocus
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-semibold mb-2">New Password:</label>
                        <input
                          type="password"
                          value={ui.newPassword || ''}
                          onChange={(e) => setUi((u) => ({ ...u, newPassword: e.target.value }))}
                          placeholder="Enter new password"
                          className={`w-full rounded-lg border px-3 py-2 text-sm ${ui.darkMode ? 'border-slate-600 bg-slate-900 text-slate-100' : 'border-slate-300 bg-white text-slate-900'}`}
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-semibold mb-2">Confirm New Password:</label>
                        <input
                          type="password"
                          value={ui.confirmPassword || ''}
                          onChange={(e) => setUi((u) => ({ ...u, confirmPassword: e.target.value }))}
                          placeholder="Confirm new password"
                          className={`w-full rounded-lg border px-3 py-2 text-sm ${ui.darkMode ? 'border-slate-600 bg-slate-900 text-slate-100' : 'border-slate-300 bg-white text-slate-900'}`}
                        />
                      </div>
                    </div>
                    <div className={`flex gap-2 border-t px-6 py-4 ${ui.darkMode ? 'border-slate-700' : 'border-slate-200'}`}>
                      <button
                        onClick={() => {
                          setUi((u) => ({ ...u, changeMyPasswordOpen: false, currentPassword: '', newPassword: '', confirmPassword: '' }));
                        }}
                        className={`flex-1 rounded-xl border px-4 py-2 text-sm hover:opacity-80 ${
                          ui.darkMode ? 'border-slate-700 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900 hover:bg-slate-100'
                        }`}
                      >
                        Cancel
                      </button>
                      <button
                        onClick={() => {
                          if (!ui.currentPassword || !ui.newPassword || !ui.confirmPassword) {
                            alert('Please fill in all fields');
                            return;
                          }
                          if (ui.newPassword !== ui.confirmPassword) {
                            alert('New passwords do not match');
                            return;
                          }
                          const currentAdmin = game.admins.find(a => a.id === auth.adminId);
                          if (!currentAdmin || currentAdmin.password !== ui.currentPassword) {
                            alert('Current password is incorrect');
                            return;
                          }
                          dispatch({ 
                            type: "ADMIN_CHANGE_ADMIN_PASSWORD", 
                            adminId: auth.adminId, 
                            password: ui.newPassword,
                            adminName: auth.adminName
                          });
                          setUi((u) => ({ ...u, changeMyPasswordOpen: false, currentPassword: '', newPassword: '', confirmPassword: '' }));
                          alert('Password changed successfully!');
                        }}
                        className={`flex-1 rounded-xl px-4 py-2 text-sm font-semibold shadow-sm hover:opacity-80 ${
                          ui.darkMode ? 'border border-green-700 bg-green-800 text-green-100' : 'border border-green-600 bg-green-600 text-white'
                        }`}
                      >
                        Change Password
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Admin Management Modal */}
              {ui.adminManagementOpen && (
                <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/50 p-4">
                  <div className={`w-full max-w-2xl rounded-2xl border shadow-2xl max-h-[90vh] overflow-y-auto dark-scrollbar ${ui.darkMode ? 'border-slate-700 bg-slate-900' : 'border-slate-300 bg-white'}`}>
                    <div className={`border-b px-6 py-4 ${ui.darkMode ? 'border-slate-700' : 'border-slate-200'}`}>
                      <h2 className="text-lg font-bold">Admin Management</h2>
                      <div className={`mt-1 text-sm ${ui.darkMode ? 'text-slate-400' : 'text-slate-600'}`}>
                        Manage administrator accounts
                      </div>
                    </div>
                    <div className="space-y-4 px-6 py-4">
                      {checkMasterAdmin() && (
                        <div className={`rounded-xl border p-4 ${ui.darkMode ? 'border-slate-700 bg-slate-800' : 'border-slate-200 bg-slate-50'}`}>
                          <div className="text-sm font-semibold mb-3">Create New Admin</div>
                          <div className="space-y-3">
                            <div>
                              <label className={`text-xs ${textMuted(ui.darkMode)}`}>Admin Name</label>
                              <input
                                type="text"
                                value={ui.newAdminName || ''}
                                onChange={(e) => setUi((u) => ({ ...u, newAdminName: e.target.value }))}
                                placeholder="Enter admin name"
                                className={`mt-1 w-full rounded-lg border px-3 py-2 ${ui.darkMode ? 'border-slate-600 bg-slate-900 text-slate-100' : 'border-slate-300 bg-white text-slate-900'}`}
                              />
                            </div>
                            <div>
                              <label className={`text-xs ${textMuted(ui.darkMode)}`}>Password</label>
                              <input
                                type="text"
                                value={ui.newAdminPassword || ''}
                                onChange={(e) => setUi((u) => ({ ...u, newAdminPassword: e.target.value }))}
                                placeholder="Enter password"
                                className={`mt-1 w-full rounded-lg border px-3 py-2 ${ui.darkMode ? 'border-slate-600 bg-slate-900 text-slate-100' : 'border-slate-300 bg-white text-slate-900'}`}
                              />
                            </div>
                            <button
                              onClick={() => {
                                if (!ui.newAdminName || !ui.newAdminPassword) {
                                  alert('Please enter both name and password');
                                  return;
                                }
                                dispatch({ 
                                  type: "ADMIN_CREATE_ADMIN", 
                                  name: ui.newAdminName, 
                                  password: ui.newAdminPassword,
                                  adminName: auth.adminName
                                });
                                setUi((u) => ({ ...u, newAdminName: '', newAdminPassword: '' }));
                              }}
                              className={`w-full rounded-lg px-4 py-2 text-sm font-semibold shadow-sm hover:opacity-80 ${
                                ui.darkMode ? 'border border-green-700 bg-green-800 text-green-100' : 'border border-green-600 bg-green-600 text-white'
                              }`}
                            >
                              Create Admin
                            </button>
                          </div>
                        </div>
                      )}

                      <div className="space-y-3">
                        <div className="text-sm font-semibold">Existing Admins</div>
                        {(game.admins || []).map((admin) => (
                          <div key={admin.id} className={`rounded-xl border p-4 ${ui.darkMode ? 'border-slate-700 bg-slate-800' : 'border-slate-200 bg-slate-50'}`}>
                            <div className="flex items-center justify-between">
                              <div>
                                <div className="text-sm font-semibold">
                                  {admin.name} {admin.isMaster && '(Master)'}
                                </div>
                                <div className={`text-xs ${textMuted(ui.darkMode)}`}>
                                  Password: {admin.password}
                                </div>
                              </div>
                              <div className="flex gap-2">
                                {admin.id === auth.adminId && !admin.isMaster && (
                                  <button
                                    onClick={() => setUi((u) => ({ ...u, [`editingAdminPassword_${admin.id}`]: true, [`tempAdminPassword_${admin.id}`]: admin.password }))}
                                    className={`rounded-lg border px-3 py-2 text-xs font-semibold shadow-sm hover:opacity-80 ${
                                      ui.darkMode ? 'border-slate-700 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900'
                                    }`}
                                  >
                                    Change Password
                                  </button>
                                )}
                                {checkMasterAdmin() && !admin.isMaster && (
                                  <button
                                    onClick={() => {
                                      if (confirm(`Delete admin ${admin.name}?`)) {
                                        dispatch({ type: "ADMIN_DELETE_ADMIN", adminId: admin.id, adminName: auth.adminName });
                                      }
                                    }}
                                    className={`rounded-lg border px-3 py-2 text-xs hover:opacity-80 ${
                                      ui.darkMode ? 'border-red-700 bg-red-900 text-red-100' : 'border-red-600 bg-red-600 text-white'
                                    }`}
                                  >
                                    Delete
                                  </button>
                                )}
                              </div>
                            </div>
                            {ui[`editingAdminPassword_${admin.id}`] && (
                              <div className="mt-3 flex gap-2">
                                <input
                                  type="text"
                                  value={ui[`tempAdminPassword_${admin.id}`] || ''}
                                  onChange={(e) => setUi((u) => ({ ...u, [`tempAdminPassword_${admin.id}`]: e.target.value }))}
                                  placeholder="New password"
                                  className={`flex-1 rounded-lg border px-3 py-2 text-sm ${ui.darkMode ? 'border-slate-600 bg-slate-900 text-slate-100' : 'border-slate-300 bg-white text-slate-900'}`}
                                  autoFocus
                                />
                                <button
                                  onClick={() => {
                                    dispatch({ 
                                      type: "ADMIN_CHANGE_ADMIN_PASSWORD", 
                                      adminId: admin.id, 
                                      password: ui[`tempAdminPassword_${admin.id}`],
                                      adminName: auth.adminName
                                    });
                                    setUi((u) => {
                                      const newUi = { ...u };
                                      delete newUi[`tempAdminPassword_${admin.id}`];
                                      delete newUi[`editingAdminPassword_${admin.id}`];
                                      return newUi;
                                    });
                                  }}
                                  className={`rounded-lg px-4 py-2 text-sm font-semibold shadow-sm hover:opacity-80 ${
                                    ui.darkMode ? 'border border-green-700 bg-green-800 text-green-100' : 'border border-green-600 bg-green-600 text-white'
                                  }`}
                                >
                                  Set
                                </button>
                                <button
                                  onClick={() => {
                                    setUi((u) => {
                                      const newUi = { ...u };
                                      delete newUi[`tempAdminPassword_${admin.id}`];
                                      delete newUi[`editingAdminPassword_${admin.id}`];
                                      return newUi;
                                    });
                                  }}
                                  className={`rounded-lg px-4 py-2 text-sm hover:opacity-80 ${
                                    ui.darkMode ? 'border border-slate-700 bg-slate-800 text-slate-100' : 'border border-slate-300 bg-white text-slate-900'
                                  }`}
                                >
                                  Cancel
                                </button>
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                    <div className={`flex gap-2 border-t px-6 py-4 ${ui.darkMode ? 'border-slate-700' : 'border-slate-200'}`}>
                      <button
                        onClick={() => setUi((u) => ({ ...u, adminManagementOpen: false }))}
                        className={`flex-1 rounded-xl border px-4 py-2 text-sm hover:opacity-80 ${
                          ui.darkMode ? 'border-slate-700 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900 hover:bg-slate-100'
                        }`}
                      >
                        Close
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Gradient Settings Modal */}
              {ui.gradientSettingsOpen && (
                <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/50 p-4">
                  <div className={`w-full max-w-3xl rounded-2xl border shadow-2xl max-h-[90vh] overflow-y-auto dark-scrollbar ${ui.darkMode ? 'border-slate-700 bg-slate-900' : 'border-slate-300 bg-white'}`}>
                    <div className={`border-b px-6 py-4 ${ui.darkMode ? 'border-slate-700' : 'border-slate-200'}`}>
                      <h2 className="text-lg font-bold">Gradient Settings</h2>
                      <div className={`mt-1 text-sm ${ui.darkMode ? 'text-slate-400' : 'text-slate-600'}`}>
                        Configure difficulty distribution across the board
                      </div>
                    </div>
                    <div className="space-y-4 px-6 py-4">
                      <div className={`rounded-xl border p-4 ${ui.darkMode ? 'border-slate-700 bg-slate-800' : 'border-slate-200 bg-slate-50'}`}>
                        <label className="flex items-center gap-2 text-sm font-semibold mb-4">
                          <input 
                            type="checkbox" 
                            checked={ui.gradientEnabled} 
                            onChange={(e) => setUi((u) => ({ ...u, gradientEnabled: e.target.checked }))} 
                            className="w-4 h-4"
                          />
                          <span>Enable Gradient Mode</span>
                        </label>
                        
                        {ui.gradientEnabled ? (
                          <div className="space-y-4">
                            <div className={`rounded-lg border p-4 ${ui.darkMode ? 'border-slate-600 bg-slate-900' : 'border-slate-300 bg-white'}`}>
                              <div className="text-sm font-semibold mb-3">Early Tiles (Start of board)</div>
                              <div className="grid grid-cols-3 gap-3">
                                <div>
                                  <label className={`text-xs ${textMuted(ui.darkMode)}`}>Easy</label>
                                  <input 
                                    type="number" 
                                    min="0" 
                                    value={ui.earlyEasy} 
                                    onChange={(e) => setUi((u) => ({ ...u, earlyEasy: Number(e.target.value) }))} 
                                    className={`mt-1 w-full rounded border px-3 py-2 ${ui.darkMode ? 'border-slate-600 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900'}`} 
                                  />
                                </div>
                                <div>
                                  <label className={`text-xs ${textMuted(ui.darkMode)}`}>Medium</label>
                                  <input 
                                    type="number" 
                                    min="0" 
                                    value={ui.earlyMedium} 
                                    onChange={(e) => setUi((u) => ({ ...u, earlyMedium: Number(e.target.value) }))} 
                                    className={`mt-1 w-full rounded border px-3 py-2 ${ui.darkMode ? 'border-slate-600 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900'}`} 
                                  />
                                </div>
                                <div>
                                  <label className={`text-xs ${textMuted(ui.darkMode)}`}>Hard</label>
                                  <input 
                                    type="number" 
                                    min="0" 
                                    value={ui.earlyHard} 
                                    onChange={(e) => setUi((u) => ({ ...u, earlyHard: Number(e.target.value) }))} 
                                    className={`mt-1 w-full rounded border px-3 py-2 ${ui.darkMode ? 'border-slate-600 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900'}`} 
                                  />
                                </div>
                              </div>
                            </div>

                            <div className={`rounded-lg border p-4 ${ui.darkMode ? 'border-slate-600 bg-slate-900' : 'border-slate-300 bg-white'}`}>
                              <div className="text-sm font-semibold mb-3">Late Tiles (End of board)</div>
                              <div className="grid grid-cols-3 gap-3">
                                <div>
                                  <label className={`text-xs ${textMuted(ui.darkMode)}`}>Easy</label>
                                  <input 
                                    type="number" 
                                    min="0" 
                                    value={ui.lateEasy} 
                                    onChange={(e) => setUi((u) => ({ ...u, lateEasy: Number(e.target.value) }))} 
                                    className={`mt-1 w-full rounded border px-3 py-2 ${ui.darkMode ? 'border-slate-600 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900'}`} 
                                  />
                                </div>
                                <div>
                                  <label className={`text-xs ${textMuted(ui.darkMode)}`}>Medium</label>
                                  <input 
                                    type="number" 
                                    min="0" 
                                    value={ui.lateMedium} 
                                    onChange={(e) => setUi((u) => ({ ...u, lateMedium: Number(e.target.value) }))} 
                                    className={`mt-1 w-full rounded border px-3 py-2 ${ui.darkMode ? 'border-slate-600 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900'}`} 
                                  />
                                </div>
                                <div>
                                  <label className={`text-xs ${textMuted(ui.darkMode)}`}>Hard</label>
                                  <input 
                                    type="number" 
                                    min="0" 
                                    value={ui.lateHard} 
                                    onChange={(e) => setUi((u) => ({ ...u, lateHard: Number(e.target.value) }))} 
                                    className={`mt-1 w-full rounded border px-3 py-2 ${ui.darkMode ? 'border-slate-600 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900'}`} 
                                  />
                                </div>
                              </div>
                            </div>
                          </div>
                        ) : (
                          <div className={`rounded-lg border p-4 ${ui.darkMode ? 'border-slate-600 bg-slate-900' : 'border-slate-300 bg-white'}`}>
                            <div className="text-sm font-semibold mb-3">Global Weights</div>
                            <div className="grid grid-cols-3 gap-3">
                              <div>
                                <label className={`text-xs ${textMuted(ui.darkMode)}`}>Easy</label>
                                <input 
                                  type="number" 
                                  min="0" 
                                  value={ui.weightEasy} 
                                  onChange={(e) => setUi((u) => ({ ...u, weightEasy: Number(e.target.value) }))} 
                                  className={`mt-1 w-full rounded border px-3 py-2 ${ui.darkMode ? 'border-slate-600 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900'}`} 
                                />
                              </div>
                              <div>
                                <label className={`text-xs ${textMuted(ui.darkMode)}`}>Medium</label>
                                <input 
                                  type="number" 
                                  min="0" 
                                  value={ui.weightMedium} 
                                  onChange={(e) => setUi((u) => ({ ...u, weightMedium: Number(e.target.value) }))} 
                                  className={`mt-1 w-full rounded border px-3 py-2 ${ui.darkMode ? 'border-slate-600 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900'}`} 
                                />
                              </div>
                              <div>
                                <label className={`text-xs ${textMuted(ui.darkMode)}`}>Hard</label>
                                <input 
                                  type="number" 
                                  min="0" 
                                  value={ui.weightHard} 
                                  onChange={(e) => setUi((u) => ({ ...u, weightHard: Number(e.target.value) }))} 
                                  className={`mt-1 w-full rounded border px-3 py-2 ${ui.darkMode ? 'border-slate-600 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900'}`} 
                                />
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                    <div className={`flex gap-2 border-t px-6 py-4 ${ui.darkMode ? 'border-slate-700' : 'border-slate-200'}`}>
                      <button
                        onClick={() => setUi((u) => ({ ...u, gradientSettingsOpen: false }))}
                        className={`flex-1 rounded-xl border px-4 py-2 text-sm hover:opacity-80 ${
                          ui.darkMode ? 'border-slate-700 bg-slate-800 text-slate-100' : 'border-slate-300 bg-white text-slate-900 hover:bg-slate-100'
                        }`}
                      >
                        Close
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>












